<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>FOBE Scheduler (local)</title>
<link rel='icon' type='image/svg+xml' href='/static/brand/favicon.svg'>
<link rel='stylesheet' href='/static/css/tokens.css'>
<link rel='stylesheet' href='/static/css/components.css'>
<link rel='stylesheet' href='/static/css/layout.css'>
<style>
  body { color:var(--text-strong); }
  .card { padding:var(--space-4); margin-bottom:var(--space-4); }
  .status-banner { min-height:1.5rem; margin-bottom:var(--space-4); padding:0 var(--space-2); font-size:var(--text-sm); }
  .workspace-shell { display:grid; grid-template-columns: 190px minmax(0, 1fr); gap:var(--space-4); align-items:start; }
  .workspace-nav { position:sticky; top:var(--space-4); padding:var(--space-3); background:linear-gradient(165deg, rgba(189,205,195,.45), rgba(255,255,255,.95)); }
  .workspace-nav h3 { margin:0 0 .35rem; font-size:1.15rem; }
  .nav-caption { margin:0 0 var(--space-3); color:var(--text-muted); font-size:var(--text-xs); text-transform:uppercase; letter-spacing:.08em; }
  .nav-links { display:grid; gap:.4rem; }
  .nav-link { display:block; padding:.5rem .65rem; border-radius:var(--radius-sm); border:1px solid transparent; text-decoration:none; color:var(--brand-deep-water); font-size:var(--text-sm); font-weight:600; }
  .nav-link:hover { background:rgba(245,179,53,.16); border-color:rgba(180,127,0,.25); color:var(--brand-jack-pine); }
  .workspace-main { min-width:0; }
  .section-card { overflow:hidden; }
  .section-heading { display:flex; justify-content:space-between; align-items:flex-start; gap:var(--space-3); margin-bottom:var(--space-4); }
  .section-heading.compact { margin-bottom:var(--space-3); }
  .section-title { margin:0; font-size:1.6rem; line-height:1.1; }
  .section-description { margin:.2rem 0 0; color:var(--text-muted); font-size:var(--text-sm); }
  .section-title-loose { margin:0 0 1rem; }
  .muted { color:var(--text-muted); font-size:.9rem; }
  table { width:100%; border-collapse: collapse; }
  th, td { border:1px solid var(--border-subtle); padding:.52rem .5rem; text-align:center; vertical-align:top; }
  th { background:var(--surface-3); color:var(--brand-jack-pine); }
  .table-wrap { overflow:auto; border:1px solid var(--border-subtle); border-radius:var(--radius-md); }
  .table-wrap table { border:0; min-width:760px; }
  .table-wrap th:first-child, .table-wrap td:first-child { border-left:0; }
  .table-wrap th:last-child, .table-wrap td:last-child { border-right:0; }
  .schedule-table { width:100%; min-width:0 !important; table-layout:fixed; }
  .schedule-table th, .schedule-table td { min-width:0; }
  .schedule-table .dropzone {
    flex-wrap: wrap;
    justify-content: flex-start;
    align-items: flex-start;
    overflow: visible;
    gap: .3rem;
    padding: .2rem .2rem;
  }
  .schedule-table .dropzone > * { flex: 0 0 auto; max-width: 100%; }
  .schedule-table .pill { white-space: nowrap; flex: 0 0 auto; }
  .schedule-table .zone-add { min-width: 28px; min-height: 28px; line-height: 1; padding: .12rem .4rem; border-radius: 8px; flex: 0 0 auto; }
  .schedule-table .zone-add-row { width: auto; margin-top: 0; display: inline-flex; align-items: center; }
  .schedule-table .zone-add-select { width: auto; min-width: 132px; max-width: 100%; }
  input, select, button { padding:.4rem .5rem; }
  input[type='checkbox'] { accent-color: var(--brand-jack-pine); }
  .toolbar { display:flex; flex-wrap:wrap; gap:.55rem; margin-bottom:var(--space-3); align-items:center; }
  .toolbar label { display:flex; align-items:center; gap:.45rem; padding:.45rem .55rem; border:1px solid var(--border-subtle); border-radius:var(--radius-sm); background:var(--surface-2); }
  .toolbar label input, .toolbar label select { background:#fff; }
  .control-note { margin:0 0 .4rem; }
  .open-day-chip { display:flex; align-items:center; gap:.4rem; padding:.45rem .6rem; border:1px solid var(--border-subtle); border-radius:999px; background:rgba(189,205,195,.16); }
  .open-day-chip input { margin:0; }
  .open-day-chip:has(input:checked),
  .open-day-chip.is-selected { border-color:rgba(89,97,29,.42); background:rgba(89,97,29,.2); color:var(--brand-jack-pine); font-weight:700; }
  .dropzone { min-height:58px; display:flex; flex-wrap:wrap; gap:.35rem; justify-content:center; align-content:flex-start; position:relative; padding-top:.2rem; border-radius: var(--radius-sm); transition: background var(--dur-fast) var(--ease-standard); }
  .dropzone:hover { background: rgba(189, 205, 195, 0.2); }
  .pill { background:rgba(104, 162, 185, 0.18); border:1px solid #75a9bc; border-radius:999px; padding:.2rem .5rem; cursor:grab; user-select:none; display:inline-flex; align-items:center; gap:.3rem; line-height:1.2; }
  .pill .pill-remove { width:16px; height:16px; border-radius:3px; padding:0; display:inline-flex; align-items:center; justify-content:center; font-size:13px; line-height:1; border-color: rgba(36,55,70,0.35); background: rgba(36,55,70,0.12); color: var(--brand-deep-water); }
  .zone-add-row { width:100%; display:flex; justify-content:center; margin-top:.1rem; }
  .zone-add-select { width:92%; font-size:.8rem; padding:.2rem .35rem; }
  .week-title { margin:.2rem 0 .6rem; }
  .weekday-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:.5rem .8rem; margin-top:.5rem; }
  .priority-list { list-style:none; margin:0; padding:0; display:grid; gap:.65rem; }
  .priority-item { display:flex; align-items:flex-start; gap:.7rem; border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:.65rem .75rem; background:var(--surface-2); }
  .priority-pill { min-width:74px; text-align:center; font-size:var(--text-xs); font-weight:800; letter-spacing:.06em; text-transform:uppercase; border-radius:999px; padding:.18rem .5rem; }
  .priority-pill.a { background:rgba(89,97,29,.22); color:var(--brand-jack-pine); }
  .priority-pill.b { background:rgba(104,162,185,.22); color:var(--brand-deep-water); }
  .priority-pill.c { background:rgba(217,199,158,.42); color:var(--brand-charcoal); }
  .action-row { display:flex; justify-content:space-between; align-items:center; gap:var(--space-3); margin-bottom:var(--space-3); flex-wrap:wrap; }
  .action-row p { margin:0; }
  .dropzone.dropzone--active { background:rgba(245,179,53,.16); }
  .dropzone.dropzone--valid { box-shadow: inset 0 0 0 2px rgba(89,97,29,.55); background:rgba(89,97,29,.12); }
  .dropzone.dropzone--invalid { box-shadow: inset 0 0 0 2px rgba(187,75,39,.58); background:rgba(187,75,39,.1); }
  .pill.pill--dragging { opacity:.45; transform:scale(.98); }
  #result { overflow:auto; }
  #history details { border:1px solid var(--border-subtle); border-radius:var(--radius-md); margin-bottom:var(--space-3); padding:var(--space-3); background:var(--surface-2); }
  #history summary { cursor:pointer; font-weight:700; color:var(--brand-jack-pine); }
  #history button { margin-top:var(--space-3); }
  .status-banner[data-tone='warn'] { color:#8a3f1a; }
  .status-banner[data-tone='danger'] { color:#7a2e18; }
  .status-banner[data-tone='success'] { color:var(--brand-hypnum-moss); }
  .ui-toast {
    position: fixed;
    right: var(--space-4);
    bottom: var(--space-4);
    z-index: 70;
    max-width: min(380px, calc(100vw - 2rem));
    padding: .65rem .85rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-subtle);
    background: #fff;
    color: var(--text-strong);
    box-shadow: var(--shadow-2);
    font-size: var(--text-sm);
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    transition: opacity var(--dur-med) var(--ease-standard), transform var(--dur-med) var(--ease-standard);
  }
  .ui-toast.is-visible { opacity: 1; transform: translateY(0); }
  .ui-toast[data-tone='success'] { border-color: rgba(89,97,29,.52); background: rgba(89,97,29,.12); color: var(--brand-jack-pine); }
  .ui-toast[data-tone='warn'] { border-color: rgba(228,126,61,.52); background: rgba(228,126,61,.16); color: #8a3f1a; }
  .ui-toast[data-tone='danger'] { border-color: rgba(187,75,39,.54); background: rgba(187,75,39,.14); color: #7a2e18; }
  .ui-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 80;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    background: rgba(36,55,70,.45);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity var(--dur-med) var(--ease-standard);
  }
  .ui-modal-overlay.is-open { opacity: 1; visibility: visible; pointer-events: auto; }
  .ui-modal-overlay[hidden] { display: none !important; }
  .ui-modal {
    width: min(480px, 100%);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    border: 1px solid var(--border-subtle);
    background: #fff;
    box-shadow: var(--shadow-2);
  }
  .ui-modal-title { margin: 0 0 .45rem; font-size: 1.45rem; color: var(--brand-jack-pine); }
  .ui-modal-body { margin: 0; color: var(--text-muted); }
  .ui-modal-actions { margin-top: var(--space-4); display: flex; justify-content: flex-end; gap: .55rem; }
  .ui-modal-cancel { background: transparent; color: var(--brand-deep-water); border-color: var(--border-strong); }
  .ui-modal-cancel:hover { background: rgba(189,205,195,.3); border-color: var(--brand-blue-sky); }
  .ui-modal-confirm.is-danger { background: var(--danger); border-color: var(--danger); color: #fff; }
  .ui-modal-confirm.is-danger:hover { background: #a94222; border-color: #a94222; }
  .auth-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:var(--space-4); }
  .auth-card h3 { margin-top:0; }
  .auth-card .toolbar { margin-bottom:0; }
  .auth-card form { display:grid; gap:.55rem; }
  .session-bar { display:flex; justify-content:space-between; align-items:center; gap:var(--space-3); margin-bottom:var(--space-3); }
  .session-bar p { margin:0; }
  .admin-grid { display:grid; gap:var(--space-3); }
  .admin-user-row { display:grid; grid-template-columns: minmax(180px, 2fr) 120px 110px minmax(180px, 2fr) auto; gap:.45rem; align-items:center; }
  .admin-user-row input[type='text'], .admin-user-row input[type='password'], .admin-user-row select { width:100%; }
  .admin-header-row { font-size:var(--text-xs); color:var(--text-muted); text-transform:uppercase; letter-spacing:.06em; }
  .saved-banner {
    margin: 0 0 var(--space-3);
    padding: .55rem .7rem;
    border: 1px solid rgba(104,162,185,.45);
    background: rgba(104,162,185,.15);
    border-radius: var(--radius-sm);
    color: var(--brand-deep-water);
    font-size: var(--text-sm);
  }
  .saved-controls { display:flex; flex-wrap:wrap; gap:.55rem; align-items:center; }
  .saved-controls input, .saved-controls select { min-width: 220px; }
  .hidden { display:none !important; }
  body.modal-open { overflow: hidden; }
  @media (max-width: 1120px) {
    .workspace-shell { grid-template-columns: 1fr; }
    .workspace-nav { position:relative; top:auto; }
    .nav-links { grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); }
    .admin-user-row { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class='container'>
  <header class='app-header'>
    <div class='brand-block'>
      <img class='brand-logo' src='/static/brand/logo-full.svg' alt='Friends of Bon Echo Park logo'>
      <div>
        <p class='brand-kicker'>Friends of Bon Echo Park</p>
        <h1 class='brand-title'>FOBE Scheduler Workspace</h1>
        <p class='brand-subtitle'>Prototype scheduling console</p>
      </div>
    </div>
  </header>
  <p id='feedback' class='muted status-banner'></p>

  <section id='auth_shell' class='auth-grid'>
    <article class='card auth-card'>
      <h3>Sign In</h3>
      <p class='muted'>Use your email and password to access the scheduler workspace.</p>
      <form id='login_form'>
        <label>Email <input id='login_email' type='email' autocomplete='username' required></label>
        <label>Password <input id='login_password' type='password' autocomplete='current-password' required></label>
        <button type='submit'>Login</button>
      </form>
    </article>
    <article class='card auth-card'>
      <h3>Bootstrap First Admin</h3>
      <p class='muted'>Only for first-time setup when no users exist yet.</p>
      <form id='bootstrap_form'>
        <label>Bootstrap Token <input id='bootstrap_token' type='password' autocomplete='off' required></label>
        <label>Email <input id='bootstrap_email' type='email' autocomplete='username' required></label>
        <label>Password <input id='bootstrap_password' type='password' autocomplete='new-password' required></label>
        <button type='submit' class='btn-secondary'>Create First Admin</button>
      </form>
    </article>
  </section>

  <section id='app_shell' class='hidden'>
    <div class='card session-bar'>
      <p id='session_user' class='muted'></p>
      <button id='logout_btn' class='btn-secondary'>Logout</button>
    </div>

  <div class='workspace-shell'>
    <aside class='workspace-nav card'>
      <h3>Scheduler Map</h3>
      <p class='nav-caption'>Jump To Section</p>
      <nav class='nav-links'>
        <a class='nav-link' href='#section-period'>Scheduling Period</a>
        <a class='nav-link' href='#section-priority'>Priority Glossary</a>
        <a class='nav-link' href='#section-employees'>Employees</a>
        <a class='nav-link' href='#section-timeoff'>Days Off</a>
        <a class='nav-link' href='#section-extra'>Extra Coverage</a>
        <a class='nav-link' href='#section-generated'>Generate Schedule</a>
        <a class='nav-link' href='#section-history'>Previous Schedules</a>
        <a class='nav-link' id='nav-admin-link' href='#section-admin'>Admin Users</a>
      </nav>
    </aside>

    <main class='workspace-main'>
      <section id='section-period' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title'>Scheduling Period</h3>
            <p class='section-description'>Define start date, run length, and weekly boundaries before generation.</p>
          </div>
        </div>
        <div class='toolbar'>
          <label>Start Date <input id='period_start' type='date'></label>
          <label>Weeks <input id='period_weeks' type='number' min='1' max='8' value='2'></label>
          <label>Week Starts <select id='week_start_day'></select></label>
          <label><input id='schedule_beach_shop' type='checkbox' onchange='syncOverrides()'> Schedule Beach Shop</label>
        </div>
        <p id='week_boundary_note' class='muted control-note'></p>
        <div>
          <p class='muted'>Open days for this run (uncheck store-closed days):</p>
          <div id='open_day_rows' class='weekday-grid'></div>
        </div>
      </section>

      <section id='section-priority' class='card section-card'>
        <div class='section-heading compact'>
          <div>
            <h3 class='section-title' style='font-size:1.4rem'>Priority Glossary</h3>
          </div>
        </div>
        <ul class='priority-list'>
          <li class='priority-item'><span class='priority-pill a'>Priority A</span><span>Core staff with strongest preference for coverage.</span></li>
          <li class='priority-item'><span class='priority-pill b'>Priority B</span><span>Standard staffing priority.</span></li>
          <li class='priority-item'><span class='priority-pill c'>Priority C</span><span>Lowest assignment priority unless needed for coverage.</span></li>
        </ul>
      </section>

      <section id='section-employees' class='card section-card'>
        <div class='section-heading compact'>
          <div>
            <h3 class='section-title' style='font-size:1.45rem'>Employees</h3>
          </div>
        </div>
        <div class='action-row'>
          <p id='roster_mode_note' class='muted'>Roster data is loaded from persistent storage. Admins can edit and save updates for the whole organization.</p>
          <div class='toolbar'>
            <button id='add_employee_btn' class='btn-secondary' onclick='addEmployeeRow()'>Add Employee</button>
            <button id='save_roster_btn' onclick='saveRosterToApi()'>Save Roster</button>
          </div>
        </div>
        <div class='table-wrap'>
          <table>
            <thead><tr><th>Name</th><th>Role</th><th>Default Min Hrs</th><th>Default Max Hrs</th><th>Priority</th><th></th></tr></thead>
            <tbody id='employee_rows'></tbody>
          </table>
        </div>
      </section>

      <section id='section-timeoff' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title section-title-loose'>Days Off Requested</h3>
          </div>
        </div>
        <div class='action-row'>
          <p class='muted'>Add requested days off to protect known unavailable dates.</p>
          <button onclick='addTimeOffRow()'>Add Requested Day Off</button>
        </div>
        <div class='table-wrap'>
          <table>
            <thead><tr><th>Employee</th><th>Date</th><th>Reason</th><th></th></tr></thead>
            <tbody id='time_off_rows'></tbody>
          </table>
        </div>
      </section>

      <section id='section-extra' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title section-title-loose'>Extra Coverage Days</h3>
          </div>
        </div>
        <div class='action-row'>
          <p class='muted'>Track days requiring additional staff above baseline coverage.</p>
          <button onclick='addExtraRow()'>Add Extra Day</button>
        </div>
        <div class='table-wrap'>
          <table>
            <thead><tr><th>Date</th><th>Extra People</th><th></th></tr></thead>
            <tbody id='extra_rows'></tbody>
          </table>
        </div>
      </section>

      <section id='section-generated' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title section-title-loose'>Newly Generated Schedule</h3>
          </div>
        </div>
        <div class='toolbar'>
          <button onclick='runGenerate()'>Generate Schedule</button>
          <button id='finalize_btn' onclick='finalizeSchedule()' disabled>Finalize Schedule</button>
        </div>
        <p id='saved_schedule_banner' class='saved-banner hidden'></p>
        <div id='result'>Generate to view schedule.</div>
      </section>

      <section id='section-history' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title section-title-loose'>Existing Previous Schedules</h3>
            <p class='section-description'>Finalized schedules are shared across browsers.</p>
          </div>
        </div>
        <div class='toolbar'>
          <button id='refresh_history_btn' class='btn-secondary' type='button'>Refresh Saved Schedules</button>
        </div>
        <div id='history'>No saved schedules yet.</div>
      </section>

      <section id='section-admin' class='card section-card'>
        <div class='section-heading compact'>
          <div>
            <h3 class='section-title' style='font-size:1.45rem'>Admin User Management</h3>
            <p class='section-description'>Create users, update roles, reset temporary passwords, and enable or disable access.</p>
          </div>
        </div>
        <div class='admin-grid'>
          <form id='admin_create_user_form' class='toolbar'>
            <label>Email <input id='admin_new_email' type='email' required></label>
            <label>Temporary Password <input id='admin_new_password' type='password' required></label>
            <label>Role
              <select id='admin_new_role'>
                <option value='user'>user</option>
                <option value='admin'>admin</option>
              </select>
            </label>
            <button type='submit'>Create User</button>
          </form>
          <div class='table-wrap'>
            <div class='admin-user-row admin-header-row'>
              <span>Email</span>
              <span>Role</span>
              <span>Active</span>
              <span>Reset Password</span>
              <span>Save</span>
            </div>
            <div id='admin_users_rows' class='admin-grid'></div>
          </div>
        </div>
      </section>
    </main>
  </div>
  </section>
</div>

<div id='ui_modal_overlay' class='ui-modal-overlay' hidden>
  <div class='ui-modal' role='dialog' aria-modal='true' aria-labelledby='ui_modal_title' aria-describedby='ui_modal_body'>
    <h4 id='ui_modal_title' class='ui-modal-title'>Confirm Action</h4>
    <p id='ui_modal_body' class='ui-modal-body'></p>
    <div class='ui-modal-actions'>
      <button id='ui_modal_cancel' type='button' class='ui-modal-cancel'>Cancel</button>
      <button id='ui_modal_confirm' type='button' class='ui-modal-confirm'>Confirm</button>
    </div>
  </div>
</div>

<div id='ui_toast' class='ui-toast' role='status' aria-live='polite'></div>

<script>
const ROLE_OPTIONS = ['Store Clerk','Team Leader','Store Manager','Boat Captain'];
const DAY_KEYS = ['mon','tue','wed','thu','fri','sat','sun'];
const JS_DAY_KEYS = ['sun','mon','tue','wed','thu','fri','sat'];
const DAY_LABELS = {mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday',sun:'Sunday'};
const KEY_TO_JS_DAY = {sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6};
const SAMPLE_PAYLOAD = {{ payload_json | safe }};
let generatedAssignments=[];
let lastResponse=null;
let currentDraftPeriod=null;
let currentDraftPayload=null;
let liveViolations=[];
let rerollCounter=0;
let activeDragData=null;
let toastTimer=null;
let modalResolver=null;
let priorFocus=null;
let modalHideTimer=null;
let currentUser=null;
let isAdmin=false;
let savedSchedulesMeta=[];
let activeSavedScheduleMeta=null;

function showMessage(msg, tone='neutral') {
  const banner=document.getElementById('feedback');
  banner.textContent = msg;
  banner.dataset.tone = tone;
}
function showToast(msg, tone='info', duration=2800) {
  const toast=document.getElementById('ui_toast');
  toast.textContent=msg;
  toast.dataset.tone=tone;
  toast.classList.add('is-visible');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.classList.remove('is-visible'), duration);
}
async function apiFetch(path, options={}) {
  const res=await fetch(path, {
    credentials:'include',
    cache:'no-store',
    ...options,
  });
  let data=null;
  const text=await res.text();
  if(text) {
    try { data=JSON.parse(text); } catch { data={detail:text}; }
  }
  if(!res.ok) {
    const detail=typeof data?.detail==='string' ? data.detail : `${res.status} ${res.statusText}`;
    const err=new Error(detail);
    err.status=res.status;
    err.payload=data;
    throw err;
  }
  return data;
}

function setAuthShellVisibility(authenticated) {
  document.getElementById('auth_shell').classList.toggle('hidden', authenticated);
  document.getElementById('app_shell').classList.toggle('hidden', !authenticated);
}

function updateSessionBar() {
  const sessionLabel=document.getElementById('session_user');
  if(!currentUser) {
    sessionLabel.textContent='';
    return;
  }
  sessionLabel.textContent=`Signed in as ${currentUser.email} (${currentUser.role})`;
}

function applyRolePermissions() {
  const adminSection=document.getElementById('section-admin');
  const navAdmin=document.getElementById('nav-admin-link');
  adminSection.classList.toggle('hidden', !isAdmin);
  navAdmin.classList.toggle('hidden', !isAdmin);
  document.getElementById('save_roster_btn').classList.toggle('hidden', !isAdmin);
  document.getElementById('add_employee_btn').classList.toggle('hidden', !isAdmin);
  document.getElementById('finalize_btn').classList.toggle('hidden', !isAdmin);
  const note=document.getElementById('roster_mode_note');
  note.textContent = isAdmin
    ? 'Roster data is loaded from the shared database. Save applies roster changes for all users.'
    : 'Roster data is read-only for non-admin users.';
  document.querySelectorAll('#employee_rows input, #employee_rows select').forEach(el=>{ el.disabled = !isAdmin; });
  document.querySelectorAll('#employee_rows .btn-remove-employee').forEach(btn=>{ btn.disabled = !isAdmin; });
}

async function fetchCurrentUser() {
  try {
    currentUser=await apiFetch('/auth/me');
    isAdmin=currentUser.role==='admin';
    updateSessionBar();
    setAuthShellVisibility(true);
    return true;
  } catch (err) {
    currentUser=null;
    isAdmin=false;
    updateSessionBar();
    setAuthShellVisibility(false);
    return false;
  }
}

async function handleLoginSubmit(ev) {
  ev.preventDefault();
  const email=document.getElementById('login_email').value.trim();
  const password=document.getElementById('login_password').value;
  try {
    await apiFetch('/auth/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,password}),
    });
    document.getElementById('login_password').value='';
    await initializeAuthenticatedApp();
    showMessage('Logged in successfully.', 'success');
    showToast('Logged in.', 'success');
  } catch (err) {
    showMessage(err.message || 'Login failed.', 'danger');
    showToast(err.message || 'Login failed.', 'danger');
  }
}

async function handleBootstrapSubmit(ev) {
  ev.preventDefault();
  const token=document.getElementById('bootstrap_token').value;
  const email=document.getElementById('bootstrap_email').value.trim();
  const password=document.getElementById('bootstrap_password').value;
  try {
    await apiFetch('/auth/bootstrap', {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'X-Bootstrap-Token':token,
      },
      body:JSON.stringify({email,password}),
    });
    document.getElementById('bootstrap_token').value='';
    document.getElementById('bootstrap_password').value='';
    await initializeAuthenticatedApp();
    showMessage('First admin created and logged in.', 'success');
    showToast('Bootstrap complete.', 'success');
  } catch (err) {
    showMessage(err.message || 'Bootstrap failed.', 'danger');
    showToast(err.message || 'Bootstrap failed.', 'danger');
  }
}

async function handleLogout() {
  try {
    await apiFetch('/auth/logout', {method:'POST'});
  } catch {
    // Always proceed to logged-out state even if session row was already cleared.
  }
  currentUser=null;
  isAdmin=false;
  savedSchedulesMeta=[];
  document.getElementById('history').innerHTML='No saved schedules yet.';
  clearSavedScheduleBanner();
  setAuthShellVisibility(false);
  showMessage('Logged out.', 'success');
}
function openDecisionModal({title='Confirm Action', body='', confirmLabel='Confirm', cancelLabel='Cancel', confirmTone='primary', showCancel=true}={}) {
  const overlay=document.getElementById('ui_modal_overlay');
  const titleEl=document.getElementById('ui_modal_title');
  const bodyEl=document.getElementById('ui_modal_body');
  const cancelBtn=document.getElementById('ui_modal_cancel');
  const confirmBtn=document.getElementById('ui_modal_confirm');
  titleEl.textContent=title;
  bodyEl.textContent=body;
  cancelBtn.textContent=cancelLabel;
  confirmBtn.textContent=confirmLabel;
  cancelBtn.hidden = !showCancel;
  cancelBtn.style.display = showCancel ? '' : 'none';
  confirmBtn.classList.toggle('is-danger', confirmTone==='danger');
  if(modalHideTimer) clearTimeout(modalHideTimer);
  priorFocus=document.activeElement instanceof HTMLElement ? document.activeElement : null;
  overlay.hidden=false;
  requestAnimationFrame(()=>overlay.classList.add('is-open'));
  document.body.classList.add('modal-open');
  confirmBtn.focus();
  return new Promise(resolve=>{ modalResolver=resolve; });
}
function closeDecisionModal(result) {
  const overlay=document.getElementById('ui_modal_overlay');
  overlay.classList.remove('is-open');
  document.body.classList.remove('modal-open');
  modalHideTimer=setTimeout(()=>{ overlay.hidden=true; }, 120);
  if(priorFocus) priorFocus.focus();
  if(modalResolver) {
    const resolve=modalResolver;
    modalResolver=null;
    resolve(result);
  }
}
function wireModalEvents() {
  const overlay=document.getElementById('ui_modal_overlay');
  document.getElementById('ui_modal_cancel').addEventListener('click', ()=>closeDecisionModal(false));
  document.getElementById('ui_modal_confirm').addEventListener('click', ()=>closeDecisionModal(true));
  overlay.addEventListener('click', (ev)=>{
    if(ev.target===overlay && !document.getElementById('ui_modal_cancel').hidden) closeDecisionModal(false);
  });
  document.addEventListener('keydown', (ev)=>{
    if(ev.key==='Escape' && !overlay.hidden) {
      closeDecisionModal(!document.getElementById('ui_modal_cancel').hidden ? false : true);
    }
  });
}
function slugifyName(name, idx) { return name.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'') || `emp_${idx+1}`; }
function esc(value) { return String(value).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }
function parseDate(s) { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function fmtDate(s) { return new Date(s+'T00:00:00').toLocaleDateString(); }
function fmtDateWithDay(s) { return new Date(s+'T00:00:00').toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'short', day:'numeric' }); }
function iso(d) { return d.toISOString().slice(0,10); }
function weekdayLabel(key) { return DAY_LABELS[key] || key; }
function previousDayKey(key) { const idx=DAY_KEYS.indexOf(key); return DAY_KEYS[(idx+6)%7]; }
function keyToJsDay(key) { return KEY_TO_JS_DAY[key] ?? 0; }
function weekStartDay() { return document.getElementById('week_start_day')?.value || 'sun'; }
function weekEndDay() { return previousDayKey(weekStartDay()); }
function nextOrSameWeekday(d, dayKey) { const x=new Date(d); const delta=(keyToJsDay(dayKey)-x.getDay()+7)%7; x.setDate(x.getDate()+delta); return x; }
function weekStartForDate(d, dayKey) { const x=new Date(d); const delta=(x.getDay()-keyToJsDay(dayKey)+7)%7; x.setDate(x.getDate()-delta); return x; }
function dayKeyForDate(d) { return JS_DAY_KEYS[d.getDay()]; }
function timeToMinutes(value) { const [h,m]=value.split(':').map(Number); return h*60+m; }
function coversWindow(windows, start, end) {
  const s=timeToMinutes(start);
  const e=timeToMinutes(end);
  return (windows||[]).some(w=>{
    const [ws,we]=w.split('-');
    return timeToMinutes(ws) <= s && timeToMinutes(we) >= e;
  });
}
function daterangeIso(startIso, days) {
  const out=[];
  const d=parseDate(startIso);
  for(let i=0;i<days;i++) {
    const x=new Date(d);
    x.setDate(x.getDate()+i);
    out.push(iso(x));
  }
  return out;
}
function usesBeachShop(period=null) {
  if(period && typeof period.schedule_beach_shop === 'boolean') return period.schedule_beach_shop;
  return !!document.getElementById('schedule_beach_shop')?.checked;
}
function firstMonday(year, monthIndex) { const d=new Date(year, monthIndex, 1); while(d.getDay()!==1) d.setDate(d.getDate()+1); return d; }
function victoriaDay(year) { const d=new Date(year, 4, 24); while(d.getDay()!==1) d.setDate(d.getDate()-1); return d; }
function seasonRulesForYear(year) {
  return {
    victoria_day: iso(victoriaDay(year)),
    june_30: iso(new Date(year, 5, 30)),
    labour_day: iso(firstMonday(year, 8)),
    oct_31: iso(new Date(year, 9, 31)),
  };
}

function roleCounts() {
  const roles=[...document.querySelectorAll('.emp-role')].map(s=>s.value);
  return { manager: roles.filter(r=>r==='Store Manager').length, lead: roles.filter(r=>r==='Team Leader').length };
}
function refreshRoleOptions() {
  const c=roleCounts();
  document.querySelectorAll('.emp-role').forEach(sel=>{
    const current=sel.value;
    sel.innerHTML = ROLE_OPTIONS.map(r=>{
      const disabled = (r==='Store Manager' && c.manager>=1 && current!=='Store Manager') || (r==='Team Leader' && c.lead>=2 && current!=='Team Leader');
      return `<option value="${r}" ${current===r?'selected':''} ${disabled?'disabled':''}>${r}</option>`;
    }).join('');
  });
}

function defaultAvailability() { return Object.fromEntries(DAY_KEYS.map(day=>[day,['08:30-17:30']])); }
function employeeRowHtml(emp={}) {
  const availability=emp.availability||defaultAvailability();
  const employeeId=emp.id||'';
  return `<tr><td><input class='emp-name' value='${esc(emp.name||'')}'></td><td><select class='emp-role' onchange='refreshRoleOptions();syncOverrides()'>${ROLE_OPTIONS.map(r=>`<option value="${r}" ${(emp.role||'Store Clerk')===r?'selected':''}>${r}</option>`).join('')}</select></td><td><input type='number' class='emp-min' value='${emp.min_hours_per_week??16}' onchange='syncOverrides()'></td><td><input type='number' class='emp-max' value='${emp.max_hours_per_week??40}' onchange='syncOverrides()'></td><td><select class='emp-priority'><option value='A' ${emp.priority_tier==='A'?'selected':''}>A</option><option value='B' ${(!emp.priority_tier||emp.priority_tier==='B')?'selected':''}>B</option><option value='C' ${emp.priority_tier==='C'?'selected':''}>C</option></select></td><td><input type='hidden' class='emp-id' value='${esc(employeeId)}'><input type='hidden' class='emp-availability' value='${esc(JSON.stringify(availability))}'><button class='btn-remove-employee' onclick='this.closest("tr").remove();refreshRoleOptions();syncOverrides()'>Remove</button></td></tr>`;
}
function addEmployeeRow(emp={}) {
  document.getElementById('employee_rows').insertAdjacentHTML('beforeend', employeeRowHtml(emp));
  refreshRoleOptions();
  syncOverrides();
  applyRolePermissions();
}
function renderRosterRows(employees=[]) {
  const tbody=document.getElementById('employee_rows');
  tbody.innerHTML='';
  employees.forEach(emp=>tbody.insertAdjacentHTML('beforeend', employeeRowHtml(emp)));
  refreshRoleOptions();
  syncOverrides();
  applyRolePermissions();
}
async function loadRosterFromApi() {
  const employees=await apiFetch('/api/employees');
  renderRosterRows(Array.isArray(employees) ? employees : []);
}
async function saveRosterToApi() {
  if(!isAdmin) {
    showToast('Only admins can save roster updates.', 'warn');
    return;
  }
  const employees=getEmployeesFromTable();
  try {
    const saved=await apiFetch('/api/employees', {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(employees),
    });
    renderRosterRows(Array.isArray(saved) ? saved : []);
    showMessage('Roster saved.', 'success');
    showToast('Roster saved.', 'success');
  } catch (err) {
    showMessage(err.message || 'Failed to save roster.', 'danger');
    showToast(err.message || 'Failed to save roster.', 'danger');
  }
}

function clearSavedScheduleBanner() {
  activeSavedScheduleMeta=null;
  const banner=document.getElementById('saved_schedule_banner');
  banner.textContent='';
  banner.classList.add('hidden');
}

function showSavedScheduleBanner(meta) {
  activeSavedScheduleMeta=meta;
  const banner=document.getElementById('saved_schedule_banner');
  const title=(meta?.label||'Untitled schedule').trim();
  const created=meta?.created_at ? new Date(meta.created_at).toLocaleString() : '';
  banner.textContent = `Viewing saved schedule: ${title}${created ? ` (${created})` : ''}`;
  banner.classList.remove('hidden');
}

function savedScheduleTitle(meta) {
  return (meta?.label || `Schedule ${meta?.period_start || ''}`).trim();
}

async function loadSavedSchedules() {
  const list=await apiFetch(`/api/schedules?_=${Date.now()}`);
  savedSchedulesMeta=Array.isArray(list) ? list : [];
  await renderHistory();
}

function hydratePeriodFromSaved(payloadJson, meta) {
  const period=payloadJson?.period||{};
  const weekStart=payloadJson?.week_start_day || 'sun';
  return {
    start_date: period.start_date || meta.period_start,
    weeks: Number(period.weeks || meta.weeks || 2),
    week_start_day: weekStart,
    week_end_day: payloadJson?.week_end_day || previousDayKey(weekStart),
    schedule_beach_shop: !!payloadJson?.schedule_beach_shop,
  };
}

async function loadSavedScheduleById(scheduleId) {
  const payload=await apiFetch(`/api/schedules/${scheduleId}?_=${Date.now()}`);
  currentDraftPayload = payload.payload_json || null;
  currentDraftPeriod = hydratePeriodFromSaved(payload.payload_json || {}, payload);
  lastResponse = payload.result_json || null;
  generatedAssignments = [...(payload.result_json?.assignments || [])];
  rerenderOutput();
  const matched=savedSchedulesMeta.find(meta=>meta.id===payload.id) || payload;
  showSavedScheduleBanner(matched);
}

async function viewSavedSchedule(scheduleId) {
  try {
    await loadSavedScheduleById(scheduleId);
    showToast('Saved schedule loaded.', 'success');
    location.hash = '#section-generated';
  } catch (err) {
    showToast(err.message || 'Failed to load saved schedule.', 'danger');
  }
}

function buildResultSnapshotForSave() {
  return {
    assignments: generatedAssignments,
    violations: liveViolations,
    totals_by_employee: lastResponse?.totals_by_employee || {},
  };
}

async function persistCurrentScheduleToDb() {
  if(!isAdmin) throw new Error('Only admins can save schedules.');
  if(!currentDraftPayload || !currentDraftPeriod || !generatedAssignments.length) {
    throw new Error('Generate or load a schedule before saving.');
  }
  const periodStart=currentDraftPeriod.start_date;
  const payload={
    label: `Schedule ${periodStart}`,
    period_start: periodStart,
    weeks: Number(currentDraftPeriod.weeks||2),
    payload_json: currentDraftPayload,
    result_json: buildResultSnapshotForSave(),
  };
  const created=await apiFetch('/api/schedules', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(payload),
  });
  await loadSavedSchedules();
  showSavedScheduleBanner(created);
  return created;
}

function violationsHtml(violations=[]) {
  if(!violations.length) return '<p>No violations.</p>';
  return `<h4>Rule checks</h4><ul>${violations.map(v=>`<li>${esc(v.date)}: ${esc(v.detail)}</li>`).join('')}</ul>`;
}

async function renderHistory() {
  const historyEl=document.getElementById('history');
  if(!savedSchedulesMeta.length) {
    historyEl.innerHTML='No saved schedules yet.';
    return;
  }
  historyEl.innerHTML="<p class='muted'>Loading saved schedules...</p>";
  const entries=await Promise.all(savedSchedulesMeta.map(async (meta)=>{
    try {
      const payload=await apiFetch(`/api/schedules/${meta.id}?_=${Date.now()}`);
      return {meta, payload, error:null};
    } catch (err) {
      return {meta, payload:null, error:err};
    }
  }));
  historyEl.innerHTML = entries.map((entry, idx)=>{
    const meta=entry.meta;
    const title=savedScheduleTitle(meta);
    const created=new Date(meta.created_at).toLocaleString();
    const summary=`<strong>${esc(title)}</strong> — ${esc(fmtDateWithDay(meta.period_start))} for ${meta.weeks} week(s) — saved ${esc(created)} by ${esc(meta.created_by_email)}`;
    if(entry.error || !entry.payload) {
      return `<details ${idx===0?'open':''}><summary>${summary}</summary><p class='muted'>Could not load this saved schedule right now.</p></details>`;
    }
    const payload=entry.payload;
    const period=hydratePeriodFromSaved(payload.payload_json || {}, payload);
    const assignments=[...(payload.result_json?.assignments || [])];
    const showBeach = !!period.schedule_beach_shop || assignments.some(a=>a.location==='Beach Shop');
    const violations=payload.result_json?.violations || [];
    return `<details ${idx===0?'open':''}><summary>${summary}</summary>${renderSchedule(assignments, false, false, showBeach)}${buildSummary(assignments, period)}${violationsHtml(violations)}<div class='toolbar'><button type='button' onclick='viewSavedSchedule(${payload.id})'>View In Editor</button><button type='button' onclick='exportSavedSchedulePdfById(${payload.id})'>Export PDF</button></div></details>`;
  }).join('');
}

async function exportSavedSchedulePdfById(scheduleId) {
  try {
    const payload=await apiFetch(`/api/schedules/${scheduleId}?_=${Date.now()}`);
    const item={
      period: hydratePeriodFromSaved(payload.payload_json || {}, payload),
      assignments: [...(payload.result_json?.assignments || [])],
      violations: [...(payload.result_json?.violations || [])],
    };
    exportSchedulePdfItem(item);
  } catch (err) {
    showToast(err.message || 'Failed to export saved schedule.', 'danger');
  }
}

function extraRowHtml(row={}) { return `<tr><td><input type='date' class='extra-date' value='${row.date||''}'></td><td><input type='number' min='1' class='extra-people' value='${row.extra_people||1}'></td><td><button onclick='this.closest("tr").remove()'>Remove</button></td></tr>`; }
function addExtraRow(row={}) { document.getElementById('extra_rows').insertAdjacentHTML('beforeend', extraRowHtml(row)); applyScheduleWindowToDateInputs(); }
function timeOffRowHtml(row={}) {
  const employeeOptions=getEmployeesFromTable().map(e=>`<option value='${e.id}' ${row.employee_id===e.id?'selected':''}>${e.name}</option>`).join('');
  return `<tr><td><select class='to-emp'>${employeeOptions}</select></td><td><select class='to-date' data-selected='${row.date||''}'><option value=''>Select date</option></select></td><td><input class='to-reason' value='${row.reason||''}' placeholder='Vacation, appointment, etc.'></td><td><button onclick='this.closest("tr").remove()'>Remove</button></td></tr>`;
}
function addTimeOffRow(row={}) {
  document.getElementById('time_off_rows').insertAdjacentHTML('beforeend', timeOffRowHtml(row));
  applyScheduleWindowToDateInputs();
  refreshTimeOffDateOptions({notify:false});
}
function refreshTimeOffEmployeeOptions() {
  const employees=getEmployeesFromTable();
  const rows=[...document.querySelectorAll('#time_off_rows tr')].map(tr=>({employee_id:tr.querySelector('.to-emp')?.value||'',date:tr.querySelector('.to-date')?.value||'',reason:tr.querySelector('.to-reason')?.value||''}));
  const tbody=document.getElementById('time_off_rows');
  tbody.innerHTML='';
  rows.forEach(r=>{
    const fallback=employees[0]?.id||'';
    const selected=employees.some(e=>e.id===r.employee_id)?r.employee_id:fallback;
    tbody.insertAdjacentHTML('beforeend', timeOffRowHtml({...r,employee_id:selected}));
  });
  refreshTimeOffDateOptions({notify:false});
}

function scheduleWindowDateList() {
  const bounds=scheduleWindowBounds();
  if(!bounds) return [];
  const dates=[];
  const cursor=parseDate(bounds.min);
  const end=parseDate(bounds.max);
  while(cursor <= end) {
    dates.push(iso(cursor));
    cursor.setDate(cursor.getDate()+1);
  }
  return dates;
}

function refreshTimeOffDateOptions({notify=false}={}) {
  const rows=[...document.querySelectorAll('#time_off_rows tr')].map(tr=>{
    const dateSelect=tr.querySelector('.to-date');
    return {
      tr,
      employee_id: tr.querySelector('.to-emp')?.value||'',
      date_select: dateSelect,
      date: dateSelect?.value || dateSelect?.dataset?.selected || '',
    };
  });
  if(!rows.length) return;

  const dates=scheduleWindowDateList();
  const seen=new Set();
  let hadDuplicate=false;
  for(const row of rows) {
    if(!row.employee_id || !row.date) continue;
    const key=`${row.employee_id}|${row.date}`;
    if(seen.has(key)) {
      row.date='';
      hadDuplicate=true;
    } else {
      seen.add(key);
    }
  }

  const selectedByEmployee=new Map();
  for(const row of rows) {
    if(!row.employee_id || !row.date) continue;
    selectedByEmployee.set(row.employee_id, selectedByEmployee.get(row.employee_id) || new Set());
    selectedByEmployee.get(row.employee_id).add(row.date);
  }

  for(const row of rows) {
    const select=row.date_select;
    if(!select) continue;
    const taken=new Set(selectedByEmployee.get(row.employee_id) || []);
    if(row.date) taken.delete(row.date);
    let options=`<option value=''>Select date</option>`;
    for(const dIso of dates) {
      const blocked=!!row.employee_id && taken.has(dIso);
      options += `<option value='${dIso}' ${row.date===dIso?'selected':''} ${blocked?'disabled':''}>${fmtDateWithDay(dIso)}${blocked?' (already selected)':''}</option>`;
    }
    if(row.date && !dates.includes(row.date)) {
      options += `<option value='${row.date}' selected>${fmtDateWithDay(row.date)}</option>`;
    }
    select.innerHTML=options;
    select.disabled = !row.employee_id || !dates.length;
    if(!row.employee_id) select.value='';
    select.dataset.selected='';
  }

  if(hadDuplicate && notify) {
    showToast('Duplicate requested days off for the same employee were cleared.', 'warn', 3000);
  }
}

function getEmployeesFromTable() {
  return [...document.querySelectorAll('#employee_rows tr')].map((tr,idx)=>{
    const name=tr.querySelector('.emp-name').value.trim();
    let availability=defaultAvailability();
    const availabilityRaw=tr.querySelector('.emp-availability')?.value||'';
    if(availabilityRaw) {
      try { availability=JSON.parse(availabilityRaw); } catch {}
    }
    const existingId=tr.querySelector('.emp-id')?.value?.trim() || '';
    const id=existingId || slugifyName(name,idx);
    return {id,name,role:tr.querySelector('.emp-role').value,min_hours_per_week:Number(tr.querySelector('.emp-min').value||0),max_hours_per_week:Number(tr.querySelector('.emp-max').value||40),priority_tier:tr.querySelector('.emp-priority').value,availability};
  }).filter(e=>e.name);
}

function updateWeekBoundaryNote() {
  const note=document.getElementById('week_boundary_note');
  if(!note) return;
  note.innerHTML = `Schedules are grouped and summarized by week from <strong>${weekdayLabel(weekStartDay())}</strong> to <strong>${weekdayLabel(weekEndDay())}</strong>.`;
}

function alignPeriodStartToBoundary() {
  const startInput=document.getElementById('period_start');
  if(!startInput) return;
  const minStart=nextOrSameWeekday(new Date(), weekStartDay());
  const base=startInput.value ? parseDate(startInput.value) : minStart;
  let aligned=nextOrSameWeekday(base, weekStartDay());
  if(aligned < minStart) aligned = minStart;
  startInput.min = iso(minStart);
  startInput.step = '7';
  startInput.value = iso(aligned);
}

function handleWeekBoundaryChange() {
  alignPeriodStartToBoundary();
  updateWeekBoundaryNote();
  renderOpenDaySelectors();
}

function syncOverrides() {
  refreshTimeOffEmployeeOptions();
  rerenderOutput();
}

function scheduleWindowBounds() {
  const startRaw=document.getElementById('period_start')?.value;
  if(!startRaw) return null;
  const weeks=Math.max(1, Number(document.getElementById('period_weeks')?.value||2));
  const startDate=nextOrSameWeekday(parseDate(startRaw), weekStartDay());
  const endDate=new Date(startDate);
  endDate.setDate(endDate.getDate() + (weeks * 7) - 1);
  return { min: iso(startDate), max: iso(endDate) };
}

function applyScheduleWindowToDateInputs() {
  const bounds=scheduleWindowBounds();
  if(!bounds) return;
  document.querySelectorAll('.extra-date').forEach(input=>{
    input.min = bounds.min;
    input.max = bounds.max;
    if(input.value && (input.value < bounds.min || input.value > bounds.max)) {
      input.value = '';
    }
  });
  refreshTimeOffDateOptions({notify:false});
}

function renderOpenDaySelectors() {
  const wrap=document.getElementById('open_day_rows');
  const selected=new Set(getSelectedOpenDays());
  wrap.innerHTML = DAY_KEYS.map(day=>`<label class='open-day-chip'><input type='checkbox' class='open-day' value='${day}' ${selected.has(day)?'checked':''}><span>${weekdayLabel(day)}</span></label>`).join('');
  syncOpenDayChipStates();
  applyScheduleWindowToDateInputs();
}

function syncOpenDayChipStates() {
  document.querySelectorAll('.open-day-chip').forEach(chip=>{
    const checked=chip.querySelector('.open-day')?.checked;
    chip.classList.toggle('is-selected', !!checked);
  });
}

function getSelectedOpenDays() {
  const boxes=[...document.querySelectorAll('.open-day')];
  if(!boxes.length) return [...DAY_KEYS];
  return boxes.filter(b=>b.checked).map(b=>b.value);
}

function collectPayload(rerollToken=0) {
  const employees=getEmployeesFromTable();
  const extra_coverage_days=[...document.querySelectorAll('#extra_rows tr')].map(tr=>({date:tr.querySelector('.extra-date').value,extra_people:Number(tr.querySelector('.extra-people').value||1)})).filter(r=>r.date);
  const unavailability=[...document.querySelectorAll('#time_off_rows tr')].map(tr=>({employee_id:tr.querySelector('.to-emp').value,date:tr.querySelector('.to-date').value,reason:tr.querySelector('.to-reason').value.trim()})).filter(r=>r.employee_id && r.date);
  const startInput=document.getElementById('period_start');
  const start=startInput.value;
  const weeks=Number(document.getElementById('period_weeks').value||2);
  const startDate=nextOrSameWeekday(parseDate(start), weekStartDay());
  const alignedStart=iso(startDate);
  if(start!==alignedStart) startInput.value = alignedStart;
  const open_weekdays=getSelectedOpenDays();
  const schedule_beach_shop=document.getElementById('schedule_beach_shop').checked;
  return {...SAMPLE_PAYLOAD, period:{start_date:alignedStart, weeks}, season_rules:seasonRulesForYear(startDate.getFullYear()), employees, extra_coverage_days, unavailability, open_weekdays, week_start_day:weekStartDay(), week_end_day:weekEndDay(), reroll_token: rerollToken, schedule_beach_shop};
}

function refreshCurrentDraftPayload() {
  if(!currentDraftPeriod) return;
  const draft=collectPayload(rerollCounter);
  const draftStart=currentDraftPeriod.start_date;
  draft.period = { start_date: draftStart, weeks: currentDraftPeriod.weeks };
  draft.season_rules = seasonRulesForYear(parseDate(draftStart).getFullYear());
  draft.week_start_day = currentDraftPeriod.week_start_day;
  draft.week_end_day = currentDraftPeriod.week_end_day;
  draft.schedule_beach_shop = !!currentDraftPeriod.schedule_beach_shop;
  currentDraftPayload = draft;
}

function weekendLeaderShortageDates(payload) {
  const managerIds=new Set(payload.employees.filter(e=>e.role==='Store Manager').map(e=>e.id));
  const leaders=payload.employees.filter(e=>e.role==='Team Leader');
  if(!managerIds.size || !leaders.length) return [];
  const openDays=new Set(payload.open_weekdays||DAY_KEYS);
  const unavail=new Set((payload.unavailability||[]).map(u=>`${u.employee_id}|${u.date}`));
  const dates=daterangeIso(payload.period.start_date, payload.period.weeks * 7);
  const out=[];
  for(const dIso of dates) {
    const d=parseDate(dIso);
    const dayKey=dayKeyForDate(d);
    if(!(d.getDay()===0 || d.getDay()===6)) continue;
    if(!openDays.has(dayKey)) continue;
    const managerRequestedOff=[...managerIds].some(id=>unavail.has(`${id}|${dIso}`));
    if(!managerRequestedOff) continue;
    const availableLeaders=leaders.filter(l=>!unavail.has(`${l.id}|${dIso}`) && coversWindow(l.availability?.[dayKey], payload.hours.greystones.start, payload.hours.greystones.end));
    if(availableLeaders.length === 1) out.push(dIso);
  }
  return out;
}

function calcShiftHours(start, end) {
  const [sh,sm]=start.split(':').map(Number);
  const [eh,em]=end.split(':').map(Number);
  const raw=(eh*60+em-sh*60-sm)/60;
  return Math.max(0, raw - (raw>=6 ? 1 : 0));
}

function formatHours(value) {
  return Number(value.toFixed(2)).toString();
}

function ordinalFromIso(value) {
  const [y,m,d]=value.split('-').map(Number);
  return Date.UTC(y,m-1,d) / 86400000;
}

function isWeekendIso(value) {
  const d=parseDate(value);
  return d.getDay()===0 || d.getDay()===6;
}

function isBeachShopOpenDate(value, seasonRules) {
  const d=parseDate(value);
  const labourDay=parseDate(seasonRules?.labour_day || value);
  const july1=parseDate(`${d.getFullYear()}-07-01`);
  return isWeekendIso(value) || (d >= july1 && d <= labourDay);
}

function weekStartsForPeriod(period) {
  const out=[];
  const totalWeeks=Math.max(0, Number(period?.weeks||0));
  for(let i=0;i<totalWeeks;i++) {
    const d=parseDate(period.start_date);
    d.setDate(d.getDate() + i*7);
    out.push(iso(d));
  }
  return out;
}

function computeLiveViolations(assignments, payload) {
  if(!payload?.period?.start_date || !payload?.period?.weeks) return [];
  const employees=payload.employees||[];
  const employeeById=new Map(employees.map(e=>[e.id,e]));
  const employeeByName=new Map(employees.map(e=>[e.name,e]));
  const managerIds=employees.filter(e=>e.role==='Store Manager').map(e=>e.id);
  const managerNameById=new Map(employees.filter(e=>e.role==='Store Manager').map(e=>[e.id,e.name]));
  const openWeekdays=new Set(payload.open_weekdays||DAY_KEYS);
  const allDates=daterangeIso(payload.period.start_date, Number(payload.period.weeks||0) * 7);
  const allDateSet=new Set(allDates);
  const extrasByDate=new Map((payload.extra_coverage_days||[]).map(x=>[x.date, Number(x.extra_people||0)]));
  const unavail=new Set((payload.unavailability||[]).map(x=>`${x.employee_id}|${x.date}`));

  const floorByDate=new Map();
  const captainByDate=new Map();
  const beachByDate=new Map();
  const managerWorkByDate=new Map();
  const dailyMaxHours=new Map();
  const startOrdinal=ordinalFromIso(payload.period.start_date);
  const inc=(map,key)=>map.set(key, (map.get(key)||0) + 1);

  const employeeForAssignment=(a)=>employeeById.get(a.employee_id) || employeeByName.get(a.employee_name) || null;

  for(const a of assignments) {
    if(!allDateSet.has(a.date)) continue;
    const employee=employeeForAssignment(a);
    const employeeId=employee?.id || a.employee_id || a.employee_name;

    if(a.location==='Greystones' && (a.role==='Team Leader' || a.role==='Store Clerk')) inc(floorByDate, a.date);
    if(a.location==='Boat' && a.role==='Boat Captain') inc(captainByDate, a.date);
    if(a.location==='Beach Shop') inc(beachByDate, a.date);

    if(managerIds.includes(employeeId)) {
      if(!managerWorkByDate.has(a.date)) managerWorkByDate.set(a.date, new Set());
      managerWorkByDate.get(a.date).add(employeeId);
    }

    const hours=calcShiftHours(a.start, a.end);
    const dayKey=`${employeeId}|${a.date}`;
    const prior=dailyMaxHours.get(dayKey)||0;
    if(hours > prior) dailyMaxHours.set(dayKey, hours);
  }

  const weeklyHours=new Map();
  for(const [employeeDateKey, dayHours] of dailyMaxHours.entries()) {
    const [employeeId, dayIso]=employeeDateKey.split('|');
    const weekIdx=Math.floor((ordinalFromIso(dayIso) - startOrdinal) / 7) + 1;
    const weekKey=`${employeeId}|${weekIdx}`;
    weeklyHours.set(weekKey, (weeklyHours.get(weekKey)||0) + dayHours);
  }

  const requestedDaysOffByWeek=new Map();
  for(const entry of (payload.unavailability||[])) {
    const dayIso=entry?.date;
    const employeeId=entry?.employee_id;
    if(!dayIso || !employeeId || !allDateSet.has(dayIso)) continue;
    const dayKey=dayKeyForDate(parseDate(dayIso));
    if(!openWeekdays.has(dayKey)) continue;
    const weekIdx=Math.floor((ordinalFromIso(dayIso) - startOrdinal) / 7) + 1;
    const key=`${employeeId}|${weekIdx}`;
    requestedDaysOffByWeek.set(key, (requestedDaysOffByWeek.get(key)||0) + 1);
  }

  const violations=[];
  for(const dIso of allDates) {
    const dayKey=dayKeyForDate(parseDate(dIso));
    const storeOpen=openWeekdays.has(dayKey);

    if(storeOpen) {
      const needed=(isWeekendIso(dIso) ? Number(payload.coverage?.greystones_weekend_staff||0) : Number(payload.coverage?.greystones_weekday_staff||0)) + Number(extrasByDate.get(dIso)||0);
      const floorAssigned=Number(floorByDate.get(dIso)||0);
      if(floorAssigned < needed) {
        violations.push({date:dIso, type:'coverage_gap', detail:`Greystones needed ${needed}`});
      }
      if(Number(captainByDate.get(dIso)||0) < 1) {
        violations.push({date:dIso, type:'role_missing', detail:'Missing Boat Captain'});
      }
    }

    const beachOpen=payload.schedule_beach_shop && storeOpen && isBeachShopOpenDate(dIso, payload.season_rules);
    if(beachOpen) {
      const needed=2;
      const beachAssigned=Number(beachByDate.get(dIso)||0);
      if(beachAssigned < needed) {
        violations.push({date:dIso, type:'beach_shop_gap', detail:`Beach Shop needed ${needed}`});
      }
    }
  }

  for(const ws of weekStartsForPeriod(payload.period)) {
    const weekDays=daterangeIso(ws, 7).filter(d=>allDateSet.has(d));
    for(const managerId of managerIds) {
      if(weekDays.some(d=>!openWeekdays.has(dayKeyForDate(parseDate(d))))) continue;
      const work=weekDays.map(d=>managerWorkByDate.get(d)?.has(managerId) || false);
      const hasPair=work.some((working, idx)=>idx < work.length-1 && !working && !work[idx+1]);
      if(payload.leadership_rules?.manager_two_consecutive_days_off_per_week && !hasPair) {
        violations.push({date:ws, type:'manager_consecutive_days_off', detail:`Manager ${managerNameById.get(managerId)||managerId} lacks consecutive days off`});
      }
      const requestedDaysOff=weekDays.filter(d=>unavail.has(`${managerId}|${d}`)).length;
      const targetDays=Math.max(0, Math.min(5, weekDays.length - requestedDaysOff));
      const actualDays=work.filter(Boolean).length;
      if(actualDays < targetDays) {
        violations.push({date:ws, type:'manager_days_rule', detail:`Manager ${managerNameById.get(managerId)||managerId} scheduled ${actualDays} day(s), minimum is ${targetDays}`});
      }
    }
  }

  const weekStarts=weekStartsForPeriod(payload.period);
  for(let i=0;i<weekStarts.length;i++) {
    const weekIdx=i+1;
    const ws=weekStarts[i];
    for(const employee of employees) {
      const hours=Number((weeklyHours.get(`${employee.id}|${weekIdx}`)||0).toFixed(2));
      const requestedDaysOff=Number(requestedDaysOffByWeek.get(`${employee.id}|${weekIdx}`)||0);
      if(hours < Number(employee.min_hours_per_week||0) && requestedDaysOff===0) {
        violations.push({date:ws, type:'hours_min_violation', detail:`${employee.name} scheduled ${formatHours(hours)}h, minimum is ${employee.min_hours_per_week}h`});
      }
      if(hours > Number(employee.max_hours_per_week||0)) {
        violations.push({date:ws, type:'hours_max_violation', detail:`${employee.name} scheduled ${formatHours(hours)}h, maximum is ${employee.max_hours_per_week}h`});
      }
    }
  }

  violations.sort((a,b)=>{
    if(a.date!==b.date) return a.date.localeCompare(b.date);
    if(a.type!==b.type) return a.type.localeCompare(b.type);
    return a.detail.localeCompare(b.detail);
  });
  return violations;
}

function groupSlots(assignments) {
  const byDate={};
  assignments.forEach(a=>{
    byDate[a.date] ||= { manager:[], leaders:[], clerks:[], captains:[], beachStaff:[] };
    if(a.role==='Store Manager') byDate[a.date].manager.push(a.employee_name);
    if(a.role==='Team Leader' && a.location==='Greystones') byDate[a.date].leaders.push(a.employee_name);
    if(a.role==='Store Clerk' && a.location==='Greystones') byDate[a.date].clerks.push(a.employee_name);
    if(a.role==='Boat Captain') byDate[a.date].captains.push(a.employee_name);
    if((a.role==='Team Leader' || a.role==='Store Clerk') && a.location==='Beach Shop') byDate[a.date].beachStaff.push(a.employee_name);
  });
  return byDate;
}

function allowedRolesForCol(col) {
  return {
    leaders: ['Team Leader'],
    clerks: ['Store Clerk'],
    captains: ['Boat Captain'],
    beachStaff: ['Team Leader','Store Clerk'],
  }[col] || [];
}

function candidateNamesForColumn(date, col) {
  if(col==='manager') return [];
  const allowedRoles=new Set(allowedRolesForCol(col));
  return getEmployeesFromTable()
    .filter(e=>allowedRoles.has(e.role))
    .map(e=>e.name)
    .filter(name=>{
      if(generatedAssignments.some(a=>a.date===date && colFor(a)===col && a.employee_name===name)) return false;
      const scheduledSameDay = generatedAssignments.some(a=>a.date===date && a.employee_name===name);
      if(!scheduledSameDay) return true;
      const hasStoreAssignment = generatedAssignments.some(a=>a.date===date && ['leaders','clerks'].includes(colFor(a)) && a.employee_name===name);
      return col==='beachStaff' && hasStoreAssignment;
    })
    .sort((a,b)=>a.localeCompare(b));
}

function renderAddControl(date, col) {
  if(col==='manager') return '';
  const names = candidateNamesForColumn(date, col);
  const options = names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
  return `<button type='button' class='zone-add' onclick='toggleAddInput(this)'>+</button><div class='zone-add-row' style='display:none;'><select class='zone-add-select' onchange='handleAddBySelect(event,"${date}","${col}")'><option value=''>Select employee</option>${options}</select></div>`;
}

function renderPills(names, date, col) {
  const pills = names.length ? names.map((n,idx)=>`<div class='pill' draggable='true' data-name='${n}' data-date='${date}' data-col='${col}' ondragstart='dragStart(event)'><span>${n}</span><button class='pill-remove' type='button' onclick='removeScheduled("${date}","${col}","${n.replace(/"/g,'&quot;')}")'>×</button></div>`).join('') : '<span class="muted">—</span>';
  return `${pills}${renderAddControl(date, col)}`;
}

function renderSchedule(assignments, editable=true, plain=false, showBeachShop=true) {
  const byDate=groupSlots(assignments);
  const dates=Object.keys(byDate).sort();
  const dropAttrs = editable ? "ondragover='allowDrop(event)' ondrop='dropPill(event)' ondragleave='handleDropzoneLeave(event)'" : "";
  const beachHeader = showBeachShop ? '<th>Beach Shop</th>' : '';
  const colgroup = showBeachShop
    ? '<colgroup><col style="width:22%"><col style="width:14%"><col style="width:14%"><col style="width:25%"><col style="width:11%"><col style="width:14%"></colgroup>'
    : '<colgroup><col style="width:24%"><col style="width:16%"><col style="width:16%"><col style="width:28%"><col style="width:16%"></colgroup>';
  return `<table class='schedule-table'>${colgroup}<thead><tr><th>Date</th><th>Manager</th><th>Team Leaders</th><th>Clerks</th><th>Captain</th>${beachHeader}</tr></thead><tbody>${dates.map(d=>{
    const day=byDate[d];
    const dateLabel=fmtDateWithDay(d);
    const manager = editable ? renderPills(day.manager,d,'manager') : renderPillsStatic(day.manager, plain);
    const leaders = editable ? renderPills(day.leaders,d,'leaders') : renderPillsStatic(day.leaders, plain);
    const clerks = editable ? renderPills(day.clerks,d,'clerks') : renderPillsStatic(day.clerks, plain);
    const captains = editable ? renderPills(day.captains,d,'captains') : renderPillsStatic(day.captains, plain);
    const beachStaff = editable ? renderPills(day.beachStaff,d,'beachStaff') : renderPillsStatic(day.beachStaff, true);
    const beachCell = showBeachShop ? `<td><div class='dropzone' data-date='${d}' data-col='beachStaff' ${dropAttrs}>${beachStaff}</div></td>` : '';
    return `<tr><td><strong>${dateLabel}</strong></td><td><div class='dropzone' data-date='${d}' data-col='manager' ${dropAttrs}>${manager}</div></td><td><div class='dropzone' data-date='${d}' data-col='leaders' ${dropAttrs}>${leaders}</div></td><td><div class='dropzone' data-date='${d}' data-col='clerks' ${dropAttrs}>${clerks}</div></td><td><div class='dropzone' data-date='${d}' data-col='captains' ${dropAttrs}>${captains}</div></td>${beachCell}</tr>`;
  }).join('')}</tbody></table>`;
}

function renderPillsStatic(names, plain=false) {
  if(!names.length) return '<span class="muted">—</span>';
  if(plain) return names.join(', ');
  return names.map(n=>`<div class='pill'>${n}</div>`).join('');
}

function buildSummary(assignments, period=null) {
  const startDay = period?.week_start_day || weekStartDay();
  const endDay = period?.week_end_day || weekEndDay();
  const dayEntries={};
  assignments.forEach(a=>{
    const day=parseDate(a.date);
    const ws=iso(weekStartForDate(day, startDay));
    const key=`${ws}|${a.employee_name}|${a.date}`;
    dayEntries[key] ||= { ws, name:a.employee_name, hasNonBeach:false, hasBeach:false, maxHours:0 };
    if(a.location==='Beach Shop') dayEntries[key].hasBeach=true;
    else dayEntries[key].hasNonBeach=true;
    dayEntries[key].maxHours = Math.max(dayEntries[key].maxHours, calcShiftHours(a.start, a.end));
  });
  const byWeek={};
  Object.values(dayEntries).forEach(entry=>{
    const ws=entry.ws;
    const key=`${ws}|${entry.name}`;
    byWeek[ws] ||= {};
    byWeek[ws][key] ||= {name:entry.name,days:0,hours:0};
    byWeek[ws][key].days += (entry.hasNonBeach ? 1 : 0.5);
    byWeek[ws][key].hours += entry.maxHours;
  });
  const weeks=Object.keys(byWeek).sort();
  if(!weeks.length) return '<p class="muted">No summary data.</p>';
  return `<h4 class='week-title'>Weekly Summary (${weekdayLabel(startDay)}-${weekdayLabel(endDay)})</h4>${weeks.map(week=>{
    const names=Object.values(byWeek[week]).sort((a,b)=>a.name.localeCompare(b.name));
    return `<h5 class='week-title'>Week of ${fmtDate(week)}</h5><table><thead><tr><th>Employee</th><th>Days Worked</th><th>Hours Worked</th></tr></thead><tbody>${names.map(r=>`<tr><td>${r.name}</td><td>${r.days.toFixed(1)}</td><td>${r.hours.toFixed(1)}</td></tr>`).join('')}</tbody></table>`;
  }).join('')}`;
}

function roleForName(name) { return getEmployeesFromTable().find(e=>e.name===name)?.role || ''; }
function colForRole(role) { return {'Store Manager':'manager','Team Leader':'leaders','Store Clerk':'clerks','Boat Captain':'captains'}[role] || ''; }
function removeScheduled(date, col, name, rerender=true) {
  const idx=generatedAssignments.findIndex(a=>a.date===date && colFor(a)===col && a.employee_name===name);
  if(idx>=0) { generatedAssignments.splice(idx,1); if(rerender) rerenderOutput(); }
}
function colFor(a) { if(a.role==='Store Manager') return 'manager'; if(a.role==='Team Leader'&&a.location==='Greystones') return 'leaders'; if(a.role==='Store Clerk'&&a.location==='Greystones') return 'clerks'; if(a.role==='Boat Captain') return 'captains'; if((a.role==='Team Leader'||a.role==='Store Clerk')&&a.location==='Beach Shop') return 'beachStaff'; return ''; }

function allowedColsForRole(role) {
  const baseCol=colForRole(role);
  if(baseCol==='leaders') return ['leaders','beachStaff'];
  if(baseCol==='clerks') return ['clerks','beachStaff'];
  return [baseCol];
}
function evaluateDropTarget(data, toDate, toCol) {
  if(!toDate || !toCol) return {ok:false, message:'That target cannot accept assignments.'};

  const employeeRole=roleForName(data.name);
  const allowedCols=allowedColsForRole(employeeRole);
  if(!allowedCols.includes(toCol)) {
    return {ok:false, message:`${data.name} can only be placed in an allowed column for their role.`};
  }

  const alreadyInTarget=generatedAssignments.some(a=>a.date===toDate && colFor(a)===toCol && a.employee_name===data.name);
  if(alreadyInTarget) {
    return {ok:false, message:`${data.name} is already in that column on ${fmtDate(toDate)}.`};
  }

  const alreadyScheduledThatDay=generatedAssignments.some(a=>a.date===toDate && a.employee_name===data.name);
  const hasStoreAssignmentThatDay=generatedAssignments.some(a=>a.date===toDate && ['leaders','clerks'].includes(colFor(a)) && a.employee_name===data.name);
  const allowStoreAndBeachDualPlacement=toCol==='beachStaff' && hasStoreAssignmentThatDay;
  if(alreadyScheduledThatDay && !allowStoreAndBeachDualPlacement) {
    return {ok:false, message:`${data.name} is already scheduled on ${fmtDate(toDate)}.`};
  }

  const roleMap={manager:'Store Manager', leaders:'Team Leader', clerks:'Store Clerk', captains:'Boat Captain'};
  const targetRole=toCol==='beachStaff' ? employeeRole : roleMap[toCol];
  if(toCol==='beachStaff' && !['Team Leader', 'Store Clerk'].includes(targetRole)) {
    return {ok:false, message:'Beach Shop only allows Team Leaders or Store Clerks.'};
  }

  return {ok:true, role:targetRole};
}
function resetDropzoneHighlights() {
  document.querySelectorAll('.dropzone').forEach(zone=>{
    zone.classList.remove('dropzone--active', 'dropzone--valid', 'dropzone--invalid');
  });
}
function clearDragState() {
  activeDragData=null;
  document.querySelectorAll('.pill--dragging').forEach(p=>p.classList.remove('pill--dragging'));
  resetDropzoneHighlights();
}
function handleDropzoneLeave(ev) {
  const zone=ev.currentTarget;
  if(!zone) return;
  if(ev.relatedTarget && zone.contains(ev.relatedTarget)) return;
  zone.classList.remove('dropzone--active', 'dropzone--valid', 'dropzone--invalid');
}
function dragStart(ev) {
  const pill=ev.target.closest('.pill');
  if(!pill) return;
  const data={name:pill.dataset.name, fromDate:pill.dataset.date||'', fromCol:pill.dataset.col||''};
  activeDragData=data;
  pill.classList.add('pill--dragging');
  ev.dataTransfer.setData('text/plain', JSON.stringify(data));
  ev.dataTransfer.effectAllowed='move';
}
function allowDrop(ev) {
  ev.preventDefault();
  const zone=ev.currentTarget;
  if(!zone) return;
  zone.classList.add('dropzone--active');
  if(!activeDragData || !generatedAssignments.length) {
    zone.classList.remove('dropzone--valid', 'dropzone--invalid');
    return;
  }
  const evaluation=evaluateDropTarget(activeDragData, zone.dataset.date, zone.dataset.col);
  zone.classList.toggle('dropzone--valid', evaluation.ok);
  zone.classList.toggle('dropzone--invalid', !evaluation.ok);
}
function autoScrollOnDrag(ev) {
  const margin=90;
  const speed=18;
  if(ev.clientY < margin) window.scrollBy(0, -speed);
  else if(window.innerHeight - ev.clientY < margin) window.scrollBy(0, speed);
}
function dropPill(ev) {
  ev.preventDefault();
  const raw=ev.dataTransfer?.getData('text/plain');
  const data=raw ? JSON.parse(raw) : activeDragData;
  if(!data) return;
  const target=ev.currentTarget;
  const toDate=target.dataset.date;
  const toCol=target.dataset.col;
  if(!generatedAssignments.length) { clearDragState(); return; }

  const evaluation=evaluateDropTarget(data, toDate, toCol);
  if(!evaluation.ok) {
    showMessage(evaluation.message, 'warn');
    showToast(evaluation.message, 'warn', 2300);
    clearDragState();
    return;
  }

  const isStoreToBeachCopy = data.fromDate===toDate && ['leaders','clerks'].includes(data.fromCol) && toCol==='beachStaff';
  if(data.fromDate && data.fromCol && !isStoreToBeachCopy) {
    removeScheduled(data.fromDate, data.fromCol, data.name, false);
  }

  const role=evaluation.role;
  const loc= toCol==='captains' ? 'Boat' : (toCol.startsWith('beach') ? 'Beach Shop' : 'Greystones');
  const employee=getEmployeesFromTable().find(e=>e.name===data.name);
  const hours=(currentDraftPayload?.hours || SAMPLE_PAYLOAD.hours);
  const start = loc==='Beach Shop' ? hours.beach_shop.start : hours.greystones.start;
  const end = loc==='Beach Shop' ? hours.beach_shop.end : hours.greystones.end;
  generatedAssignments.push({date:toDate,location:loc,start,end,employee_id:(employee?.id || slugifyName(data.name,0)),employee_name:data.name,role});
  rerenderOutput();
  clearDragState();
}

function toggleAddInput(btn) {
  const row=btn.nextElementSibling;
  if(!row) return;
  row.style.display = row.style.display==='none' ? 'flex' : 'none';
  if(row.style.display==='flex') row.querySelector('select')?.focus();
}

function handleAddBySelect(ev, date, col) {
  const name=(ev.target.value||'').trim();
  if(!name) return;
  const target=document.querySelector(`.dropzone[data-date='${date}'][data-col='${col}']`);
  if(!target) return;
  const mock={dataTransfer:{getData:()=>JSON.stringify({name,fromDate:'',fromCol:''})},currentTarget:target,preventDefault:()=>{}};
  dropPill(mock);
  ev.target.value='';
  const row=ev.target.closest('.zone-add-row');
  if(row) row.style.display='none';
}

async function finalizeSchedule() {
  if(!isAdmin) {
    showToast('Only admins can finalize and save schedules.', 'warn');
    return;
  }
  if(!generatedAssignments.length || !currentDraftPeriod) return;
  const ok=await openDecisionModal({
    title:'Finalize Schedule',
    body:'This saves the current draft to shared previous schedules and clears the editable board.',
    confirmLabel:'Finalize',
    cancelLabel:'Keep Editing',
    confirmTone:'danger',
    showCancel:true,
  });
  if(!ok) return;
  let created;
  try {
    created=await persistCurrentScheduleToDb();
    if(!created?.id) throw new Error('Database did not return a saved schedule id.');
  } catch (err) {
    showMessage(err.message || 'Finalize failed because the shared schedule could not be saved.', 'danger');
    showToast(err.message || 'Finalize failed because save to shared schedules did not complete.', 'danger', 4200);
    return;
  }
  generatedAssignments=[];
  currentDraftPeriod=null;
  currentDraftPayload=null;
  liveViolations=[];
  lastResponse=null;
  clearSavedScheduleBanner();
  rerenderOutput();
  showMessage('Schedule finalized and saved to shared previous schedules.', 'success');
  const generatePdfNow=await openDecisionModal({
    title:'Export PDF Now?',
    body:'Your schedule is finalized. Would you like to generate the PDF now, or export it later from Previous schedules?',
    confirmLabel:'Generate PDF Now',
    cancelLabel:'Later',
    confirmTone:'primary',
    showCancel:true,
  });
  if(generatePdfNow) {
    await exportSavedSchedulePdfById(created.id);
    showToast('Opening PDF export for the finalized schedule.', 'success');
  } else {
    showToast('Schedule finalized. You can export the PDF any time from Previous schedules.', 'info');
  }
}

function exportSchedulePdfItem(item) {
  if(!item) return;
  const showBeach = !!item.period?.schedule_beach_shop || item.assignments.some(a=>a.location==='Beach Shop');
  const startIso=item.period?.start_date || iso(new Date());
  const nextWeekStart=parseDate(startIso);
  nextWeekStart.setDate(nextWeekStart.getDate() + 7);
  const starts=weekStartsForPeriod(item.period||{}).map(fmtDate);
  const firstWeek=starts[0] || fmtDate(startIso);
  const secondWeek=starts[1] || fmtDate(iso(nextWeekStart));
  const exportTitle=`FOBE Schedule for the weeks ${firstWeek} and ${secondWeek}`;
  const html=`<html><head><meta charset='utf-8'><title>${exportTitle}</title><style>@page{size:A4 landscape;margin:8mm}html,body{margin:0;padding:0}body{font-family:'Segoe UI',Tahoma,Arial,sans-serif;color:#0f172a;background:#fff}.sheet{width:100%}.report-header{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;border-bottom:2px solid #3F4727;padding-bottom:8px;margin-bottom:10px}.report-brand{display:flex;align-items:center}.report-brand img{height:42px;width:auto}.report-meta{font-size:11px;color:#475569;white-space:nowrap}.report-title{margin:0 0 10px 0;font-family:'Barlow Condensed','Arial Narrow','Segoe UI',sans-serif;font-size:24px;line-height:1.1;letter-spacing:.3px;color:#243223}table{width:100%;border-collapse:collapse;table-layout:fixed;font-size:11px}th,td{border:1px solid #cbd5e1;padding:6px;text-align:left;vertical-align:top;word-break:break-word}th{background:#e2e8f0;color:#334155;text-transform:uppercase;letter-spacing:.3px;font-size:10px}.muted{color:#64748b}</style></head><body><div class='sheet'><div class='report-header'><div class='report-brand'><img src='/static/brand/logo-full.svg' alt='FOBE logo'></div><div class='report-meta'>Generated ${new Date().toLocaleDateString()}</div></div><h1 class='report-title'>${exportTitle}</h1>${renderSchedule(item.assignments, false, true, showBeach)}</div></body></html>`;
  const win=window.open('', '_blank');
  if(!win) return;
  win.document.write(html);
  win.document.close();
  win.onload=()=>{ win.focus(); win.print(); };
}

function rerenderOutput() {
  if(currentDraftPeriod && !activeSavedScheduleMeta) refreshCurrentDraftPayload();
  const savedSnapshotMatchesCurrent = !!activeSavedScheduleMeta && Array.isArray(lastResponse?.assignments) && JSON.stringify(lastResponse.assignments) === JSON.stringify(generatedAssignments);
  const violations = savedSnapshotMatchesCurrent && Array.isArray(lastResponse?.violations)
    ? lastResponse.violations
    : (currentDraftPayload ? computeLiveViolations(generatedAssignments, currentDraftPayload) : (lastResponse?.violations || []));
  liveViolations = violations;
  document.getElementById('result').innerHTML = (generatedAssignments.length ? renderSchedule(generatedAssignments, true, false, usesBeachShop(currentDraftPeriod)) + buildSummary(generatedAssignments, currentDraftPeriod) : "<p class='muted'>Generate to view schedule.</p>") + (violations.length?`<h4>Rule checks</h4><ul>${violations.map(v=>`<li>${v.date}: ${v.detail}</li>`).join('')}</ul>`:'<p>No violations.</p>');
  document.getElementById('finalize_btn').disabled = !generatedAssignments.length || !isAdmin;
}

async function runGenerate() {
  const nextToken = rerollCounter + 1;
  const payload=collectPayload(nextToken);
  const shortageDates=weekendLeaderShortageDates(payload);
  if(shortageDates.length) {
    const shortageList=shortageDates.map(fmtDateWithDay).join(', ');
    const ok = await openDecisionModal({
      title:'Potential Weekend Coverage Shortage',
      body:`Only one team leader is available on ${shortageList}. Continue with generation anyway?`,
      confirmLabel:'Proceed',
      cancelLabel:'Stop Generation',
      confirmTone:'danger',
      showCancel:true,
    });
    if(!ok) {
      showMessage('Generation cancelled. Update days off or staffing, then generate again.', 'warn');
      showToast('Generation cancelled before API call.', 'warn');
      return;
    }
  }
  rerollCounter = nextToken;
  let json;
  try {
    json=await apiFetch('/generate', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  } catch (err) {
    if(err.status===401) {
      await handleLogout();
      showMessage('Session expired. Please log in again.', 'warn');
      return;
    }
    showMessage(err.message || 'Generate failed', 'danger');
    showToast(err.message || 'Generate failed', 'danger', 3600);
    return;
  }
  lastResponse=json;
  currentDraftPayload=payload;
  currentDraftPeriod={...payload.period, week_start_day: payload.week_start_day, week_end_day: payload.week_end_day, schedule_beach_shop: payload.schedule_beach_shop};
  generatedAssignments=[...json.assignments];
  clearSavedScheduleBanner();
  rerenderOutput();
  const beachViolations=liveViolations.filter(v=>v.type==='beach_shop_gap');
  if(beachViolations.length) {
    await openDecisionModal({
      title:'Beach Shop Rule Violation',
      body:'Beach Shop must have exactly 2 people whenever it is open. Adjust staffing parameters before finalizing.',
      confirmLabel:'Review',
      confirmTone:'danger',
      showCancel:false,
    });
  }
  showMessage(`Generated ${json.assignments.length} assignments. Review and finalize to save.`, 'success');
  showToast(`Generated ${json.assignments.length} assignments.`, 'success');
}

function adminUserRowHtml(user) {
  return `<div class='admin-user-row' data-user-id='${user.id}'><span>${esc(user.email)}</span><select class='admin-user-role'><option value='user' ${user.role==='user'?'selected':''}>user</option><option value='admin' ${user.role==='admin'?'selected':''}>admin</option></select><label><input type='checkbox' class='admin-user-active' ${user.is_active?'checked':''}> active</label><input type='password' class='admin-user-password' placeholder='Optional new temporary password'><button type='button' onclick='saveAdminUser(${user.id})'>Save</button></div>`;
}

function renderAdminUsers(users=[]) {
  const wrap=document.getElementById('admin_users_rows');
  wrap.innerHTML = users.map(adminUserRowHtml).join('') || "<p class='muted'>No users found.</p>";
}

async function loadAdminUsers() {
  if(!isAdmin) return;
  try {
    const users=await apiFetch('/api/admin/users');
    renderAdminUsers(users);
  } catch (err) {
    showToast(err.message || 'Failed to load users.', 'danger');
  }
}

async function createAdminUser(ev) {
  ev.preventDefault();
  if(!isAdmin) return;
  const email=document.getElementById('admin_new_email').value.trim();
  const temporary_password=document.getElementById('admin_new_password').value;
  const role=document.getElementById('admin_new_role').value;
  try {
    await apiFetch('/api/admin/users', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,temporary_password,role}),
    });
    document.getElementById('admin_create_user_form').reset();
    await loadAdminUsers();
    showToast('User created.', 'success');
  } catch (err) {
    showToast(err.message || 'Failed to create user.', 'danger');
  }
}

async function saveAdminUser(userId) {
  if(!isAdmin) return;
  const row=document.querySelector(`.admin-user-row[data-user-id='${userId}']`);
  if(!row) return;
  const role=row.querySelector('.admin-user-role')?.value;
  const is_active=!!row.querySelector('.admin-user-active')?.checked;
  const temporary_password=(row.querySelector('.admin-user-password')?.value || '').trim();
  const payload={role,is_active};
  if(temporary_password) payload.temporary_password=temporary_password;
  try {
    await apiFetch(`/api/admin/users/${userId}`, {
      method:'PATCH',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload),
    });
    await loadAdminUsers();
    showToast('User updated.', 'success');
  } catch (err) {
    showToast(err.message || 'Failed to update user.', 'danger');
  }
}

function loadSampleData() {
  clearSavedScheduleBanner();
  renderRosterRows([]);
  document.getElementById('extra_rows').innerHTML='';
  (SAMPLE_PAYLOAD.extra_coverage_days||[]).forEach(addExtraRow);
  document.getElementById('time_off_rows').innerHTML='';
  (SAMPLE_PAYLOAD.unavailability||[]).forEach(addTimeOffRow);
  const weekStartEl=document.getElementById('week_start_day');
  weekStartEl.innerHTML = DAY_KEYS.map(day=>`<option value='${day}'>${weekdayLabel(day)}</option>`).join('');
  weekStartEl.value = SAMPLE_PAYLOAD.week_start_day || 'sun';
  const startInput=document.getElementById('period_start');
  startInput.value = iso(nextOrSameWeekday(new Date(), weekStartDay()));
  alignPeriodStartToBoundary();
  document.getElementById('period_weeks').value = SAMPLE_PAYLOAD.period.weeks;
  document.getElementById('schedule_beach_shop').checked = !!SAMPLE_PAYLOAD.schedule_beach_shop;
  updateWeekBoundaryNote();
  renderOpenDaySelectors();
}

async function initializeAuthenticatedApp() {
  const authenticated=await fetchCurrentUser();
  if(!authenticated) return;
  loadSampleData();
  try {
    await loadRosterFromApi();
  } catch (err) {
    if(err.status===401) {
      await handleLogout();
      showMessage('Session expired. Please log in again.', 'warn');
      return;
    }
    showMessage(err.message || 'Failed to load roster.', 'danger');
    showToast(err.message || 'Failed to load roster.', 'danger');
    return;
  }
  try {
    await loadSavedSchedules();
  } catch (err) {
    showToast(err.message || 'Failed to load saved schedules.', 'danger');
  }
  applyRolePermissions();
  if(isAdmin) await loadAdminUsers();
  else renderAdminUsers([]);
  rerenderOutput();
}

document.getElementById('employee_rows').addEventListener('input', ()=>{ syncOverrides(); });
document.getElementById('period_start').addEventListener('change', ()=>{ alignPeriodStartToBoundary(); renderOpenDaySelectors(); });
document.getElementById('period_weeks').addEventListener('change', renderOpenDaySelectors);
document.getElementById('week_start_day').addEventListener('change', handleWeekBoundaryChange);
document.getElementById('login_form').addEventListener('submit', handleLoginSubmit);
document.getElementById('bootstrap_form').addEventListener('submit', handleBootstrapSubmit);
document.getElementById('logout_btn').addEventListener('click', handleLogout);
document.getElementById('admin_create_user_form').addEventListener('submit', createAdminUser);
document.getElementById('refresh_history_btn').addEventListener('click', ()=>loadSavedSchedules().catch(err=>showToast(err.message || 'Failed to load saved schedules.', 'danger')));
document.addEventListener('change', (ev)=>{
  if(ev.target?.classList?.contains('open-day')) syncOpenDayChipStates();
  if(ev.target?.classList?.contains('extra-date')) {
    applyScheduleWindowToDateInputs();
    rerenderOutput();
  }
  if(ev.target?.classList?.contains('to-emp') || ev.target?.classList?.contains('to-date')) {
    refreshTimeOffDateOptions({notify:true});
    rerenderOutput();
  }
});
document.addEventListener('dragover', autoScrollOnDrag);
document.addEventListener('dragend', clearDragState);
wireModalEvents();
loadSampleData();
initializeAuthenticatedApp();
</script>
</body>
</html>
