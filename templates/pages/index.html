<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<title>FOBE Scheduler (local)</title>
<style>
  body { font-family: Inter, system-ui, sans-serif; margin:0; background:#f1f5f9; color:#0f172a; }
  .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
  .card { background:#fff; border:1px solid #cbd5e1; border-radius:12px; padding:1rem; margin-bottom:1rem; }
  table { width:100%; border-collapse: collapse; }
  th, td { border:1px solid #cbd5e1; padding:.45rem; text-align:center; vertical-align:top; }
  th { background:#e2e8f0; }
  input, select, button { padding:.35rem; border:1px solid #94a3b8; border-radius:6px; }
  .toolbar { display:flex; flex-wrap:wrap; gap:.5rem; margin-bottom:1rem; align-items:center; }
  .muted { color:#475569; font-size:.9rem; }
  .dropzone { min-height:58px; display:flex; flex-wrap:wrap; gap:.35rem; justify-content:center; align-content:flex-start; position:relative; padding-top:.2rem; }
  .pill { background:#dbeafe; border:1px solid #60a5fa; border-radius:999px; padding:.2rem .5rem; cursor:grab; user-select:none; display:inline-flex; align-items:center; gap:.3rem; line-height:1.2; }
  .pill .pill-remove { width:16px; height:16px; border-radius:3px; padding:0; display:inline-flex; align-items:center; justify-content:center; font-size:13px; line-height:1; }
  .zone-add-row { width:100%; display:flex; justify-content:center; margin-top:.1rem; }
  .zone-add-input { width:92%; font-size:.8rem; padding:.2rem .35rem; }
  .repo { display:flex; flex-wrap:wrap; gap:.4rem; min-height:46px; padding:.5rem; border:1px dashed #94a3b8; border-radius:8px; }
  .week-title { margin:.2rem 0 .6rem; }
  .weekday-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:.35rem .75rem; margin-top:.5rem; }
</style>
</head>
<body>
<div class='container'>
  <h1>FOBE Schedule Builder (local)</h1>
  <p id='feedback' class='muted'></p>

  <section class='card'>
    <h3>Scheduling Period</h3>
    <div class='toolbar'>
      <label>Start Date <input id='period_start' type='date'></label>
      <label>Weeks <input id='period_weeks' type='number' min='1' max='8' value='2'></label>
      <label>Week Starts <select id='week_start_day'></select></label>
      <label><input id='schedule_beach_shop' type='checkbox' onchange='syncOverrides()'> Schedule Beach Shop</label>
    </div>
    <p id='week_boundary_note' class='muted'></p>
    <div>
      <p class='muted'>Open days for this run (uncheck store-closed days):</p>
      <div id='open_day_rows' class='weekday-grid'></div>
    </div>
  </section>

  <section class='card'>
    <h3>Priority Glossary</h3>
    <ul>
      <li><strong>Priority A:</strong> Core staff with strongest preference for coverage.</li>
      <li><strong>Priority B:</strong> Standard staffing priority.</li>
      <li><strong>Priority C:</strong> Lowest assignment priority unless needed for coverage.</li>
    </ul>
  </section>

  <section class='card'>
    <h3>Employees (Persistent Roster)</h3>
    <p class='muted'>This roster persists from schedule to schedule using local storage. Set default role and default min/max weekly hours.</p>
    <button onclick='addEmployeeRow()'>Add Employee</button>
    <table style='margin-top:.5rem'>
      <thead><tr><th>Name</th><th>Role</th><th>Default Min Hrs</th><th>Default Max Hrs</th><th>Priority</th><th></th></tr></thead>
      <tbody id='employee_rows'></tbody>
    </table>
  </section>

  <section class='card'>
    <h3>Days Off Requested</h3>
    <button onclick='addTimeOffRow()'>Add Requested Day Off</button>
    <table style='margin-top:.5rem'>
      <thead><tr><th>Employee</th><th>Date</th><th>Reason</th><th></th></tr></thead>
      <tbody id='time_off_rows'></tbody>
    </table>
  </section>

  <section class='card'>
    <h3>Extra Coverage Days</h3>
    <button onclick='addExtraRow()'>Add Extra Day</button>
    <table style='margin-top:.5rem'>
      <thead><tr><th>Date</th><th>Extra People</th><th></th></tr></thead>
      <tbody id='extra_rows'></tbody>
    </table>
  </section>

  <section class='card'>
    <h3>Employee Repository (Drag from here into daily columns)</h3>
    <div id='repo' class='repo'></div>
  </section>

  <section class='card'>
    <h3>Newly Generated Schedule</h3>
    <div class='toolbar'>
      <button onclick='runGenerate()'>Generate Schedule</button>
      <button onclick='recalculateHours()'>Recalculate Hours</button>
      <button id='finalize_btn' onclick='finalizeSchedule()' disabled>Finalize Schedule</button>
    </div>
    <div id='result'>Generate to view schedule.</div>
  </section>

  <section class='card'>
    <h3>Existing Previous Schedules</h3>
    <div class='toolbar'>
      <button onclick='clearHistory()'>Clear Previous Schedules</button>
    </div>
    <div id='history'>No saved schedules yet.</div>
  </section>
</div>

<script>
const ROLE_OPTIONS = ['Store Clerk','Team Leader','Store Manager','Boat Captain'];
const DAY_KEYS = ['mon','tue','wed','thu','fri','sat','sun'];
const DAY_LABELS = {mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday',sun:'Sunday'};
const KEY_TO_JS_DAY = {sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6};
const SAMPLE_PAYLOAD = {{ payload_json | safe }};
const STORAGE_EMP='fobe_employees_v1';
const STORAGE_HIST='fobe_schedule_history_v1';
let generatedAssignments=[];
let lastResponse=null;
let currentDraftPeriod=null;
let rerollCounter=0;

function showMessage(msg) { document.getElementById('feedback').textContent = msg; }
function slugifyName(name, idx) { return name.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'') || `emp_${idx+1}`; }
function parseDate(s) { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function fmtDate(s) { return new Date(s+'T00:00:00').toLocaleDateString(); }
function fmtDateWithDay(s) { return new Date(s+'T00:00:00').toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'short', day:'numeric' }); }
function iso(d) { return d.toISOString().slice(0,10); }
function weekdayLabel(key) { return DAY_LABELS[key] || key; }
function previousDayKey(key) { const idx=DAY_KEYS.indexOf(key); return DAY_KEYS[(idx+6)%7]; }
function keyToJsDay(key) { return KEY_TO_JS_DAY[key] ?? 0; }
function weekStartDay() { return document.getElementById('week_start_day')?.value || 'sun'; }
function weekEndDay() { return previousDayKey(weekStartDay()); }
function nextOrSameWeekday(d, dayKey) { const x=new Date(d); const delta=(keyToJsDay(dayKey)-x.getDay()+7)%7; x.setDate(x.getDate()+delta); return x; }
function weekStartForDate(d, dayKey) { const x=new Date(d); const delta=(x.getDay()-keyToJsDay(dayKey)+7)%7; x.setDate(x.getDate()-delta); return x; }
function usesBeachShop(period=null) {
  if(period && typeof period.schedule_beach_shop === 'boolean') return period.schedule_beach_shop;
  return !!document.getElementById('schedule_beach_shop')?.checked;
}
function firstMonday(year, monthIndex) { const d=new Date(year, monthIndex, 1); while(d.getDay()!==1) d.setDate(d.getDate()+1); return d; }
function victoriaDay(year) { const d=new Date(year, 4, 24); while(d.getDay()!==1) d.setDate(d.getDate()-1); return d; }
function seasonRulesForYear(year) {
  return {
    victoria_day: iso(victoriaDay(year)),
    june_30: iso(new Date(year, 5, 30)),
    labour_day: iso(firstMonday(year, 8)),
    oct_31: iso(new Date(year, 9, 31)),
  };
}

function roleCounts() {
  const roles=[...document.querySelectorAll('.emp-role')].map(s=>s.value);
  return { manager: roles.filter(r=>r==='Store Manager').length, lead: roles.filter(r=>r==='Team Leader').length };
}
function refreshRoleOptions() {
  const c=roleCounts();
  document.querySelectorAll('.emp-role').forEach(sel=>{
    const current=sel.value;
    sel.innerHTML = ROLE_OPTIONS.map(r=>{
      const disabled = (r==='Store Manager' && c.manager>=1 && current!=='Store Manager') || (r==='Team Leader' && c.lead>=2 && current!=='Team Leader');
      return `<option value="${r}" ${current===r?'selected':''} ${disabled?'disabled':''}>${r}</option>`;
    }).join('');
  });
}

function employeeRowHtml(emp={}) {
  return `<tr><td><input class='emp-name' value='${emp.name||''}'></td><td><select class='emp-role' onchange='refreshRoleOptions();syncOverrides()'>${ROLE_OPTIONS.map(r=>`<option value="${r}" ${(emp.role||'Store Clerk')===r?'selected':''}>${r}</option>`).join('')}</select></td><td><input type='number' class='emp-min' value='${emp.min_hours_per_week??16}' onchange='syncOverrides()'></td><td><input type='number' class='emp-max' value='${emp.max_hours_per_week??40}' onchange='syncOverrides()'></td><td><select class='emp-priority'><option value='A' ${emp.priority_tier==='A'?'selected':''}>A</option><option value='B' ${(!emp.priority_tier||emp.priority_tier==='B')?'selected':''}>B</option><option value='C' ${emp.priority_tier==='C'?'selected':''}>C</option></select></td><td><button onclick='this.closest("tr").remove();refreshRoleOptions();syncOverrides();saveEmployees()'>Remove</button></td></tr>`;
}
function addEmployeeRow(emp={}) { document.getElementById('employee_rows').insertAdjacentHTML('beforeend', employeeRowHtml(emp)); refreshRoleOptions(); syncOverrides(); saveEmployees(); renderRepo(); }
function extraRowHtml(row={}) { return `<tr><td><input type='date' class='extra-date' value='${row.date||''}'></td><td><input type='number' min='1' class='extra-people' value='${row.extra_people||1}'></td><td><button onclick='this.closest("tr").remove()'>Remove</button></td></tr>`; }
function addExtraRow(row={}) { document.getElementById('extra_rows').insertAdjacentHTML('beforeend', extraRowHtml(row)); applyScheduleWindowToDateInputs(); }
function timeOffRowHtml(row={}) {
  const employeeOptions=getEmployeesFromTable().map(e=>`<option value='${e.id}' ${row.employee_id===e.id?'selected':''}>${e.name}</option>`).join('');
  return `<tr><td><select class='to-emp'>${employeeOptions}</select></td><td><input type='date' class='to-date' value='${row.date||''}'></td><td><input class='to-reason' value='${row.reason||''}' placeholder='Vacation, appointment, etc.'></td><td><button onclick='this.closest("tr").remove()'>Remove</button></td></tr>`;
}
function addTimeOffRow(row={}) { document.getElementById('time_off_rows').insertAdjacentHTML('beforeend', timeOffRowHtml(row)); applyScheduleWindowToDateInputs(); }
function refreshTimeOffEmployeeOptions() {
  const employees=getEmployeesFromTable();
  const rows=[...document.querySelectorAll('#time_off_rows tr')].map(tr=>({employee_id:tr.querySelector('.to-emp')?.value||'',date:tr.querySelector('.to-date')?.value||'',reason:tr.querySelector('.to-reason')?.value||''}));
  const tbody=document.getElementById('time_off_rows');
  tbody.innerHTML='';
  rows.forEach(r=>{
    const fallback=employees[0]?.id||'';
    const selected=employees.some(e=>e.id===r.employee_id)?r.employee_id:fallback;
    tbody.insertAdjacentHTML('beforeend', timeOffRowHtml({...r,employee_id:selected}));
  });
}

function getEmployeesFromTable() {
  return [...document.querySelectorAll('#employee_rows tr')].map((tr,idx)=>{
    const name=tr.querySelector('.emp-name').value.trim();
    return {id:slugifyName(name,idx),name,role:tr.querySelector('.emp-role').value,min_hours_per_week:Number(tr.querySelector('.emp-min').value||0),max_hours_per_week:Number(tr.querySelector('.emp-max').value||40),priority_tier:tr.querySelector('.emp-priority').value,availability:Object.fromEntries(DAY_KEYS.map(day=>[day,['08:30-17:30']]))};
  }).filter(e=>e.name);
}

function saveEmployees() { localStorage.setItem(STORAGE_EMP, JSON.stringify(getEmployeesFromTable())); }
function loadEmployees() {
  const raw=localStorage.getItem(STORAGE_EMP);
  if(raw) return JSON.parse(raw);
  return SAMPLE_PAYLOAD.employees;
}

function updateWeekBoundaryNote() {
  const note=document.getElementById('week_boundary_note');
  if(!note) return;
  note.innerHTML = `Schedules are grouped and summarized by week from <strong>${weekdayLabel(weekStartDay())}</strong> to <strong>${weekdayLabel(weekEndDay())}</strong>.`;
}

function alignPeriodStartToBoundary() {
  const startInput=document.getElementById('period_start');
  if(!startInput) return;
  const minStart=nextOrSameWeekday(new Date(), weekStartDay());
  const base=startInput.value ? parseDate(startInput.value) : minStart;
  let aligned=nextOrSameWeekday(base, weekStartDay());
  if(aligned < minStart) aligned = minStart;
  startInput.min = iso(minStart);
  startInput.step = '7';
  startInput.value = iso(aligned);
}

function handleWeekBoundaryChange() {
  alignPeriodStartToBoundary();
  updateWeekBoundaryNote();
  renderOpenDaySelectors();
}

function syncOverrides() { refreshTimeOffEmployeeOptions(); rerenderOutput(); }

function scheduleWindowBounds() {
  const startRaw=document.getElementById('period_start')?.value;
  if(!startRaw) return null;
  const weeks=Math.max(1, Number(document.getElementById('period_weeks')?.value||2));
  const startDate=nextOrSameWeekday(parseDate(startRaw), weekStartDay());
  const endDate=new Date(startDate);
  endDate.setDate(endDate.getDate() + (weeks * 7) - 1);
  return { min: iso(startDate), max: iso(endDate) };
}

function applyScheduleWindowToDateInputs() {
  const bounds=scheduleWindowBounds();
  if(!bounds) return;
  document.querySelectorAll('.extra-date, .to-date').forEach(input=>{
    input.min = bounds.min;
    input.max = bounds.max;
    if(input.value && (input.value < bounds.min || input.value > bounds.max)) {
      input.value = '';
    }
  });
}

function recalculateHours() {
  if(!generatedAssignments.length) { showMessage('No generated schedule to recalculate.'); return; }
  rerenderOutput();
  showMessage('Days and hours recalculated from current draft schedule.');
}

function renderOpenDaySelectors() {
  const wrap=document.getElementById('open_day_rows');
  const selected=new Set(getSelectedOpenDays());
  wrap.innerHTML = DAY_KEYS.map(day=>`<label><input type='checkbox' class='open-day' value='${day}' ${selected.has(day)?'checked':''}> ${weekdayLabel(day)}</label>`).join('');
  applyScheduleWindowToDateInputs();
}

function getSelectedOpenDays() {
  const boxes=[...document.querySelectorAll('.open-day')];
  if(!boxes.length) return [...DAY_KEYS];
  return boxes.filter(b=>b.checked).map(b=>b.value);
}

function collectPayload(rerollToken=0) {
  const employees=getEmployeesFromTable();
  const extra_coverage_days=[...document.querySelectorAll('#extra_rows tr')].map(tr=>({date:tr.querySelector('.extra-date').value,extra_people:Number(tr.querySelector('.extra-people').value||1)})).filter(r=>r.date);
  const unavailability=[...document.querySelectorAll('#time_off_rows tr')].map(tr=>({employee_id:tr.querySelector('.to-emp').value,date:tr.querySelector('.to-date').value,reason:tr.querySelector('.to-reason').value.trim()})).filter(r=>r.employee_id && r.date);
  const startInput=document.getElementById('period_start');
  const start=startInput.value;
  const weeks=Number(document.getElementById('period_weeks').value||2);
  const startDate=nextOrSameWeekday(parseDate(start), weekStartDay());
  const alignedStart=iso(startDate);
  if(start!==alignedStart) startInput.value = alignedStart;
  const open_weekdays=getSelectedOpenDays();
  const schedule_beach_shop=document.getElementById('schedule_beach_shop').checked;
  return {...SAMPLE_PAYLOAD, period:{start_date:alignedStart, weeks}, season_rules:seasonRulesForYear(startDate.getFullYear()), employees, extra_coverage_days, unavailability, open_weekdays, week_start_day:weekStartDay(), week_end_day:weekEndDay(), reroll_token: rerollToken, schedule_beach_shop};
}

function calcShiftHours(start, end) {
  const [sh,sm]=start.split(':').map(Number);
  const [eh,em]=end.split(':').map(Number);
  const raw=(eh*60+em-sh*60-sm)/60;
  return Math.max(0, raw - (raw>=6 ? 1 : 0));
}

function groupSlots(assignments) {
  const byDate={};
  assignments.forEach(a=>{
    byDate[a.date] ||= { manager:[], leaders:[], clerks:[], captains:[], beachStaff:[] };
    if(a.role==='Store Manager') byDate[a.date].manager.push(a.employee_name);
    if(a.role==='Team Leader' && a.location==='Greystones') byDate[a.date].leaders.push(a.employee_name);
    if(a.role==='Store Clerk' && a.location==='Greystones') byDate[a.date].clerks.push(a.employee_name);
    if(a.role==='Boat Captain') byDate[a.date].captains.push(a.employee_name);
    if((a.role==='Team Leader' || a.role==='Store Clerk') && a.location==='Beach Shop') byDate[a.date].beachStaff.push(a.employee_name);
  });
  return byDate;
}

function renderPills(names, date, col) {
  const pills = names.length ? names.map((n,idx)=>`<div class='pill' draggable='true' data-name='${n}' data-date='${date}' data-col='${col}' ondragstart='dragStart(event)'><span>${n}</span><button class='pill-remove' type='button' onclick='removeScheduled("${date}","${col}","${n.replace(/"/g,'&quot;')}")'>×</button></div>`).join('') : '<span class="muted">—</span>';
  return `${pills}<button type='button' class='zone-add' onclick='toggleAddInput(this)'>+</button><div class='zone-add-row' style='display:none;'><input class='zone-add-input' placeholder='Type name + Enter' list='employee-name-list' onkeydown='handleAddByName(event,"${date}","${col}")'></div>`;
}

function renderSchedule(assignments, editable=true, plain=false, showBeachShop=true) {
  const byDate=groupSlots(assignments);
  const dates=Object.keys(byDate).sort();
  const dropAttrs = editable ? "ondragover='allowDrop(event)' ondrop='dropPill(event)'" : "";
  const beachHeader = showBeachShop ? '<th>Beach Shop</th>' : '';
  return `<table><thead><tr><th>Date</th><th>Manager</th><th>Team Leaders</th><th>Clerks</th><th>Captain</th>${beachHeader}</tr></thead><tbody>${dates.map(d=>{
    const day=byDate[d];
    const dateLabel=fmtDateWithDay(d);
    const manager = editable ? renderPills(day.manager,d,'manager') : renderPillsStatic(day.manager, plain);
    const leaders = editable ? renderPills(day.leaders,d,'leaders') : renderPillsStatic(day.leaders, plain);
    const clerks = editable ? renderPills(day.clerks,d,'clerks') : renderPillsStatic(day.clerks, plain);
    const captains = editable ? renderPills(day.captains,d,'captains') : renderPillsStatic(day.captains, plain);
    const beachStaff = editable ? renderPills(day.beachStaff,d,'beachStaff') : renderPillsStatic(day.beachStaff, true);
    const beachCell = showBeachShop ? `<td><div class='dropzone' data-date='${d}' data-col='beachStaff' ${dropAttrs}>${beachStaff}</div></td>` : '';
    return `<tr><td><strong>${dateLabel}</strong></td><td><div class='dropzone' data-date='${d}' data-col='manager' ${dropAttrs}>${manager}</div></td><td><div class='dropzone' data-date='${d}' data-col='leaders' ${dropAttrs}>${leaders}</div></td><td><div class='dropzone' data-date='${d}' data-col='clerks' ${dropAttrs}>${clerks}</div></td><td><div class='dropzone' data-date='${d}' data-col='captains' ${dropAttrs}>${captains}</div></td>${beachCell}</tr>`;
  }).join('')}</tbody></table>`;
}

function renderPillsStatic(names, plain=false) {
  if(!names.length) return '<span class="muted">—</span>';
  if(plain) return names.join(', ');
  return names.map(n=>`<div class='pill'>${n}</div>`).join('');
}

function buildSummary(assignments, period=null) {
  const startDay = period?.week_start_day || weekStartDay();
  const endDay = period?.week_end_day || weekEndDay();
  const byWeek={};
  assignments.forEach(a=>{
    const day=parseDate(a.date);
    const ws=iso(weekStartForDate(day, startDay));
    const key=`${ws}|${a.employee_name}`;
    byWeek[ws] ||= {};
    byWeek[ws][key] ||= {name:a.employee_name,days:0,hours:0};
    byWeek[ws][key].days += (a.location==='Beach Shop' ? 0.5 : 1);
    byWeek[ws][key].hours += calcShiftHours(a.start, a.end);
  });
  const weeks=Object.keys(byWeek).sort();
  if(!weeks.length) return '<p class="muted">No summary data.</p>';
  return `<h4 class='week-title'>Weekly Summary (${weekdayLabel(startDay)}-${weekdayLabel(endDay)})</h4>${weeks.map(week=>{
    const names=Object.values(byWeek[week]).sort((a,b)=>a.name.localeCompare(b.name));
    return `<h5 class='week-title'>Week of ${fmtDate(week)}</h5><table><thead><tr><th>Employee</th><th>Days Worked</th><th>Hours Worked</th></tr></thead><tbody>${names.map(r=>`<tr><td>${r.name}</td><td>${r.days.toFixed(1)}</td><td>${r.hours.toFixed(1)}</td></tr>`).join('')}</tbody></table>`;
  }).join('')}`;
}

function renderRepo() {
  const repo=document.getElementById('repo');
  const names=getEmployeesFromTable().map(e=>e.name);
  repo.innerHTML=names.map(n=>`<div class='pill' draggable='true' data-name='${n}' ondragstart='dragStart(event)'>${n}</div>`).join('') || '<span class="muted">Add employees to populate repository.</span>';
  repo.dataset.col='repo';
  repo.ondragover=allowDrop;
  repo.ondrop=dropPill;
}

function roleForName(name) { return getEmployeesFromTable().find(e=>e.name===name)?.role || ''; }
function colForRole(role) { return {'Store Manager':'manager','Team Leader':'leaders','Store Clerk':'clerks','Boat Captain':'captains'}[role] || ''; }
function removeScheduled(date, col, name, rerender=true) {
  const idx=generatedAssignments.findIndex(a=>a.date===date && colFor(a)===col && a.employee_name===name);
  if(idx>=0) { generatedAssignments.splice(idx,1); if(rerender) rerenderOutput(); }
}

function dragStart(ev) {
  const t=ev.target;
  ev.dataTransfer.setData('text/plain', JSON.stringify({name:t.dataset.name, fromDate:t.dataset.date||'', fromCol:t.dataset.col||''}));
}
function allowDrop(ev) { ev.preventDefault(); }
function autoScrollOnDrag(ev) {
  const margin=90;
  const speed=18;
  if(ev.clientY < margin) window.scrollBy(0, -speed);
  else if(window.innerHeight - ev.clientY < margin) window.scrollBy(0, speed);
}
function dropPill(ev) {
  ev.preventDefault();
  const data=JSON.parse(ev.dataTransfer.getData('text/plain'));
  const target=ev.currentTarget;
  const toDate=target.dataset.date;
  const toCol=target.dataset.col;
  if(!generatedAssignments.length) return;

  if(toCol==='repo') {
    if(data.fromDate && data.fromCol) removeScheduled(data.fromDate, data.fromCol, data.name);
    return;
  }

  if(!toDate||!toCol) return;

  const baseCol=colForRole(roleForName(data.name));
  const allowedCols = baseCol==='leaders' ? ['leaders','beachStaff'] : (baseCol==='clerks' ? ['clerks','beachStaff'] : [baseCol]);
  if(!allowedCols.includes(toCol)) {
    showMessage(`${data.name} can only be placed in an allowed column for their role.`);
    return;
  }

  if(data.fromDate && data.fromCol) {
    removeScheduled(data.fromDate, data.fromCol, data.name, false);
  }

  if(generatedAssignments.some(a=>a.date===toDate && a.employee_name===data.name)) {
    showMessage(`${data.name} is already scheduled on ${fmtDate(toDate)}.`);
    return;
  }

  const roleMap={manager:'Store Manager',leaders:'Team Leader',clerks:'Store Clerk',captains:'Boat Captain'};
  const role=toCol==='beachStaff' ? roleForName(data.name) : roleMap[toCol];
  if(toCol==='beachStaff' && !['Team Leader','Store Clerk'].includes(role)) {
    showMessage('Beach Shop only allows Team Leaders or Store Clerks.');
    return;
  }
  const loc= toCol==='captains' ? 'Boat' : (toCol.startsWith('beach') ? 'Beach Shop' : 'Greystones');
  const start = loc==='Beach Shop' ? SAMPLE_PAYLOAD.hours.beach_shop.start : SAMPLE_PAYLOAD.hours.greystones.start;
  const end = loc==='Beach Shop' ? SAMPLE_PAYLOAD.hours.beach_shop.end : SAMPLE_PAYLOAD.hours.greystones.end;
  generatedAssignments.push({date:toDate,location:loc,start,end,employee_id:slugifyName(data.name,0),employee_name:data.name,role});
  rerenderOutput();
}
function colFor(a) { if(a.role==='Store Manager') return 'manager'; if(a.role==='Team Leader'&&a.location==='Greystones') return 'leaders'; if(a.role==='Store Clerk'&&a.location==='Greystones') return 'clerks'; if(a.role==='Boat Captain') return 'captains'; if((a.role==='Team Leader'||a.role==='Store Clerk')&&a.location==='Beach Shop') return 'beachStaff'; return ''; }

function toggleAddInput(btn) {
  const row=btn.nextElementSibling;
  if(!row) return;
  row.style.display = row.style.display==='none' ? 'flex' : 'none';
  if(row.style.display==='flex') row.querySelector('input')?.focus();
}

function handleAddByName(ev, date, col) {
  if(ev.key !== 'Enter') return;
  ev.preventDefault();
  const name=ev.target.value.trim();
  if(!name) return;
  const known=getEmployeesFromTable().map(e=>e.name);
  if(!known.includes(name)) { showMessage('Name must match an employee in the roster.'); return; }
  const target=document.querySelector(`.dropzone[data-date='${date}'][data-col='${col}']`);
  if(!target) return;
  const mock={dataTransfer:{getData:()=>JSON.stringify({name,fromDate:'',fromCol:''})},currentTarget:target,preventDefault:()=>{}};
  dropPill(mock);
  ev.target.value='';
}

function finalizeSchedule() {
  if(!generatedAssignments.length || !currentDraftPeriod) return;
  if(!confirm('Finalize this schedule? This will lock it into previous schedules.')) return;
  const item={period:currentDraftPeriod,assignments:[...generatedAssignments],violations:lastResponse?.violations||[],created_at:new Date().toISOString(),finalized_at:new Date().toISOString()};
  saveHistory(item);
  renderHistory();
  generatedAssignments=[];
  currentDraftPeriod=null;
  lastResponse=null;
  rerenderOutput();
  showMessage('Schedule finalized and saved to previous schedules.');
}

function clearHistory() {
  if(!confirm('Clear all previous schedules? Employee roster will not be affected.')) return;
  localStorage.setItem(STORAGE_HIST, JSON.stringify([]));
  renderHistory();
  showMessage('Previous schedules cleared.');
}

function exportSchedulePdf(historyIndex) {
  const hist=loadHistory();
  const item=hist[historyIndex];
  if(!item) return;
  const showBeach = !!item.period?.schedule_beach_shop || item.assignments.some(a=>a.location==='Beach Shop');
  const html=`<html><head><title>FOBE Finalized Schedule</title><style>@page{size:landscape;margin:10mm}body{font-family:Inter,Arial,sans-serif;padding:6px;color:#0f172a}h1{margin:0}p{margin:2px 0 6px;color:#475569}table{width:100%;border-collapse:collapse;margin-top:8px;font-size:10px;table-layout:fixed}th,td{border:1px solid #cbd5e1;padding:3px;text-align:left;vertical-align:top;word-wrap:break-word}th{background:#e2e8f0}.muted{color:#64748b}</style></head><body><h1>FOBE Finalized Schedule</h1><p>Start: ${fmtDateWithDay(item.period.start_date)} • Weeks: ${item.period.weeks}</p>${renderSchedule(item.assignments, false, true, showBeach)}</body></html>`;
  const win=window.open('', '_blank');
  if(!win) return;
  win.document.write(html);
  win.document.close();
  win.focus();
  win.print();
}

function loadHistory() { return JSON.parse(localStorage.getItem(STORAGE_HIST)||'[]'); }
function saveHistory(item) {
  const arr=loadHistory();
  arr.unshift(item);
  localStorage.setItem(STORAGE_HIST, JSON.stringify(arr.slice(0,12)));
}

function renderHistory() {
  const hist=loadHistory();
  if(!hist.length) { document.getElementById('history').innerHTML='No saved schedules yet.'; return; }
  document.getElementById('history').innerHTML = hist.map((h,idx)=>{
    const showBeach = !!h.period?.schedule_beach_shop || h.assignments.some(a=>a.location==='Beach Shop');
    return `<details ${idx===0?'open':''}><summary><strong>${fmtDateWithDay(h.period.start_date)}</strong> for ${h.period.weeks} week(s) — ${h.assignments.length} assignments</summary>${renderSchedule(h.assignments, false, false, showBeach)}${buildSummary(h.assignments, h.period)}<button onclick='exportSchedulePdf(${idx})'>Export PDF</button></details>`;
  }).join('');
}

function rerenderOutput() {
  const violations = lastResponse?.violations || [];
  document.getElementById('result').innerHTML = (generatedAssignments.length ? renderSchedule(generatedAssignments, true, false, usesBeachShop(currentDraftPeriod)) + buildSummary(generatedAssignments, currentDraftPeriod) : "<p class='muted'>Generate to view schedule.</p>") + (violations.length?`<h4>Rule checks</h4><ul>${violations.map(v=>`<li>${v.date}: ${v.detail}</li>`).join('')}</ul>`:'<p>No violations.</p>');
  document.getElementById('finalize_btn').disabled = !generatedAssignments.length;
}

async function runGenerate() {
  saveEmployees();
  rerollCounter += 1;
  const payload=collectPayload(rerollCounter);
  const res=await fetch('/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const json=await res.json();
  if(!res.ok) { showMessage('Generate failed'); return; }
  lastResponse=json;
  currentDraftPeriod={...payload.period, week_start_day: payload.week_start_day, week_end_day: payload.week_end_day, schedule_beach_shop: payload.schedule_beach_shop};
  generatedAssignments=[...json.assignments];
  recalculateHours();
  const beachViolations=(json.violations||[]).filter(v=>v.type==='beach_shop_gap');
  if(beachViolations.length) {
    alert('Beach Shop staffing rule violation: Beach Shop must have exactly 2 people whenever it is open. Please go back and adjust your staffing parameters.');
  }
  showMessage(`Generated ${json.assignments.length} assignments. Review and finalize to save.`);
}

function loadSampleData() {
  const employees=loadEmployees();
  document.getElementById('employee_rows').innerHTML='';
  employees.forEach(e=>document.getElementById('employee_rows').insertAdjacentHTML('beforeend', employeeRowHtml(e)));
  refreshRoleOptions();
  syncOverrides();
  document.getElementById('extra_rows').innerHTML='';
  (SAMPLE_PAYLOAD.extra_coverage_days||[]).forEach(addExtraRow);
  document.getElementById('time_off_rows').innerHTML='';
  (SAMPLE_PAYLOAD.unavailability||[]).forEach(addTimeOffRow);
  const weekStartEl=document.getElementById('week_start_day');
  weekStartEl.innerHTML = DAY_KEYS.map(day=>`<option value='${day}'>${weekdayLabel(day)}</option>`).join('');
  weekStartEl.value = SAMPLE_PAYLOAD.week_start_day || 'sun';
  const startInput=document.getElementById('period_start');
  startInput.value = iso(nextOrSameWeekday(new Date(), weekStartDay()));
  alignPeriodStartToBoundary();
  document.getElementById('period_weeks').value = SAMPLE_PAYLOAD.period.weeks;
  document.getElementById('schedule_beach_shop').checked = !!SAMPLE_PAYLOAD.schedule_beach_shop;
  updateWeekBoundaryNote();
  renderOpenDaySelectors();
  renderRepo();
}

document.getElementById('employee_rows').addEventListener('input', ()=>{ saveEmployees(); syncOverrides(); renderRepo(); });
document.getElementById('period_start').addEventListener('change', ()=>{ alignPeriodStartToBoundary(); renderOpenDaySelectors(); });
document.getElementById('period_weeks').addEventListener('change', renderOpenDaySelectors);
document.getElementById('week_start_day').addEventListener('change', handleWeekBoundaryChange);
document.addEventListener('change', (ev)=>{
  if(ev.target?.classList?.contains('extra-date') || ev.target?.classList?.contains('to-date')) applyScheduleWindowToDateInputs();
});
document.addEventListener('dragover', autoScrollOnDrag);
loadSampleData();
renderHistory();
rerenderOutput();
</script>
</body>
</html>
