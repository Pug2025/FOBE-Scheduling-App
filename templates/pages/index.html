<!doctype html>
<html>
<head>
<meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<title>FOBE Scheduler (local)</title>
<link rel='icon' type='image/svg+xml' href='/static/brand/favicon.svg'>
<link rel='stylesheet' href='/static/css/tokens.css'>
<link rel='stylesheet' href='/static/css/components.css'>
<link rel='stylesheet' href='/static/css/layout.css'>
<style>
  body { color:var(--text-strong); }
  .card { padding:var(--space-4); margin-bottom:var(--space-4); }
  .status-banner { min-height:1.5rem; margin-bottom:var(--space-4); padding:0 var(--space-2); font-size:var(--text-sm); }
  .workspace-shell { display:grid; grid-template-columns: 190px minmax(0, 1fr); gap:var(--space-4); align-items:start; }
  .workspace-nav { position:sticky; top:var(--space-4); padding:var(--space-3); background:linear-gradient(165deg, rgba(189,205,195,.45), rgba(255,255,255,.95)); }
  .workspace-nav h3 { margin:0 0 .35rem; font-size:1.15rem; }
  .nav-caption { margin:0 0 var(--space-3); color:var(--text-muted); font-size:var(--text-xs); text-transform:uppercase; letter-spacing:.08em; }
  .nav-links { display:grid; gap:.4rem; }
  .nav-link { display:block; padding:.5rem .65rem; border-radius:var(--radius-sm); border:1px solid transparent; text-decoration:none; color:var(--brand-deep-water); font-size:var(--text-sm); font-weight:600; }
  .nav-link:hover { background:rgba(245,179,53,.16); border-color:rgba(180,127,0,.25); color:var(--brand-jack-pine); }
  .workspace-main { min-width:0; }
  .section-card { overflow:hidden; }
  .section-heading { display:flex; justify-content:space-between; align-items:flex-start; gap:var(--space-3); margin-bottom:var(--space-4); }
  .section-heading.compact { margin-bottom:var(--space-3); }
  .section-title { margin:0; font-size:1.6rem; line-height:1.1; }
  .section-description { margin:.2rem 0 0; color:var(--text-muted); font-size:var(--text-sm); }
  .section-title-loose { margin:0 0 1rem; }
  .muted { color:var(--text-muted); font-size:.9rem; }
  table { width:100%; border-collapse: collapse; }
  th, td { border:1px solid var(--border-subtle); padding:.52rem .5rem; text-align:center; vertical-align:top; }
  th { background:var(--surface-3); color:var(--brand-jack-pine); }
  .table-wrap { overflow:auto; border:1px solid var(--border-subtle); border-radius:var(--radius-md); }
  .table-wrap table { border:0; min-width:760px; }
  .table-wrap th:first-child, .table-wrap td:first-child { border-left:0; }
  .table-wrap th:last-child, .table-wrap td:last-child { border-right:0; }
  .schedule-table { width:100%; min-width:0 !important; table-layout:fixed; }
  .schedule-table th, .schedule-table td { min-width:0; }
  .schedule-table .dropzone {
    flex-wrap: wrap;
    justify-content: flex-start;
    align-items: flex-start;
    overflow: visible;
    gap: .3rem;
    padding: .2rem .2rem;
  }
  .schedule-table .dropzone > * { flex: 0 0 auto; max-width: 100%; }
  .schedule-table .pill { white-space: nowrap; flex: 0 0 auto; }
  .schedule-table .zone-add { min-width: 28px; min-height: 28px; line-height: 1; padding: .12rem .4rem; border-radius: 8px; flex: 0 0 auto; }
  .schedule-table .zone-add-row { width: auto; margin-top: 0; display: inline-flex; align-items: center; }
  .schedule-table .zone-add-select { width: auto; min-width: 132px; max-width: 100%; }
  input, select, button { padding:.4rem .5rem; }
  input[type='checkbox'] { accent-color: var(--brand-jack-pine); }
  .toolbar { display:flex; flex-wrap:wrap; gap:.55rem; margin-bottom:var(--space-3); align-items:center; }
  .toolbar label { display:flex; align-items:center; gap:.45rem; padding:.45rem .55rem; border:1px solid var(--border-subtle); border-radius:var(--radius-sm); background:var(--surface-2); }
  .toolbar label input, .toolbar label select { background:#fff; }
  .control-note { margin:0 0 .4rem; }
  .open-day-chip { display:flex; align-items:center; gap:.4rem; padding:.45rem .6rem; border:1px solid var(--border-subtle); border-radius:999px; background:rgba(189,205,195,.16); }
  .open-day-chip input { margin:0; }
  .open-day-chip:has(input:checked),
  .open-day-chip.is-selected { border-color:rgba(89,97,29,.42); background:rgba(89,97,29,.2); color:var(--brand-jack-pine); font-weight:700; }
  .dropzone { min-height:58px; display:flex; flex-wrap:wrap; gap:.35rem; justify-content:center; align-content:flex-start; position:relative; padding-top:.2rem; border-radius: var(--radius-sm); transition: background var(--dur-fast) var(--ease-standard); }
  .dropzone:hover { background: rgba(189, 205, 195, 0.2); }
  .pill { background:rgba(104, 162, 185, 0.18); border:1px solid #75a9bc; border-radius:999px; padding:.2rem .5rem; cursor:grab; user-select:none; display:inline-flex; align-items:center; gap:.3rem; line-height:1.2; }
  .pill .pill-remove { width:16px; height:16px; border-radius:3px; padding:0; display:inline-flex; align-items:center; justify-content:center; font-size:13px; line-height:1; border-color: rgba(36,55,70,0.35); background: rgba(36,55,70,0.12); color: var(--brand-deep-water); }
  .zone-add-row { width:100%; display:flex; justify-content:center; margin-top:.1rem; }
  .zone-add-select { width:92%; font-size:.8rem; padding:.2rem .35rem; }
  .week-title { margin:.2rem 0 .6rem; }
  .weekday-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:.5rem .8rem; margin-top:.5rem; }
  .priority-list { list-style:none; margin:0; padding:0; display:grid; gap:.65rem; }
  .priority-item { display:flex; align-items:flex-start; gap:.7rem; border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:.65rem .75rem; background:var(--surface-2); }
  .priority-pill { min-width:74px; text-align:center; font-size:var(--text-xs); font-weight:800; letter-spacing:.06em; text-transform:uppercase; border-radius:999px; padding:.18rem .5rem; }
  .priority-pill.a { background:rgba(89,97,29,.22); color:var(--brand-jack-pine); }
  .priority-pill.b { background:rgba(104,162,185,.22); color:var(--brand-deep-water); }
  .priority-pill.c { background:rgba(217,199,158,.42); color:var(--brand-charcoal); }
  .action-row { display:flex; justify-content:space-between; align-items:center; gap:var(--space-3); margin-bottom:var(--space-3); flex-wrap:wrap; }
  .action-row p { margin:0; }
  .dropzone.dropzone--active { background:rgba(245,179,53,.16); }
  .dropzone.dropzone--valid { box-shadow: inset 0 0 0 2px rgba(89,97,29,.55); background:rgba(89,97,29,.12); }
  .dropzone.dropzone--invalid { box-shadow: inset 0 0 0 2px rgba(187,75,39,.58); background:rgba(187,75,39,.1); }
  .pill.pill--dragging { opacity:.45; transform:scale(.98); }
  #result { overflow:auto; }
  #history details { border:1px solid var(--border-subtle); border-radius:var(--radius-md); margin-bottom:var(--space-3); padding:var(--space-3); background:var(--surface-2); }
  #history summary { cursor:pointer; font-weight:700; color:var(--brand-jack-pine); }
  #history button { margin-top:var(--space-3); }
  .status-banner[data-tone='warn'] { color:#8a3f1a; }
  .status-banner[data-tone='danger'] { color:#7a2e18; }
  .status-banner[data-tone='success'] { color:var(--brand-hypnum-moss); }
  .ui-toast {
    position: fixed;
    right: var(--space-4);
    bottom: var(--space-4);
    z-index: 70;
    max-width: min(380px, calc(100vw - 2rem));
    padding: .65rem .85rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-subtle);
    background: #fff;
    color: var(--text-strong);
    box-shadow: var(--shadow-2);
    font-size: var(--text-sm);
    opacity: 0;
    transform: translateY(10px);
    pointer-events: none;
    transition: opacity var(--dur-med) var(--ease-standard), transform var(--dur-med) var(--ease-standard);
  }
  .ui-toast.is-visible { opacity: 1; transform: translateY(0); }
  .ui-toast[data-tone='success'] { border-color: rgba(89,97,29,.52); background: rgba(89,97,29,.12); color: var(--brand-jack-pine); }
  .ui-toast[data-tone='warn'] { border-color: rgba(228,126,61,.52); background: rgba(228,126,61,.16); color: #8a3f1a; }
  .ui-toast[data-tone='danger'] { border-color: rgba(187,75,39,.54); background: rgba(187,75,39,.14); color: #7a2e18; }
  .ui-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 80;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-4);
    background: rgba(36,55,70,.45);
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity var(--dur-med) var(--ease-standard);
  }
  .ui-modal-overlay.is-open { opacity: 1; visibility: visible; pointer-events: auto; }
  .ui-modal-overlay[hidden] { display: none !important; }
  .ui-modal {
    width: min(480px, 100%);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    border: 1px solid var(--border-subtle);
    background: #fff;
    box-shadow: var(--shadow-2);
  }
  .ui-modal-title { margin: 0 0 .45rem; font-size: 1.45rem; color: var(--brand-jack-pine); }
  .ui-modal-body { margin: 0; color: var(--text-muted); }
  .ui-modal-actions { margin-top: var(--space-4); display: flex; justify-content: flex-end; gap: .55rem; }
  .ui-modal-cancel { background: transparent; color: var(--brand-deep-water); border-color: var(--border-strong); }
  .ui-modal-cancel:hover { background: rgba(189,205,195,.3); border-color: var(--brand-blue-sky); }
  .ui-modal-confirm.is-danger { background: var(--danger); border-color: var(--danger); color: #fff; }
  .ui-modal-confirm.is-danger:hover { background: #a94222; border-color: #a94222; }
  body.modal-open { overflow: hidden; }
  @media (max-width: 1120px) {
    .workspace-shell { grid-template-columns: 1fr; }
    .workspace-nav { position:relative; top:auto; }
    .nav-links { grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); }
  }
</style>
</head>
<body>
<div class='container'>
  <header class='app-header'>
    <div class='brand-block'>
      <img class='brand-logo' src='/static/brand/logo-full.svg' alt='Friends of Bon Echo Park logo'>
      <div>
        <p class='brand-kicker'>Friends of Bon Echo Park</p>
        <h1 class='brand-title'>FOBE Scheduler Workspace</h1>
        <p class='brand-subtitle'>Prototype scheduling console</p>
      </div>
    </div>
  </header>
  <p id='feedback' class='muted status-banner'></p>

  <div class='workspace-shell'>
    <aside class='workspace-nav card'>
      <h3>Scheduler Map</h3>
      <p class='nav-caption'>Jump To Section</p>
      <nav class='nav-links'>
        <a class='nav-link' href='#section-period'>Scheduling Period</a>
        <a class='nav-link' href='#section-priority'>Priority Glossary</a>
        <a class='nav-link' href='#section-employees'>Employees</a>
        <a class='nav-link' href='#section-timeoff'>Days Off</a>
        <a class='nav-link' href='#section-extra'>Extra Coverage</a>
        <a class='nav-link' href='#section-generated'>Generate Schedule</a>
        <a class='nav-link' href='#section-history'>Previous Schedules</a>
      </nav>
    </aside>

    <main class='workspace-main'>
      <section id='section-period' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title'>Scheduling Period</h3>
            <p class='section-description'>Define start date, run length, and weekly boundaries before generation.</p>
          </div>
        </div>
        <div class='toolbar'>
          <label>Start Date <input id='period_start' type='date'></label>
          <label>Weeks <input id='period_weeks' type='number' min='1' max='8' value='2'></label>
          <label>Week Starts <select id='week_start_day'></select></label>
          <label><input id='schedule_beach_shop' type='checkbox' onchange='syncOverrides()'> Schedule Beach Shop</label>
        </div>
        <p id='week_boundary_note' class='muted control-note'></p>
        <div>
          <p class='muted'>Open days for this run (uncheck store-closed days):</p>
          <div id='open_day_rows' class='weekday-grid'></div>
        </div>
      </section>

      <section id='section-priority' class='card section-card'>
        <div class='section-heading compact'>
          <div>
            <h3 class='section-title' style='font-size:1.4rem'>Priority Glossary</h3>
          </div>
        </div>
        <ul class='priority-list'>
          <li class='priority-item'><span class='priority-pill a'>Priority A</span><span>Core staff with strongest preference for coverage.</span></li>
          <li class='priority-item'><span class='priority-pill b'>Priority B</span><span>Standard staffing priority.</span></li>
          <li class='priority-item'><span class='priority-pill c'>Priority C</span><span>Lowest assignment priority unless needed for coverage.</span></li>
        </ul>
      </section>

      <section id='section-employees' class='card section-card'>
        <div class='section-heading compact'>
          <div>
            <h3 class='section-title' style='font-size:1.45rem'>Employees</h3>
          </div>
        </div>
        <div class='action-row'>
          <p class='muted'>This roster persists from schedule to schedule using local storage. Set default role and default min/max weekly hours.</p>
          <button class='btn-secondary' onclick='addEmployeeRow()'>Add Employee</button>
        </div>
        <div class='table-wrap'>
          <table>
            <thead><tr><th>Name</th><th>Role</th><th>Default Min Hrs</th><th>Default Max Hrs</th><th>Priority</th><th></th></tr></thead>
            <tbody id='employee_rows'></tbody>
          </table>
        </div>
      </section>

      <section id='section-timeoff' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title section-title-loose'>Days Off Requested</h3>
          </div>
        </div>
        <div class='action-row'>
          <p class='muted'>Add requested days off to protect known unavailable dates.</p>
          <button onclick='addTimeOffRow()'>Add Requested Day Off</button>
        </div>
        <div class='table-wrap'>
          <table>
            <thead><tr><th>Employee</th><th>Date</th><th>Reason</th><th></th></tr></thead>
            <tbody id='time_off_rows'></tbody>
          </table>
        </div>
      </section>

      <section id='section-extra' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title section-title-loose'>Extra Coverage Days</h3>
          </div>
        </div>
        <div class='action-row'>
          <p class='muted'>Track days requiring additional staff above baseline coverage.</p>
          <button onclick='addExtraRow()'>Add Extra Day</button>
        </div>
        <div class='table-wrap'>
          <table>
            <thead><tr><th>Date</th><th>Extra People</th><th></th></tr></thead>
            <tbody id='extra_rows'></tbody>
          </table>
        </div>
      </section>

      <section id='section-generated' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title section-title-loose'>Newly Generated Schedule</h3>
          </div>
        </div>
        <div class='toolbar'>
          <button onclick='runGenerate()'>Generate Schedule</button>
          <button id='finalize_btn' onclick='finalizeSchedule()' disabled>Finalize Schedule</button>
        </div>
        <div id='result'>Generate to view schedule.</div>
      </section>

      <section id='section-history' class='card section-card'>
        <div class='section-heading'>
          <div>
            <h3 class='section-title section-title-loose'>Existing Previous Schedules</h3>
          </div>
        </div>
        <div class='toolbar'>
          <button class='btn-danger' onclick='clearHistory()'>Clear Previous Schedules</button>
        </div>
        <div id='history'>No saved schedules yet.</div>
      </section>
    </main>
  </div>
</div>

<div id='ui_modal_overlay' class='ui-modal-overlay' hidden>
  <div class='ui-modal' role='dialog' aria-modal='true' aria-labelledby='ui_modal_title' aria-describedby='ui_modal_body'>
    <h4 id='ui_modal_title' class='ui-modal-title'>Confirm Action</h4>
    <p id='ui_modal_body' class='ui-modal-body'></p>
    <div class='ui-modal-actions'>
      <button id='ui_modal_cancel' type='button' class='ui-modal-cancel'>Cancel</button>
      <button id='ui_modal_confirm' type='button' class='ui-modal-confirm'>Confirm</button>
    </div>
  </div>
</div>

<div id='ui_toast' class='ui-toast' role='status' aria-live='polite'></div>

<script>
const ROLE_OPTIONS = ['Store Clerk','Team Leader','Store Manager','Boat Captain'];
const DAY_KEYS = ['mon','tue','wed','thu','fri','sat','sun'];
const JS_DAY_KEYS = ['sun','mon','tue','wed','thu','fri','sat'];
const DAY_LABELS = {mon:'Monday',tue:'Tuesday',wed:'Wednesday',thu:'Thursday',fri:'Friday',sat:'Saturday',sun:'Sunday'};
const KEY_TO_JS_DAY = {sun:0,mon:1,tue:2,wed:3,thu:4,fri:5,sat:6};
const SAMPLE_PAYLOAD = {{ payload_json | safe }};
const STORAGE_EMP='fobe_employees_v1';
const STORAGE_HIST='fobe_schedule_history_v1';
let generatedAssignments=[];
let lastResponse=null;
let currentDraftPeriod=null;
let currentDraftPayload=null;
let liveViolations=[];
let rerollCounter=0;
let activeDragData=null;
let toastTimer=null;
let modalResolver=null;
let priorFocus=null;
let modalHideTimer=null;

function showMessage(msg, tone='neutral') {
  const banner=document.getElementById('feedback');
  banner.textContent = msg;
  banner.dataset.tone = tone;
}
function showToast(msg, tone='info', duration=2800) {
  const toast=document.getElementById('ui_toast');
  toast.textContent=msg;
  toast.dataset.tone=tone;
  toast.classList.add('is-visible');
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>toast.classList.remove('is-visible'), duration);
}
function openDecisionModal({title='Confirm Action', body='', confirmLabel='Confirm', cancelLabel='Cancel', confirmTone='primary', showCancel=true}={}) {
  const overlay=document.getElementById('ui_modal_overlay');
  const titleEl=document.getElementById('ui_modal_title');
  const bodyEl=document.getElementById('ui_modal_body');
  const cancelBtn=document.getElementById('ui_modal_cancel');
  const confirmBtn=document.getElementById('ui_modal_confirm');
  titleEl.textContent=title;
  bodyEl.textContent=body;
  cancelBtn.textContent=cancelLabel;
  confirmBtn.textContent=confirmLabel;
  cancelBtn.hidden = !showCancel;
  cancelBtn.style.display = showCancel ? '' : 'none';
  confirmBtn.classList.toggle('is-danger', confirmTone==='danger');
  if(modalHideTimer) clearTimeout(modalHideTimer);
  priorFocus=document.activeElement instanceof HTMLElement ? document.activeElement : null;
  overlay.hidden=false;
  requestAnimationFrame(()=>overlay.classList.add('is-open'));
  document.body.classList.add('modal-open');
  confirmBtn.focus();
  return new Promise(resolve=>{ modalResolver=resolve; });
}
function closeDecisionModal(result) {
  const overlay=document.getElementById('ui_modal_overlay');
  overlay.classList.remove('is-open');
  document.body.classList.remove('modal-open');
  modalHideTimer=setTimeout(()=>{ overlay.hidden=true; }, 120);
  if(priorFocus) priorFocus.focus();
  if(modalResolver) {
    const resolve=modalResolver;
    modalResolver=null;
    resolve(result);
  }
}
function wireModalEvents() {
  const overlay=document.getElementById('ui_modal_overlay');
  document.getElementById('ui_modal_cancel').addEventListener('click', ()=>closeDecisionModal(false));
  document.getElementById('ui_modal_confirm').addEventListener('click', ()=>closeDecisionModal(true));
  overlay.addEventListener('click', (ev)=>{
    if(ev.target===overlay && !document.getElementById('ui_modal_cancel').hidden) closeDecisionModal(false);
  });
  document.addEventListener('keydown', (ev)=>{
    if(ev.key==='Escape' && !overlay.hidden) {
      closeDecisionModal(!document.getElementById('ui_modal_cancel').hidden ? false : true);
    }
  });
}
function slugifyName(name, idx) { return name.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'') || `emp_${idx+1}`; }
function esc(value) { return String(value).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }
function parseDate(s) { const [y,m,d]=s.split('-').map(Number); return new Date(y,m-1,d); }
function fmtDate(s) { return new Date(s+'T00:00:00').toLocaleDateString(); }
function fmtDateWithDay(s) { return new Date(s+'T00:00:00').toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'short', day:'numeric' }); }
function iso(d) { return d.toISOString().slice(0,10); }
function weekdayLabel(key) { return DAY_LABELS[key] || key; }
function previousDayKey(key) { const idx=DAY_KEYS.indexOf(key); return DAY_KEYS[(idx+6)%7]; }
function keyToJsDay(key) { return KEY_TO_JS_DAY[key] ?? 0; }
function weekStartDay() { return document.getElementById('week_start_day')?.value || 'sun'; }
function weekEndDay() { return previousDayKey(weekStartDay()); }
function nextOrSameWeekday(d, dayKey) { const x=new Date(d); const delta=(keyToJsDay(dayKey)-x.getDay()+7)%7; x.setDate(x.getDate()+delta); return x; }
function weekStartForDate(d, dayKey) { const x=new Date(d); const delta=(x.getDay()-keyToJsDay(dayKey)+7)%7; x.setDate(x.getDate()-delta); return x; }
function dayKeyForDate(d) { return JS_DAY_KEYS[d.getDay()]; }
function timeToMinutes(value) { const [h,m]=value.split(':').map(Number); return h*60+m; }
function coversWindow(windows, start, end) {
  const s=timeToMinutes(start);
  const e=timeToMinutes(end);
  return (windows||[]).some(w=>{
    const [ws,we]=w.split('-');
    return timeToMinutes(ws) <= s && timeToMinutes(we) >= e;
  });
}
function daterangeIso(startIso, days) {
  const out=[];
  const d=parseDate(startIso);
  for(let i=0;i<days;i++) {
    const x=new Date(d);
    x.setDate(x.getDate()+i);
    out.push(iso(x));
  }
  return out;
}
function usesBeachShop(period=null) {
  if(period && typeof period.schedule_beach_shop === 'boolean') return period.schedule_beach_shop;
  return !!document.getElementById('schedule_beach_shop')?.checked;
}
function firstMonday(year, monthIndex) { const d=new Date(year, monthIndex, 1); while(d.getDay()!==1) d.setDate(d.getDate()+1); return d; }
function victoriaDay(year) { const d=new Date(year, 4, 24); while(d.getDay()!==1) d.setDate(d.getDate()-1); return d; }
function seasonRulesForYear(year) {
  return {
    victoria_day: iso(victoriaDay(year)),
    june_30: iso(new Date(year, 5, 30)),
    labour_day: iso(firstMonday(year, 8)),
    oct_31: iso(new Date(year, 9, 31)),
  };
}

function roleCounts() {
  const roles=[...document.querySelectorAll('.emp-role')].map(s=>s.value);
  return { manager: roles.filter(r=>r==='Store Manager').length, lead: roles.filter(r=>r==='Team Leader').length };
}
function refreshRoleOptions() {
  const c=roleCounts();
  document.querySelectorAll('.emp-role').forEach(sel=>{
    const current=sel.value;
    sel.innerHTML = ROLE_OPTIONS.map(r=>{
      const disabled = (r==='Store Manager' && c.manager>=1 && current!=='Store Manager') || (r==='Team Leader' && c.lead>=2 && current!=='Team Leader');
      return `<option value="${r}" ${current===r?'selected':''} ${disabled?'disabled':''}>${r}</option>`;
    }).join('');
  });
}

function employeeRowHtml(emp={}) {
  return `<tr><td><input class='emp-name' value='${emp.name||''}'></td><td><select class='emp-role' onchange='refreshRoleOptions();syncOverrides()'>${ROLE_OPTIONS.map(r=>`<option value="${r}" ${(emp.role||'Store Clerk')===r?'selected':''}>${r}</option>`).join('')}</select></td><td><input type='number' class='emp-min' value='${emp.min_hours_per_week??16}' onchange='syncOverrides()'></td><td><input type='number' class='emp-max' value='${emp.max_hours_per_week??40}' onchange='syncOverrides()'></td><td><select class='emp-priority'><option value='A' ${emp.priority_tier==='A'?'selected':''}>A</option><option value='B' ${(!emp.priority_tier||emp.priority_tier==='B')?'selected':''}>B</option><option value='C' ${emp.priority_tier==='C'?'selected':''}>C</option></select></td><td><button onclick='this.closest("tr").remove();refreshRoleOptions();syncOverrides();saveEmployees()'>Remove</button></td></tr>`;
}
function addEmployeeRow(emp={}) { document.getElementById('employee_rows').insertAdjacentHTML('beforeend', employeeRowHtml(emp)); refreshRoleOptions(); syncOverrides(); saveEmployees(); }
function extraRowHtml(row={}) { return `<tr><td><input type='date' class='extra-date' value='${row.date||''}'></td><td><input type='number' min='1' class='extra-people' value='${row.extra_people||1}'></td><td><button onclick='this.closest("tr").remove()'>Remove</button></td></tr>`; }
function addExtraRow(row={}) { document.getElementById('extra_rows').insertAdjacentHTML('beforeend', extraRowHtml(row)); applyScheduleWindowToDateInputs(); }
function timeOffRowHtml(row={}) {
  const employeeOptions=getEmployeesFromTable().map(e=>`<option value='${e.id}' ${row.employee_id===e.id?'selected':''}>${e.name}</option>`).join('');
  return `<tr><td><select class='to-emp'>${employeeOptions}</select></td><td><select class='to-date' data-selected='${row.date||''}'><option value=''>Select date</option></select></td><td><input class='to-reason' value='${row.reason||''}' placeholder='Vacation, appointment, etc.'></td><td><button onclick='this.closest("tr").remove()'>Remove</button></td></tr>`;
}
function addTimeOffRow(row={}) {
  document.getElementById('time_off_rows').insertAdjacentHTML('beforeend', timeOffRowHtml(row));
  applyScheduleWindowToDateInputs();
  refreshTimeOffDateOptions({notify:false});
}
function refreshTimeOffEmployeeOptions() {
  const employees=getEmployeesFromTable();
  const rows=[...document.querySelectorAll('#time_off_rows tr')].map(tr=>({employee_id:tr.querySelector('.to-emp')?.value||'',date:tr.querySelector('.to-date')?.value||'',reason:tr.querySelector('.to-reason')?.value||''}));
  const tbody=document.getElementById('time_off_rows');
  tbody.innerHTML='';
  rows.forEach(r=>{
    const fallback=employees[0]?.id||'';
    const selected=employees.some(e=>e.id===r.employee_id)?r.employee_id:fallback;
    tbody.insertAdjacentHTML('beforeend', timeOffRowHtml({...r,employee_id:selected}));
  });
  refreshTimeOffDateOptions({notify:false});
}

function scheduleWindowDateList() {
  const bounds=scheduleWindowBounds();
  if(!bounds) return [];
  const dates=[];
  const cursor=parseDate(bounds.min);
  const end=parseDate(bounds.max);
  while(cursor <= end) {
    dates.push(iso(cursor));
    cursor.setDate(cursor.getDate()+1);
  }
  return dates;
}

function refreshTimeOffDateOptions({notify=false}={}) {
  const rows=[...document.querySelectorAll('#time_off_rows tr')].map(tr=>{
    const dateSelect=tr.querySelector('.to-date');
    return {
      tr,
      employee_id: tr.querySelector('.to-emp')?.value||'',
      date_select: dateSelect,
      date: dateSelect?.value || dateSelect?.dataset?.selected || '',
    };
  });
  if(!rows.length) return;

  const dates=scheduleWindowDateList();
  const seen=new Set();
  let hadDuplicate=false;
  for(const row of rows) {
    if(!row.employee_id || !row.date) continue;
    const key=`${row.employee_id}|${row.date}`;
    if(seen.has(key)) {
      row.date='';
      hadDuplicate=true;
    } else {
      seen.add(key);
    }
  }

  const selectedByEmployee=new Map();
  for(const row of rows) {
    if(!row.employee_id || !row.date) continue;
    selectedByEmployee.set(row.employee_id, selectedByEmployee.get(row.employee_id) || new Set());
    selectedByEmployee.get(row.employee_id).add(row.date);
  }

  for(const row of rows) {
    const select=row.date_select;
    if(!select) continue;
    const taken=new Set(selectedByEmployee.get(row.employee_id) || []);
    if(row.date) taken.delete(row.date);
    let options=`<option value=''>Select date</option>`;
    for(const dIso of dates) {
      const blocked=!!row.employee_id && taken.has(dIso);
      options += `<option value='${dIso}' ${row.date===dIso?'selected':''} ${blocked?'disabled':''}>${fmtDateWithDay(dIso)}${blocked?' (already selected)':''}</option>`;
    }
    if(row.date && !dates.includes(row.date)) {
      options += `<option value='${row.date}' selected>${fmtDateWithDay(row.date)}</option>`;
    }
    select.innerHTML=options;
    select.disabled = !row.employee_id || !dates.length;
    if(!row.employee_id) select.value='';
    select.dataset.selected='';
  }

  if(hadDuplicate && notify) {
    showToast('Duplicate requested days off for the same employee were cleared.', 'warn', 3000);
  }
}

function getEmployeesFromTable() {
  return [...document.querySelectorAll('#employee_rows tr')].map((tr,idx)=>{
    const name=tr.querySelector('.emp-name').value.trim();
    return {id:slugifyName(name,idx),name,role:tr.querySelector('.emp-role').value,min_hours_per_week:Number(tr.querySelector('.emp-min').value||0),max_hours_per_week:Number(tr.querySelector('.emp-max').value||40),priority_tier:tr.querySelector('.emp-priority').value,availability:Object.fromEntries(DAY_KEYS.map(day=>[day,['08:30-17:30']]))};
  }).filter(e=>e.name);
}

function saveEmployees() { localStorage.setItem(STORAGE_EMP, JSON.stringify(getEmployeesFromTable())); }
function loadEmployees() {
  const raw=localStorage.getItem(STORAGE_EMP);
  if(raw) return JSON.parse(raw);
  return SAMPLE_PAYLOAD.employees;
}

function updateWeekBoundaryNote() {
  const note=document.getElementById('week_boundary_note');
  if(!note) return;
  note.innerHTML = `Schedules are grouped and summarized by week from <strong>${weekdayLabel(weekStartDay())}</strong> to <strong>${weekdayLabel(weekEndDay())}</strong>.`;
}

function alignPeriodStartToBoundary() {
  const startInput=document.getElementById('period_start');
  if(!startInput) return;
  const minStart=nextOrSameWeekday(new Date(), weekStartDay());
  const base=startInput.value ? parseDate(startInput.value) : minStart;
  let aligned=nextOrSameWeekday(base, weekStartDay());
  if(aligned < minStart) aligned = minStart;
  startInput.min = iso(minStart);
  startInput.step = '7';
  startInput.value = iso(aligned);
}

function handleWeekBoundaryChange() {
  alignPeriodStartToBoundary();
  updateWeekBoundaryNote();
  renderOpenDaySelectors();
}

function syncOverrides() {
  refreshTimeOffEmployeeOptions();
  rerenderOutput();
}

function scheduleWindowBounds() {
  const startRaw=document.getElementById('period_start')?.value;
  if(!startRaw) return null;
  const weeks=Math.max(1, Number(document.getElementById('period_weeks')?.value||2));
  const startDate=nextOrSameWeekday(parseDate(startRaw), weekStartDay());
  const endDate=new Date(startDate);
  endDate.setDate(endDate.getDate() + (weeks * 7) - 1);
  return { min: iso(startDate), max: iso(endDate) };
}

function applyScheduleWindowToDateInputs() {
  const bounds=scheduleWindowBounds();
  if(!bounds) return;
  document.querySelectorAll('.extra-date').forEach(input=>{
    input.min = bounds.min;
    input.max = bounds.max;
    if(input.value && (input.value < bounds.min || input.value > bounds.max)) {
      input.value = '';
    }
  });
  refreshTimeOffDateOptions({notify:false});
}

function renderOpenDaySelectors() {
  const wrap=document.getElementById('open_day_rows');
  const selected=new Set(getSelectedOpenDays());
  wrap.innerHTML = DAY_KEYS.map(day=>`<label class='open-day-chip'><input type='checkbox' class='open-day' value='${day}' ${selected.has(day)?'checked':''}><span>${weekdayLabel(day)}</span></label>`).join('');
  syncOpenDayChipStates();
  applyScheduleWindowToDateInputs();
}

function syncOpenDayChipStates() {
  document.querySelectorAll('.open-day-chip').forEach(chip=>{
    const checked=chip.querySelector('.open-day')?.checked;
    chip.classList.toggle('is-selected', !!checked);
  });
}

function getSelectedOpenDays() {
  const boxes=[...document.querySelectorAll('.open-day')];
  if(!boxes.length) return [...DAY_KEYS];
  return boxes.filter(b=>b.checked).map(b=>b.value);
}

function collectPayload(rerollToken=0) {
  const employees=getEmployeesFromTable();
  const extra_coverage_days=[...document.querySelectorAll('#extra_rows tr')].map(tr=>({date:tr.querySelector('.extra-date').value,extra_people:Number(tr.querySelector('.extra-people').value||1)})).filter(r=>r.date);
  const unavailability=[...document.querySelectorAll('#time_off_rows tr')].map(tr=>({employee_id:tr.querySelector('.to-emp').value,date:tr.querySelector('.to-date').value,reason:tr.querySelector('.to-reason').value.trim()})).filter(r=>r.employee_id && r.date);
  const startInput=document.getElementById('period_start');
  const start=startInput.value;
  const weeks=Number(document.getElementById('period_weeks').value||2);
  const startDate=nextOrSameWeekday(parseDate(start), weekStartDay());
  const alignedStart=iso(startDate);
  if(start!==alignedStart) startInput.value = alignedStart;
  const open_weekdays=getSelectedOpenDays();
  const schedule_beach_shop=document.getElementById('schedule_beach_shop').checked;
  return {...SAMPLE_PAYLOAD, period:{start_date:alignedStart, weeks}, season_rules:seasonRulesForYear(startDate.getFullYear()), employees, extra_coverage_days, unavailability, open_weekdays, week_start_day:weekStartDay(), week_end_day:weekEndDay(), reroll_token: rerollToken, schedule_beach_shop};
}

function refreshCurrentDraftPayload() {
  if(!currentDraftPeriod) return;
  const draft=collectPayload(rerollCounter);
  const draftStart=currentDraftPeriod.start_date;
  draft.period = { start_date: draftStart, weeks: currentDraftPeriod.weeks };
  draft.season_rules = seasonRulesForYear(parseDate(draftStart).getFullYear());
  draft.week_start_day = currentDraftPeriod.week_start_day;
  draft.week_end_day = currentDraftPeriod.week_end_day;
  draft.schedule_beach_shop = !!currentDraftPeriod.schedule_beach_shop;
  currentDraftPayload = draft;
}

function weekendLeaderShortageDates(payload) {
  const managerIds=new Set(payload.employees.filter(e=>e.role==='Store Manager').map(e=>e.id));
  const leaders=payload.employees.filter(e=>e.role==='Team Leader');
  if(!managerIds.size || !leaders.length) return [];
  const openDays=new Set(payload.open_weekdays||DAY_KEYS);
  const unavail=new Set((payload.unavailability||[]).map(u=>`${u.employee_id}|${u.date}`));
  const dates=daterangeIso(payload.period.start_date, payload.period.weeks * 7);
  const out=[];
  for(const dIso of dates) {
    const d=parseDate(dIso);
    const dayKey=dayKeyForDate(d);
    if(!(d.getDay()===0 || d.getDay()===6)) continue;
    if(!openDays.has(dayKey)) continue;
    const managerRequestedOff=[...managerIds].some(id=>unavail.has(`${id}|${dIso}`));
    if(!managerRequestedOff) continue;
    const availableLeaders=leaders.filter(l=>!unavail.has(`${l.id}|${dIso}`) && coversWindow(l.availability?.[dayKey], payload.hours.greystones.start, payload.hours.greystones.end));
    if(availableLeaders.length === 1) out.push(dIso);
  }
  return out;
}

function calcShiftHours(start, end) {
  const [sh,sm]=start.split(':').map(Number);
  const [eh,em]=end.split(':').map(Number);
  const raw=(eh*60+em-sh*60-sm)/60;
  return Math.max(0, raw - (raw>=6 ? 1 : 0));
}

function formatHours(value) {
  return Number(value.toFixed(2)).toString();
}

function ordinalFromIso(value) {
  const [y,m,d]=value.split('-').map(Number);
  return Date.UTC(y,m-1,d) / 86400000;
}

function isWeekendIso(value) {
  const d=parseDate(value);
  return d.getDay()===0 || d.getDay()===6;
}

function isBeachShopOpenDate(value, seasonRules) {
  const d=parseDate(value);
  const labourDay=parseDate(seasonRules?.labour_day || value);
  const july1=parseDate(`${d.getFullYear()}-07-01`);
  return isWeekendIso(value) || (d >= july1 && d <= labourDay);
}

function weekStartsForPeriod(period) {
  const out=[];
  const totalWeeks=Math.max(0, Number(period?.weeks||0));
  for(let i=0;i<totalWeeks;i++) {
    const d=parseDate(period.start_date);
    d.setDate(d.getDate() + i*7);
    out.push(iso(d));
  }
  return out;
}

function computeLiveViolations(assignments, payload) {
  if(!payload?.period?.start_date || !payload?.period?.weeks) return [];
  const employees=payload.employees||[];
  const employeeById=new Map(employees.map(e=>[e.id,e]));
  const employeeByName=new Map(employees.map(e=>[e.name,e]));
  const managerIds=employees.filter(e=>e.role==='Store Manager').map(e=>e.id);
  const managerNameById=new Map(employees.filter(e=>e.role==='Store Manager').map(e=>[e.id,e.name]));
  const openWeekdays=new Set(payload.open_weekdays||DAY_KEYS);
  const allDates=daterangeIso(payload.period.start_date, Number(payload.period.weeks||0) * 7);
  const allDateSet=new Set(allDates);
  const extrasByDate=new Map((payload.extra_coverage_days||[]).map(x=>[x.date, Number(x.extra_people||0)]));
  const unavail=new Set((payload.unavailability||[]).map(x=>`${x.employee_id}|${x.date}`));

  const floorByDate=new Map();
  const captainByDate=new Map();
  const beachByDate=new Map();
  const managerWorkByDate=new Map();
  const dailyMaxHours=new Map();
  const startOrdinal=ordinalFromIso(payload.period.start_date);
  const inc=(map,key)=>map.set(key, (map.get(key)||0) + 1);

  const employeeForAssignment=(a)=>employeeById.get(a.employee_id) || employeeByName.get(a.employee_name) || null;

  for(const a of assignments) {
    if(!allDateSet.has(a.date)) continue;
    const employee=employeeForAssignment(a);
    const employeeId=employee?.id || a.employee_id || a.employee_name;

    if(a.location==='Greystones' && (a.role==='Team Leader' || a.role==='Store Clerk')) inc(floorByDate, a.date);
    if(a.location==='Boat' && a.role==='Boat Captain') inc(captainByDate, a.date);
    if(a.location==='Beach Shop') inc(beachByDate, a.date);

    if(managerIds.includes(employeeId)) {
      if(!managerWorkByDate.has(a.date)) managerWorkByDate.set(a.date, new Set());
      managerWorkByDate.get(a.date).add(employeeId);
    }

    const hours=calcShiftHours(a.start, a.end);
    const dayKey=`${employeeId}|${a.date}`;
    const prior=dailyMaxHours.get(dayKey)||0;
    if(hours > prior) dailyMaxHours.set(dayKey, hours);
  }

  const weeklyHours=new Map();
  for(const [employeeDateKey, dayHours] of dailyMaxHours.entries()) {
    const [employeeId, dayIso]=employeeDateKey.split('|');
    const weekIdx=Math.floor((ordinalFromIso(dayIso) - startOrdinal) / 7) + 1;
    const weekKey=`${employeeId}|${weekIdx}`;
    weeklyHours.set(weekKey, (weeklyHours.get(weekKey)||0) + dayHours);
  }

  const violations=[];
  for(const dIso of allDates) {
    const dayKey=dayKeyForDate(parseDate(dIso));
    const storeOpen=openWeekdays.has(dayKey);

    if(storeOpen) {
      const needed=(isWeekendIso(dIso) ? Number(payload.coverage?.greystones_weekend_staff||0) : Number(payload.coverage?.greystones_weekday_staff||0)) + Number(extrasByDate.get(dIso)||0);
      const floorAssigned=Number(floorByDate.get(dIso)||0);
      if(floorAssigned < needed) {
        violations.push({date:dIso, type:'coverage_gap', detail:`Greystones needed ${needed}`});
      }
      if(Number(captainByDate.get(dIso)||0) < 1) {
        violations.push({date:dIso, type:'role_missing', detail:'Missing Boat Captain'});
      }
    }

    const beachOpen=payload.schedule_beach_shop && storeOpen && isBeachShopOpenDate(dIso, payload.season_rules);
    if(beachOpen) {
      const needed=2;
      const beachAssigned=Number(beachByDate.get(dIso)||0);
      if(beachAssigned < needed) {
        violations.push({date:dIso, type:'beach_shop_gap', detail:`Beach Shop needed ${needed}`});
      }
    }
  }

  for(const ws of weekStartsForPeriod(payload.period)) {
    const weekDays=daterangeIso(ws, 7).filter(d=>allDateSet.has(d));
    for(const managerId of managerIds) {
      if(weekDays.some(d=>!openWeekdays.has(dayKeyForDate(parseDate(d))))) continue;
      const work=weekDays.map(d=>managerWorkByDate.get(d)?.has(managerId) || false);
      const hasPair=work.some((working, idx)=>idx < work.length-1 && !working && !work[idx+1]);
      if(payload.leadership_rules?.manager_two_consecutive_days_off_per_week && !hasPair) {
        violations.push({date:ws, type:'manager_consecutive_days_off', detail:`Manager ${managerNameById.get(managerId)||managerId} lacks consecutive days off`});
      }
      const requestedDaysOff=weekDays.filter(d=>unavail.has(`${managerId}|${d}`)).length;
      const targetDays=Math.max(0, Math.min(5, weekDays.length - requestedDaysOff));
      const actualDays=work.filter(Boolean).length;
      if(actualDays < targetDays) {
        violations.push({date:ws, type:'manager_days_rule', detail:`Manager ${managerNameById.get(managerId)||managerId} scheduled ${actualDays} day(s), minimum is ${targetDays}`});
      }
    }
  }

  const weekStarts=weekStartsForPeriod(payload.period);
  for(let i=0;i<weekStarts.length;i++) {
    const weekIdx=i+1;
    const ws=weekStarts[i];
    for(const employee of employees) {
      const hours=Number((weeklyHours.get(`${employee.id}|${weekIdx}`)||0).toFixed(2));
      if(hours < Number(employee.min_hours_per_week||0)) {
        violations.push({date:ws, type:'hours_min_violation', detail:`${employee.name} scheduled ${formatHours(hours)}h, minimum is ${employee.min_hours_per_week}h`});
      }
      if(hours > Number(employee.max_hours_per_week||0)) {
        violations.push({date:ws, type:'hours_max_violation', detail:`${employee.name} scheduled ${formatHours(hours)}h, maximum is ${employee.max_hours_per_week}h`});
      }
    }
  }

  violations.sort((a,b)=>{
    if(a.date!==b.date) return a.date.localeCompare(b.date);
    if(a.type!==b.type) return a.type.localeCompare(b.type);
    return a.detail.localeCompare(b.detail);
  });
  return violations;
}

function groupSlots(assignments) {
  const byDate={};
  assignments.forEach(a=>{
    byDate[a.date] ||= { manager:[], leaders:[], clerks:[], captains:[], beachStaff:[] };
    if(a.role==='Store Manager') byDate[a.date].manager.push(a.employee_name);
    if(a.role==='Team Leader' && a.location==='Greystones') byDate[a.date].leaders.push(a.employee_name);
    if(a.role==='Store Clerk' && a.location==='Greystones') byDate[a.date].clerks.push(a.employee_name);
    if(a.role==='Boat Captain') byDate[a.date].captains.push(a.employee_name);
    if((a.role==='Team Leader' || a.role==='Store Clerk') && a.location==='Beach Shop') byDate[a.date].beachStaff.push(a.employee_name);
  });
  return byDate;
}

function allowedRolesForCol(col) {
  return {
    leaders: ['Team Leader'],
    clerks: ['Store Clerk'],
    captains: ['Boat Captain'],
    beachStaff: ['Team Leader','Store Clerk'],
  }[col] || [];
}

function candidateNamesForColumn(date, col) {
  if(col==='manager') return [];
  const allowedRoles=new Set(allowedRolesForCol(col));
  return getEmployeesFromTable()
    .filter(e=>allowedRoles.has(e.role))
    .map(e=>e.name)
    .filter(name=>{
      if(generatedAssignments.some(a=>a.date===date && colFor(a)===col && a.employee_name===name)) return false;
      const scheduledSameDay = generatedAssignments.some(a=>a.date===date && a.employee_name===name);
      if(!scheduledSameDay) return true;
      const hasStoreAssignment = generatedAssignments.some(a=>a.date===date && ['leaders','clerks'].includes(colFor(a)) && a.employee_name===name);
      return col==='beachStaff' && hasStoreAssignment;
    })
    .sort((a,b)=>a.localeCompare(b));
}

function renderAddControl(date, col) {
  if(col==='manager') return '';
  const names = candidateNamesForColumn(date, col);
  const options = names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
  return `<button type='button' class='zone-add' onclick='toggleAddInput(this)'>+</button><div class='zone-add-row' style='display:none;'><select class='zone-add-select' onchange='handleAddBySelect(event,"${date}","${col}")'><option value=''>Select employee</option>${options}</select></div>`;
}

function renderPills(names, date, col) {
  const pills = names.length ? names.map((n,idx)=>`<div class='pill' draggable='true' data-name='${n}' data-date='${date}' data-col='${col}' ondragstart='dragStart(event)'><span>${n}</span><button class='pill-remove' type='button' onclick='removeScheduled("${date}","${col}","${n.replace(/"/g,'&quot;')}")'>×</button></div>`).join('') : '<span class="muted">—</span>';
  return `${pills}${renderAddControl(date, col)}`;
}

function renderSchedule(assignments, editable=true, plain=false, showBeachShop=true) {
  const byDate=groupSlots(assignments);
  const dates=Object.keys(byDate).sort();
  const dropAttrs = editable ? "ondragover='allowDrop(event)' ondrop='dropPill(event)' ondragleave='handleDropzoneLeave(event)'" : "";
  const beachHeader = showBeachShop ? '<th>Beach Shop</th>' : '';
  const colgroup = showBeachShop
    ? '<colgroup><col style="width:22%"><col style="width:14%"><col style="width:14%"><col style="width:25%"><col style="width:11%"><col style="width:14%"></colgroup>'
    : '<colgroup><col style="width:24%"><col style="width:16%"><col style="width:16%"><col style="width:28%"><col style="width:16%"></colgroup>';
  return `<table class='schedule-table'>${colgroup}<thead><tr><th>Date</th><th>Manager</th><th>Team Leaders</th><th>Clerks</th><th>Captain</th>${beachHeader}</tr></thead><tbody>${dates.map(d=>{
    const day=byDate[d];
    const dateLabel=fmtDateWithDay(d);
    const manager = editable ? renderPills(day.manager,d,'manager') : renderPillsStatic(day.manager, plain);
    const leaders = editable ? renderPills(day.leaders,d,'leaders') : renderPillsStatic(day.leaders, plain);
    const clerks = editable ? renderPills(day.clerks,d,'clerks') : renderPillsStatic(day.clerks, plain);
    const captains = editable ? renderPills(day.captains,d,'captains') : renderPillsStatic(day.captains, plain);
    const beachStaff = editable ? renderPills(day.beachStaff,d,'beachStaff') : renderPillsStatic(day.beachStaff, true);
    const beachCell = showBeachShop ? `<td><div class='dropzone' data-date='${d}' data-col='beachStaff' ${dropAttrs}>${beachStaff}</div></td>` : '';
    return `<tr><td><strong>${dateLabel}</strong></td><td><div class='dropzone' data-date='${d}' data-col='manager' ${dropAttrs}>${manager}</div></td><td><div class='dropzone' data-date='${d}' data-col='leaders' ${dropAttrs}>${leaders}</div></td><td><div class='dropzone' data-date='${d}' data-col='clerks' ${dropAttrs}>${clerks}</div></td><td><div class='dropzone' data-date='${d}' data-col='captains' ${dropAttrs}>${captains}</div></td>${beachCell}</tr>`;
  }).join('')}</tbody></table>`;
}

function renderPillsStatic(names, plain=false) {
  if(!names.length) return '<span class="muted">—</span>';
  if(plain) return names.join(', ');
  return names.map(n=>`<div class='pill'>${n}</div>`).join('');
}

function buildSummary(assignments, period=null) {
  const startDay = period?.week_start_day || weekStartDay();
  const endDay = period?.week_end_day || weekEndDay();
  const dayEntries={};
  assignments.forEach(a=>{
    const day=parseDate(a.date);
    const ws=iso(weekStartForDate(day, startDay));
    const key=`${ws}|${a.employee_name}|${a.date}`;
    dayEntries[key] ||= { ws, name:a.employee_name, hasNonBeach:false, hasBeach:false, maxHours:0 };
    if(a.location==='Beach Shop') dayEntries[key].hasBeach=true;
    else dayEntries[key].hasNonBeach=true;
    dayEntries[key].maxHours = Math.max(dayEntries[key].maxHours, calcShiftHours(a.start, a.end));
  });
  const byWeek={};
  Object.values(dayEntries).forEach(entry=>{
    const ws=entry.ws;
    const key=`${ws}|${entry.name}`;
    byWeek[ws] ||= {};
    byWeek[ws][key] ||= {name:entry.name,days:0,hours:0};
    byWeek[ws][key].days += (entry.hasNonBeach ? 1 : 0.5);
    byWeek[ws][key].hours += entry.maxHours;
  });
  const weeks=Object.keys(byWeek).sort();
  if(!weeks.length) return '<p class="muted">No summary data.</p>';
  return `<h4 class='week-title'>Weekly Summary (${weekdayLabel(startDay)}-${weekdayLabel(endDay)})</h4>${weeks.map(week=>{
    const names=Object.values(byWeek[week]).sort((a,b)=>a.name.localeCompare(b.name));
    return `<h5 class='week-title'>Week of ${fmtDate(week)}</h5><table><thead><tr><th>Employee</th><th>Days Worked</th><th>Hours Worked</th></tr></thead><tbody>${names.map(r=>`<tr><td>${r.name}</td><td>${r.days.toFixed(1)}</td><td>${r.hours.toFixed(1)}</td></tr>`).join('')}</tbody></table>`;
  }).join('')}`;
}

function roleForName(name) { return getEmployeesFromTable().find(e=>e.name===name)?.role || ''; }
function colForRole(role) { return {'Store Manager':'manager','Team Leader':'leaders','Store Clerk':'clerks','Boat Captain':'captains'}[role] || ''; }
function removeScheduled(date, col, name, rerender=true) {
  const idx=generatedAssignments.findIndex(a=>a.date===date && colFor(a)===col && a.employee_name===name);
  if(idx>=0) { generatedAssignments.splice(idx,1); if(rerender) rerenderOutput(); }
}
function colFor(a) { if(a.role==='Store Manager') return 'manager'; if(a.role==='Team Leader'&&a.location==='Greystones') return 'leaders'; if(a.role==='Store Clerk'&&a.location==='Greystones') return 'clerks'; if(a.role==='Boat Captain') return 'captains'; if((a.role==='Team Leader'||a.role==='Store Clerk')&&a.location==='Beach Shop') return 'beachStaff'; return ''; }

function allowedColsForRole(role) {
  const baseCol=colForRole(role);
  if(baseCol==='leaders') return ['leaders','beachStaff'];
  if(baseCol==='clerks') return ['clerks','beachStaff'];
  return [baseCol];
}
function evaluateDropTarget(data, toDate, toCol) {
  if(!toDate || !toCol) return {ok:false, message:'That target cannot accept assignments.'};

  const employeeRole=roleForName(data.name);
  const allowedCols=allowedColsForRole(employeeRole);
  if(!allowedCols.includes(toCol)) {
    return {ok:false, message:`${data.name} can only be placed in an allowed column for their role.`};
  }

  const alreadyInTarget=generatedAssignments.some(a=>a.date===toDate && colFor(a)===toCol && a.employee_name===data.name);
  if(alreadyInTarget) {
    return {ok:false, message:`${data.name} is already in that column on ${fmtDate(toDate)}.`};
  }

  const alreadyScheduledThatDay=generatedAssignments.some(a=>a.date===toDate && a.employee_name===data.name);
  const hasStoreAssignmentThatDay=generatedAssignments.some(a=>a.date===toDate && ['leaders','clerks'].includes(colFor(a)) && a.employee_name===data.name);
  const allowStoreAndBeachDualPlacement=toCol==='beachStaff' && hasStoreAssignmentThatDay;
  if(alreadyScheduledThatDay && !allowStoreAndBeachDualPlacement) {
    return {ok:false, message:`${data.name} is already scheduled on ${fmtDate(toDate)}.`};
  }

  const roleMap={manager:'Store Manager', leaders:'Team Leader', clerks:'Store Clerk', captains:'Boat Captain'};
  const targetRole=toCol==='beachStaff' ? employeeRole : roleMap[toCol];
  if(toCol==='beachStaff' && !['Team Leader', 'Store Clerk'].includes(targetRole)) {
    return {ok:false, message:'Beach Shop only allows Team Leaders or Store Clerks.'};
  }

  return {ok:true, role:targetRole};
}
function resetDropzoneHighlights() {
  document.querySelectorAll('.dropzone').forEach(zone=>{
    zone.classList.remove('dropzone--active', 'dropzone--valid', 'dropzone--invalid');
  });
}
function clearDragState() {
  activeDragData=null;
  document.querySelectorAll('.pill--dragging').forEach(p=>p.classList.remove('pill--dragging'));
  resetDropzoneHighlights();
}
function handleDropzoneLeave(ev) {
  const zone=ev.currentTarget;
  if(!zone) return;
  if(ev.relatedTarget && zone.contains(ev.relatedTarget)) return;
  zone.classList.remove('dropzone--active', 'dropzone--valid', 'dropzone--invalid');
}
function dragStart(ev) {
  const pill=ev.target.closest('.pill');
  if(!pill) return;
  const data={name:pill.dataset.name, fromDate:pill.dataset.date||'', fromCol:pill.dataset.col||''};
  activeDragData=data;
  pill.classList.add('pill--dragging');
  ev.dataTransfer.setData('text/plain', JSON.stringify(data));
  ev.dataTransfer.effectAllowed='move';
}
function allowDrop(ev) {
  ev.preventDefault();
  const zone=ev.currentTarget;
  if(!zone) return;
  zone.classList.add('dropzone--active');
  if(!activeDragData || !generatedAssignments.length) {
    zone.classList.remove('dropzone--valid', 'dropzone--invalid');
    return;
  }
  const evaluation=evaluateDropTarget(activeDragData, zone.dataset.date, zone.dataset.col);
  zone.classList.toggle('dropzone--valid', evaluation.ok);
  zone.classList.toggle('dropzone--invalid', !evaluation.ok);
}
function autoScrollOnDrag(ev) {
  const margin=90;
  const speed=18;
  if(ev.clientY < margin) window.scrollBy(0, -speed);
  else if(window.innerHeight - ev.clientY < margin) window.scrollBy(0, speed);
}
function dropPill(ev) {
  ev.preventDefault();
  const raw=ev.dataTransfer?.getData('text/plain');
  const data=raw ? JSON.parse(raw) : activeDragData;
  if(!data) return;
  const target=ev.currentTarget;
  const toDate=target.dataset.date;
  const toCol=target.dataset.col;
  if(!generatedAssignments.length) { clearDragState(); return; }

  const evaluation=evaluateDropTarget(data, toDate, toCol);
  if(!evaluation.ok) {
    showMessage(evaluation.message, 'warn');
    showToast(evaluation.message, 'warn', 2300);
    clearDragState();
    return;
  }

  const isStoreToBeachCopy = data.fromDate===toDate && ['leaders','clerks'].includes(data.fromCol) && toCol==='beachStaff';
  if(data.fromDate && data.fromCol && !isStoreToBeachCopy) {
    removeScheduled(data.fromDate, data.fromCol, data.name, false);
  }

  const role=evaluation.role;
  const loc= toCol==='captains' ? 'Boat' : (toCol.startsWith('beach') ? 'Beach Shop' : 'Greystones');
  const employee=getEmployeesFromTable().find(e=>e.name===data.name);
  const hours=(currentDraftPayload?.hours || SAMPLE_PAYLOAD.hours);
  const start = loc==='Beach Shop' ? hours.beach_shop.start : hours.greystones.start;
  const end = loc==='Beach Shop' ? hours.beach_shop.end : hours.greystones.end;
  generatedAssignments.push({date:toDate,location:loc,start,end,employee_id:(employee?.id || slugifyName(data.name,0)),employee_name:data.name,role});
  rerenderOutput();
  clearDragState();
}

function toggleAddInput(btn) {
  const row=btn.nextElementSibling;
  if(!row) return;
  row.style.display = row.style.display==='none' ? 'flex' : 'none';
  if(row.style.display==='flex') row.querySelector('select')?.focus();
}

function handleAddBySelect(ev, date, col) {
  const name=(ev.target.value||'').trim();
  if(!name) return;
  const target=document.querySelector(`.dropzone[data-date='${date}'][data-col='${col}']`);
  if(!target) return;
  const mock={dataTransfer:{getData:()=>JSON.stringify({name,fromDate:'',fromCol:''})},currentTarget:target,preventDefault:()=>{}};
  dropPill(mock);
  ev.target.value='';
  const row=ev.target.closest('.zone-add-row');
  if(row) row.style.display='none';
}

async function finalizeSchedule() {
  if(!generatedAssignments.length || !currentDraftPeriod) return;
  const ok=await openDecisionModal({
    title:'Finalize Schedule',
    body:'This locks the current draft into previous schedules and clears the editable board.',
    confirmLabel:'Finalize',
    cancelLabel:'Keep Editing',
    confirmTone:'danger',
    showCancel:true,
  });
  if(!ok) return;
  const item={period:currentDraftPeriod,assignments:[...generatedAssignments],violations:[...liveViolations],created_at:new Date().toISOString(),finalized_at:new Date().toISOString()};
  saveHistory(item);
  renderHistory();
  generatedAssignments=[];
  currentDraftPeriod=null;
  currentDraftPayload=null;
  liveViolations=[];
  lastResponse=null;
  rerenderOutput();
  showMessage('Schedule finalized and saved to previous schedules.', 'success');
  showToast('Schedule finalized and archived.', 'success');
}

async function clearHistory() {
  const ok=await openDecisionModal({
    title:'Clear Previous Schedules',
    body:'This removes all saved schedule history. Employee roster data will not be changed.',
    confirmLabel:'Clear History',
    cancelLabel:'Cancel',
    confirmTone:'danger',
    showCancel:true,
  });
  if(!ok) return;
  localStorage.setItem(STORAGE_HIST, JSON.stringify([]));
  renderHistory();
  showMessage('Previous schedules cleared.', 'success');
  showToast('Previous schedules cleared.', 'success');
}

function exportSchedulePdf(historyIndex) {
  const hist=loadHistory();
  const item=hist[historyIndex];
  if(!item) return;
  const showBeach = !!item.period?.schedule_beach_shop || item.assignments.some(a=>a.location==='Beach Shop');
  const html=`<html><head><title>FOBE Finalized Schedule</title><style>@page{size:landscape;margin:10mm}body{font-family:Inter,Arial,sans-serif;padding:6px;color:#0f172a}h1{margin:0}p{margin:2px 0 6px;color:#475569}table{width:100%;border-collapse:collapse;margin-top:8px;font-size:10px;table-layout:fixed}th,td{border:1px solid #cbd5e1;padding:3px;text-align:left;vertical-align:top;word-wrap:break-word}th{background:#e2e8f0}.muted{color:#64748b}</style></head><body><h1>FOBE Finalized Schedule</h1><p>Start: ${fmtDateWithDay(item.period.start_date)} • Weeks: ${item.period.weeks}</p>${renderSchedule(item.assignments, false, true, showBeach)}</body></html>`;
  const win=window.open('', '_blank');
  if(!win) return;
  win.document.write(html);
  win.document.close();
  win.focus();
  win.print();
}

function loadHistory() { return JSON.parse(localStorage.getItem(STORAGE_HIST)||'[]'); }
function saveHistory(item) {
  const arr=loadHistory();
  arr.unshift(item);
  localStorage.setItem(STORAGE_HIST, JSON.stringify(arr.slice(0,12)));
}

function renderHistory() {
  const hist=loadHistory();
  if(!hist.length) { document.getElementById('history').innerHTML='No saved schedules yet.'; return; }
  document.getElementById('history').innerHTML = hist.map((h,idx)=>{
    const showBeach = !!h.period?.schedule_beach_shop || h.assignments.some(a=>a.location==='Beach Shop');
    return `<details ${idx===0?'open':''}><summary><strong>${fmtDateWithDay(h.period.start_date)}</strong> for ${h.period.weeks} week(s) — ${h.assignments.length} assignments</summary>${renderSchedule(h.assignments, false, false, showBeach)}${buildSummary(h.assignments, h.period)}<button onclick='exportSchedulePdf(${idx})'>Export PDF</button></details>`;
  }).join('');
}

function rerenderOutput() {
  if(currentDraftPeriod) refreshCurrentDraftPayload();
  const violations = currentDraftPayload
    ? computeLiveViolations(generatedAssignments, currentDraftPayload)
    : (lastResponse?.violations || []);
  liveViolations = violations;
  document.getElementById('result').innerHTML = (generatedAssignments.length ? renderSchedule(generatedAssignments, true, false, usesBeachShop(currentDraftPeriod)) + buildSummary(generatedAssignments, currentDraftPeriod) : "<p class='muted'>Generate to view schedule.</p>") + (violations.length?`<h4>Rule checks</h4><ul>${violations.map(v=>`<li>${v.date}: ${v.detail}</li>`).join('')}</ul>`:'<p>No violations.</p>');
  document.getElementById('finalize_btn').disabled = !generatedAssignments.length;
}

async function runGenerate() {
  saveEmployees();
  const nextToken = rerollCounter + 1;
  const payload=collectPayload(nextToken);
  const shortageDates=weekendLeaderShortageDates(payload);
  if(shortageDates.length) {
    const shortageList=shortageDates.map(fmtDateWithDay).join(', ');
    const ok = await openDecisionModal({
      title:'Potential Weekend Coverage Shortage',
      body:`Only one team leader is available on ${shortageList}. Continue with generation anyway?`,
      confirmLabel:'Proceed',
      cancelLabel:'Stop Generation',
      confirmTone:'danger',
      showCancel:true,
    });
    if(!ok) {
      showMessage('Generation cancelled. Update days off or staffing, then generate again.', 'warn');
      showToast('Generation cancelled before API call.', 'warn');
      return;
    }
  }
  rerollCounter = nextToken;
  const res=await fetch('/generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
  const json=await res.json();
  if(!res.ok) {
    const detail=typeof json?.detail === 'string' ? json.detail : 'Generate failed';
    showMessage(detail, 'danger');
    showToast(detail, 'danger', 3600);
    return;
  }
  lastResponse=json;
  currentDraftPayload=payload;
  currentDraftPeriod={...payload.period, week_start_day: payload.week_start_day, week_end_day: payload.week_end_day, schedule_beach_shop: payload.schedule_beach_shop};
  generatedAssignments=[...json.assignments];
  rerenderOutput();
  const beachViolations=liveViolations.filter(v=>v.type==='beach_shop_gap');
  if(beachViolations.length) {
    await openDecisionModal({
      title:'Beach Shop Rule Violation',
      body:'Beach Shop must have exactly 2 people whenever it is open. Adjust staffing parameters before finalizing.',
      confirmLabel:'Review',
      confirmTone:'danger',
      showCancel:false,
    });
  }
  showMessage(`Generated ${json.assignments.length} assignments. Review and finalize to save.`, 'success');
  showToast(`Generated ${json.assignments.length} assignments.`, 'success');
}

function loadSampleData() {
  const employees=loadEmployees();
  document.getElementById('employee_rows').innerHTML='';
  employees.forEach(e=>document.getElementById('employee_rows').insertAdjacentHTML('beforeend', employeeRowHtml(e)));
  refreshRoleOptions();
  syncOverrides();
  document.getElementById('extra_rows').innerHTML='';
  (SAMPLE_PAYLOAD.extra_coverage_days||[]).forEach(addExtraRow);
  document.getElementById('time_off_rows').innerHTML='';
  (SAMPLE_PAYLOAD.unavailability||[]).forEach(addTimeOffRow);
  const weekStartEl=document.getElementById('week_start_day');
  weekStartEl.innerHTML = DAY_KEYS.map(day=>`<option value='${day}'>${weekdayLabel(day)}</option>`).join('');
  weekStartEl.value = SAMPLE_PAYLOAD.week_start_day || 'sun';
  const startInput=document.getElementById('period_start');
  startInput.value = iso(nextOrSameWeekday(new Date(), weekStartDay()));
  alignPeriodStartToBoundary();
  document.getElementById('period_weeks').value = SAMPLE_PAYLOAD.period.weeks;
  document.getElementById('schedule_beach_shop').checked = !!SAMPLE_PAYLOAD.schedule_beach_shop;
  updateWeekBoundaryNote();
  renderOpenDaySelectors();
}

document.getElementById('employee_rows').addEventListener('input', ()=>{ saveEmployees(); syncOverrides(); });
document.getElementById('period_start').addEventListener('change', ()=>{ alignPeriodStartToBoundary(); renderOpenDaySelectors(); });
document.getElementById('period_weeks').addEventListener('change', renderOpenDaySelectors);
document.getElementById('week_start_day').addEventListener('change', handleWeekBoundaryChange);
document.addEventListener('change', (ev)=>{
  if(ev.target?.classList?.contains('open-day')) syncOpenDayChipStates();
  if(ev.target?.classList?.contains('extra-date')) {
    applyScheduleWindowToDateInputs();
    rerenderOutput();
  }
  if(ev.target?.classList?.contains('to-emp') || ev.target?.classList?.contains('to-date')) {
    refreshTimeOffDateOptions({notify:true});
    rerenderOutput();
  }
});
document.addEventListener('dragover', autoScrollOnDrag);
document.addEventListener('dragend', clearDragState);
wireModalEvents();
loadSampleData();
renderHistory();
rerenderOutput();
</script>
</body>
</html>
