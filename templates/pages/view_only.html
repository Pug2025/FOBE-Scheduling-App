<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FOBE Schedule Viewer</title>
  <style>
    :root {
      --surface-page: #eef3ee;
      --surface-card: #ffffff;
      --surface-subtle: #f5f8f4;
      --text: #1f2a23;
      --muted: #4f6258;
      --border: #cad6cf;
      --border-strong: #9cb2a4;
      --brand: #2f4a3a;
      --brand-strong: #1f3528;
      --warn: #8d3f33;
      --success: #2d5e43;
      --radius: 16px;
      --radius-sm: 12px;
      --shadow: 0 14px 30px rgba(31, 42, 35, 0.08);
    }
    * { box-sizing: border-box; }
    html,
    body {
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      font-family: "Avenir Next", "Segoe UI", sans-serif;
      color: var(--text);
      background:
        radial-gradient(circle at 8% -8%, #dce8df 0%, transparent 34%),
        radial-gradient(circle at 100% 0%, #d2e1d7 0%, transparent 30%),
        linear-gradient(168deg, #f8faf7 0%, var(--surface-page) 50%, #e7eee9 100%);
    }
    .page-shell {
      width: min(1300px, 100% - 1rem);
      margin: .75rem auto 1.4rem;
      padding-bottom: calc(1.2rem + env(safe-area-inset-bottom));
    }
    .header {
      display: grid;
      gap: .9rem;
      margin-bottom: .9rem;
      background: rgba(255, 255, 255, 0.92);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: .9rem .95rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(2px);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: .75rem;
      min-width: 0;
    }
    .brand img {
      height: 42px;
      width: auto;
      flex: 0 0 auto;
    }
    .brand h1 {
      margin: 0;
      font-size: clamp(1.05rem, 2vw + .55rem, 1.42rem);
      font-weight: 800;
      line-height: 1.2;
      color: var(--brand);
    }
    .brand p {
      margin: .14rem 0 0;
      color: var(--muted);
      font-size: .89rem;
    }
    .header-actions {
      display: grid;
      gap: .45rem;
      justify-items: stretch;
    }
    .session {
      margin: 0;
      color: var(--muted);
      font-size: .86rem;
      text-align: left;
      word-break: break-word;
    }
    button {
      border: 1px solid var(--brand-strong);
      border-radius: 11px;
      padding: .63rem .92rem;
      font-weight: 700;
      cursor: pointer;
      background: linear-gradient(165deg, #2f4a3a 0%, #274131 100%);
      color: #fff;
      transition:
        transform .14s ease,
        box-shadow .14s ease,
        background .18s ease;
      min-height: 44px;
    }
    button:hover {
      background: linear-gradient(165deg, #274131 0%, #1f3528 100%);
      box-shadow: 0 8px 16px rgba(31, 53, 40, 0.25);
      transform: translateY(-1px);
    }
    button:disabled {
      opacity: .58;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .feedback {
      margin: 0 0 .9rem;
      padding: .7rem .8rem;
      border-radius: 11px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
      font-size: .93rem;
    }
    .feedback[data-tone='danger'] {
      border-color: #d6a09b;
      color: var(--warn);
      background: #fff8f7;
    }
    .feedback[data-tone='success'] {
      border-color: #b8d4c0;
      color: var(--success);
      background: #f5fbf7;
    }
    .hidden { display: none !important; }
    .main-layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: .95rem;
      align-items: start;
    }
    .schedule-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: .95rem;
      min-width: 0;
    }
    .card {
      background: var(--surface-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: .92rem;
      box-shadow: var(--shadow);
    }
    .card h2 {
      margin: 0;
      font-size: clamp(1.04rem, 1.5vw + .62rem, 1.22rem);
      color: var(--brand);
      line-height: 1.24;
    }
    .card-head {
      display: flex;
      justify-content: space-between;
      gap: .7rem;
      align-items: baseline;
      flex-wrap: wrap;
      margin-bottom: .68rem;
    }
    .card-head p {
      margin: 0;
      font-size: .88rem;
      color: var(--muted);
    }
    .dayoff-form {
      display: grid;
      grid-template-columns: 1fr;
      gap: .7rem;
      align-items: end;
      padding: .8rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface-subtle);
      margin-bottom: .78rem;
    }
    .dayoff-form label {
      display: grid;
      gap: .34rem;
      font-size: .87rem;
      color: var(--muted);
      font-weight: 700;
    }
    .dayoff-form input,
    .dayoff-form textarea {
      border: 1px solid var(--border-strong);
      border-radius: 10px;
      padding: .66rem .72rem;
      font: inherit;
      color: inherit;
      background: #fff;
      box-shadow: inset 0 1px 2px rgba(31, 42, 35, .08);
      appearance: none;
      -webkit-appearance: none;
      min-height: 46px;
    }
    .dayoff-form textarea {
      min-height: 88px;
      resize: vertical;
    }
    .dayoff-form input:focus,
    .dayoff-form textarea:focus {
      outline: none;
      border-color: #607969;
      box-shadow: 0 0 0 3px rgba(95, 120, 105, .16);
    }
    .dayoff-submit {
      width: 100%;
    }
    .dayoff-feedback {
      margin: 0 0 .75rem;
      padding: .58rem .7rem;
      border-radius: 9px;
      border: 1px solid var(--border);
      font-size: .9rem;
      color: var(--muted);
      background: #fff;
    }
    .dayoff-feedback[data-tone='danger'] {
      border-color: #d6a09b;
      color: var(--warn);
      background: #fff8f7;
    }
    .dayoff-feedback[data-tone='success'] {
      border-color: #b6d0be;
      color: var(--success);
      background: #f6fbf8;
    }
    .dayoff-list {
      display: grid;
      gap: .56rem;
    }
    .dayoff-history-toggle {
      border: 1px dashed #bfd0c6;
      border-radius: 10px;
      padding: .48rem .58rem;
      background: #f7faf7;
    }
    .dayoff-history-toggle > summary {
      cursor: pointer;
      color: var(--brand);
      font-weight: 700;
      font-size: .9rem;
      list-style: none;
    }
    .dayoff-history-toggle > summary::-webkit-details-marker {
      display: none;
    }
    .dayoff-history-body {
      margin-top: .52rem;
      display: grid;
      gap: .56rem;
    }
    .dayoff-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      padding: .68rem .74rem;
    }
    .dayoff-item-top {
      display: flex;
      justify-content: space-between;
      gap: .6rem;
      align-items: baseline;
      flex-wrap: wrap;
      margin-bottom: .25rem;
    }
    .dayoff-item p {
      margin: .12rem 0;
      color: var(--muted);
      font-size: .88rem;
    }
    .status-chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: .74rem;
      text-transform: uppercase;
      letter-spacing: .04em;
      padding: .15rem .5rem;
      font-weight: 800;
      background: #f2f5f2;
      color: #2e4135;
      white-space: nowrap;
    }
    .status-chip[data-status='approved'] {
      border-color: #b6d0be;
      background: #eff8f1;
      color: #2d5e43;
    }
    .status-chip[data-status='rejected'] {
      border-color: #d6a09b;
      background: #fff2f1;
      color: var(--warn);
    }
    .status-chip[data-status='cancelled'] {
      border-color: #cdd5d1;
      background: #f3f5f4;
      color: #556660;
    }
    .status-chip[data-status='pending'] {
      border-color: #d7c896;
      background: #fff7e3;
      color: #6f5420;
    }
    .item-actions {
      margin-top: .44rem;
      display: flex;
      gap: .5rem;
      flex-wrap: wrap;
    }
    .item-actions button {
      padding: .46rem .73rem;
      font-size: .82rem;
      min-height: 40px;
    }
    .schedule-card {
      padding: .9rem;
    }
    .schedule-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: .45rem .75rem;
    }
    .schedule-head h2 {
      margin: 0;
    }
    .schedule-slot {
      margin: 0;
      font-size: .82rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .04em;
      font-weight: 700;
    }
    .meta {
      margin: .56rem 0 .88rem;
      display: flex;
      flex-wrap: wrap;
      gap: .44rem;
    }
    .meta-badge {
      display: inline-flex;
      align-items: center;
      border: 1px solid #cfdbd3;
      border-radius: 999px;
      background: #f6faf7;
      color: var(--muted);
      font-size: .79rem;
      font-weight: 700;
      padding: .2rem .55rem;
      max-width: 100%;
      overflow-wrap: anywhere;
    }
    .schedule-mobile-list {
      display: grid;
      gap: .56rem;
    }
    .day-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
    }
    .day-card > summary {
      list-style: none;
      display: grid;
      gap: .42rem;
      cursor: pointer;
      padding: .66rem .7rem;
      background: linear-gradient(170deg, #f5faf5 0%, #eef5ef 100%);
      border-bottom: 1px solid #d9e2dc;
    }
    .day-card > summary::-webkit-details-marker {
      display: none;
    }
    .day-card-title {
      margin: 0;
      font-weight: 800;
      color: var(--brand);
      font-size: .92rem;
      line-height: 1.24;
    }
    .day-counts {
      display: flex;
      flex-wrap: wrap;
      gap: .28rem;
    }
    .day-count-chip {
      display: inline-flex;
      align-items: center;
      gap: .2rem;
      border-radius: 999px;
      border: 1px solid #c9d7ce;
      background: #f9fcf9;
      color: var(--muted);
      font-size: .74rem;
      padding: .14rem .46rem;
      font-weight: 700;
    }
    .day-count-chip strong {
      color: var(--brand);
      font-size: .78rem;
      min-width: 1ch;
    }
    .day-grid {
      display: grid;
      gap: .52rem;
      padding: .66rem .7rem .72rem;
    }
    .day-role {
      display: grid;
      gap: .26rem;
    }
    .day-role-label {
      margin: 0;
      font-size: .78rem;
      letter-spacing: .05em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 800;
    }
    .schedule-desktop-wrap {
      display: none;
    }
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .88rem;
      min-width: 760px;
    }
    .schedule-table th,
    .schedule-table td {
      border: 1px solid var(--border);
      padding: .52rem .56rem;
      vertical-align: top;
      text-align: left;
    }
    .schedule-table th {
      background: #edf3ee;
      color: #2b3f32;
      font-size: .77rem;
      letter-spacing: .04em;
      text-transform: uppercase;
      font-weight: 800;
    }
    .schedule-table tbody tr:nth-child(even) td {
      background: #fbfcfb;
    }
    .pill-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: .32rem;
    }
    .pill {
      background: #edf4ee;
      border: 1px solid #c7d7cd;
      border-radius: 999px;
      padding: .14rem .52rem;
      font-size: .8rem;
      white-space: nowrap;
    }
    .empty-value {
      font-size: .82rem;
      color: #6a7b71;
    }
    .muted { color: var(--muted); }
    @media (min-width: 680px) {
      .page-shell {
        width: min(1300px, 100% - 1.6rem);
        margin-top: 1rem;
      }
      .header {
        grid-template-columns: minmax(0, 1fr) auto;
        align-items: center;
        padding: 1rem 1.06rem;
      }
      .header-actions {
        justify-items: end;
      }
      .session {
        text-align: right;
      }
      .dayoff-form {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .dayoff-form .span-2 {
        grid-column: 1 / -1;
      }
      .dayoff-submit {
        grid-column: 1 / -1;
        justify-self: end;
        width: auto;
        min-width: 220px;
      }
    }
    @media (min-width: 980px) {
      .page-shell {
        width: min(1320px, 100% - 2.4rem);
        margin-top: 1.2rem;
      }
      .main-layout {
        grid-template-columns: minmax(340px, 420px) minmax(0, 1fr);
        gap: 1.15rem;
      }
      .dayoff-panel {
        position: sticky;
        top: 1rem;
      }
      .schedule-card {
        padding: 1rem 1.05rem;
      }
      .schedule-mobile-list {
        display: none;
      }
      .schedule-desktop-wrap {
        display: block;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <div class="page-shell">
    <header class="header">
      <div class="brand">
        <img src="/static/brand/logo-full.svg" alt="Friends of Bon Echo Park logo">
        <div>
          <h1>FOBE Schedule Viewer</h1>
          <p>Most recent saved schedules</p>
        </div>
      </div>
      <div class="header-actions">
        <p id="session_user" class="session"></p>
        <button id="logout_btn" type="button">Logout</button>
      </div>
    </header>

    <p id="feedback" class="feedback hidden"></p>
    <div class="main-layout">
      <section class="card dayoff-panel">
        <div class="card-head">
          <h2>Request Days Off</h2>
          <p>Requests must begin at least 14 days from today.</p>
        </div>
        <form id="dayoff_form" class="dayoff-form">
          <label>Start Date <input id="dayoff_start" type="date" required></label>
          <label>End Date <input id="dayoff_end" type="date" required></label>
          <label class="span-2">Reason (optional) <textarea id="dayoff_reason" placeholder="Vacation, appointment, etc."></textarea></label>
          <button id="dayoff_submit" class="dayoff-submit" type="submit">Submit Request</button>
        </form>
        <p id="dayoff_link_warning" class="dayoff-feedback hidden"></p>
        <p id="dayoff_feedback" class="dayoff-feedback hidden"></p>
        <div id="dayoff_list" class="dayoff-list"><p class="muted">No requests yet.</p></div>
      </section>
      <main id="schedules" class="schedule-grid" aria-live="polite"></main>
    </div>
  </div>

  <script>
    let currentUser=null;

    function esc(value) {
      return String(value).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    }
    function canonicalUserRole(role='') {
      return role === 'user' ? 'view_only' : role;
    }
    function fmtDateWithDay(s) {
      return new Date(s + 'T00:00:00').toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'short', day:'numeric' });
    }
    function fmtDateTime(s) {
      return new Date(s).toLocaleString();
    }
    function setFeedback(msg, tone='neutral') {
      const el=document.getElementById('feedback');
      if(!msg) {
        el.textContent='';
        el.classList.add('hidden');
        el.removeAttribute('data-tone');
        return;
      }
      el.textContent=msg;
      el.dataset.tone=tone;
      el.classList.remove('hidden');
    }
    async function apiFetch(path, options={}) {
      const res=await fetch(path, { credentials:'include', cache:'no-store', ...options });
      let data=null;
      const text=await res.text();
      if(text) {
        try { data=JSON.parse(text); } catch { data={detail:text}; }
      }
      if(!res.ok) {
        const detail=typeof data?.detail==='string' ? data.detail : `${res.status} ${res.statusText}`;
        const err=new Error(detail);
        err.status=res.status;
        throw err;
      }
      return data;
    }
    function isoDate(d) {
      const year=d.getFullYear();
      const month=String(d.getMonth()+1).padStart(2, '0');
      const day=String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    function minDayOffDate() {
      const d=new Date();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate()+14);
      return isoDate(d);
    }
    function setDayOffFeedback(msg='', tone='neutral') {
      const el=document.getElementById('dayoff_feedback');
      if(!msg) {
        el.textContent='';
        el.classList.add('hidden');
        el.removeAttribute('data-tone');
        return;
      }
      el.textContent=msg;
      el.dataset.tone=tone;
      el.classList.remove('hidden');
    }
    function setDayOffLinkWarning(msg='') {
      const el=document.getElementById('dayoff_link_warning');
      if(!msg) {
        el.textContent='';
        el.classList.add('hidden');
        el.removeAttribute('data-tone');
        return;
      }
      el.textContent=msg;
      el.dataset.tone='danger';
      el.classList.remove('hidden');
    }
    function viewerCanRequestDaysOff() {
      return !!currentUser?.linked_employee_id;
    }
    function applyDayOffPermissions() {
      const canRequest=viewerCanRequestDaysOff();
      const form=document.getElementById('dayoff_form');
      const submit=document.getElementById('dayoff_submit');
      form.querySelectorAll('input, textarea').forEach(el=>{ el.disabled=!canRequest; });
      submit.disabled=!canRequest;
      if(!canRequest) {
        setDayOffLinkWarning('This account is not linked to a roster employee. Contact an administrator to link your account before requesting days off.');
      } else {
        setDayOffLinkWarning('');
      }
    }
    function dayOffStatusLabel(status='pending') {
      return status.replaceAll('_', ' ');
    }
    function renderDayOffRequests(items=[]) {
      const wrap=document.getElementById('dayoff_list');
      if(!Array.isArray(items) || !items.length) {
        wrap.innerHTML="<p class='muted'>No day-off requests yet.</p>";
        return;
      }
      const requestCardHtml=(item)=>{
        const reason=item.reason ? `<p><strong>Requested reason:</strong> ${esc(item.reason)}</p>` : '';
        const decisionReason=item.status==='rejected' && item.decision_reason
          ? `<p><strong>Rejected reason:</strong> ${esc(item.decision_reason)}</p>`
          : '';
        const cancelledReason=item.status==='cancelled' && item.cancelled_reason
          ? `<p><strong>Cancellation reason:</strong> ${esc(item.cancelled_reason)}</p>`
          : '';
        const lockNote=item.locked_by_schedule ? "<p><strong>Locked:</strong> A schedule already exists for part of this range.</p>" : '';
        const canCancel=item.status==='pending' || (item.status==='approved' && !item.locked_by_schedule);
        const actionBtn=canCancel ? `<div class='item-actions'><button type='button' onclick='cancelMyDayOffRequest(${item.id})'>Cancel Request</button></div>` : '';
        return `<article class='dayoff-item'><div class='dayoff-item-top'><strong>${esc(fmtDateWithDay(item.start_date))} to ${esc(fmtDateWithDay(item.end_date))}</strong><span class='status-chip' data-status='${esc(item.status)}'>${esc(dayOffStatusLabel(item.status))}</span></div>${reason}${decisionReason}${cancelledReason}${lockNote}${actionBtn}</article>`;
      };
      const currentItems=items.filter(item=>!item.locked_by_schedule);
      const previousItems=items.filter(item=>item.locked_by_schedule);
      const parts=[
        currentItems.length
          ? currentItems.map(requestCardHtml).join('')
          : "<p class='muted'>No current day-off requests.</p>",
      ];
      if(previousItems.length) {
        parts.push(`<details class='dayoff-history-toggle'><summary>Previous day-off requests (${previousItems.length})</summary><div class='dayoff-history-body'>${previousItems.map(requestCardHtml).join('')}</div></details>`);
      }
      wrap.innerHTML=parts.join('');
    }
    async function loadMyDayOffRequests() {
      if(!viewerCanRequestDaysOff()) {
        renderDayOffRequests([]);
        setDayOffFeedback('');
        return;
      }
      try {
        const items=await apiFetch('/api/day-off-requests/me');
        renderDayOffRequests(Array.isArray(items) ? items : []);
        setDayOffFeedback('');
      } catch (err) {
        renderDayOffRequests([]);
        if(err.status===404) {
          setDayOffFeedback('Day-off request service is unavailable. Restart the app server and try again.', 'danger');
          return;
        }
        setDayOffFeedback(err.message || 'Failed to load day-off requests.', 'danger');
      }
    }
    async function submitDayOffRequest(ev) {
      ev.preventDefault();
      if(!viewerCanRequestDaysOff()) {
        setDayOffFeedback('This account is not linked to a roster employee.', 'danger');
        return;
      }
      const start=document.getElementById('dayoff_start').value;
      const end=document.getElementById('dayoff_end').value;
      const reason=document.getElementById('dayoff_reason').value.trim();
      if(!start || !end) {
        setDayOffFeedback('Start and end dates are required.', 'danger');
        return;
      }
      if(end < start) {
        setDayOffFeedback('End date must be on or after start date.', 'danger');
        return;
      }
      try {
        await apiFetch('/api/day-off-requests/me', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({start_date:start, end_date:end, reason}),
        });
        document.getElementById('dayoff_reason').value='';
        setFeedback('Day-off request submitted and sent for admin approval.', 'success');
        setDayOffFeedback('Day-off request submitted.', 'success');
        await loadMyDayOffRequests();
      } catch (err) {
        if(err.status===404) {
          setDayOffFeedback('Day-off request service is unavailable. Restart the app server and try again.', 'danger');
          return;
        }
        setDayOffFeedback(err.message || 'Failed to submit day-off request.', 'danger');
      }
    }
    async function cancelMyDayOffRequest(requestId) {
      if(!viewerCanRequestDaysOff()) return;
      const confirmed=window.confirm('Cancel this day-off request?');
      if(!confirmed) return;
      try {
        await apiFetch(`/api/day-off-requests/me/${requestId}/cancel`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({reason:''}),
        });
        setDayOffFeedback('Day-off request cancelled.', 'success');
        await loadMyDayOffRequests();
      } catch (err) {
        if(err.status===404) {
          setDayOffFeedback('Day-off request service is unavailable. Restart the app server and try again.', 'danger');
          return;
        }
        setDayOffFeedback(err.message || 'Failed to cancel day-off request.', 'danger');
      }
    }
    function applyDayOffDateMinimums() {
      const min=minDayOffDate();
      const start=document.getElementById('dayoff_start');
      const end=document.getElementById('dayoff_end');
      start.min=min;
      end.min=min;
      if(!start.value) start.value=min;
      if(!end.value) end.value=min;
      start.addEventListener('change', ()=>{
        if(end.value < start.value) end.value=start.value;
      });
    }
    async function ensureViewOnlyUser() {
      try {
        currentUser=await apiFetch('/auth/me');
        currentUser.role=canonicalUserRole(currentUser.role);
      } catch {
        window.location.replace('/');
        return false;
      }
      if(currentUser.role !== 'view_only') {
        window.location.replace('/');
        return false;
      }
      if(currentUser.must_change_password) {
        window.location.replace('/');
        return false;
      }
      document.getElementById('session_user').textContent=`Signed in as ${currentUser.email}`;
      applyDayOffPermissions();
      return true;
    }
    async function handleLogout() {
      try {
        await apiFetch('/auth/logout', { method:'POST' });
      } catch {
        // Ignore logout API errors; we still redirect to sign-in.
      }
      window.location.replace('/');
    }
    function groupSlots(assignments=[]) {
      const byDate={};
      assignments.forEach(a=>{
        byDate[a.date] ||= { manager:[], leaders:[], clerks:[], captains:[], beachStaff:[] };
        if(a.role==='Store Manager') byDate[a.date].manager.push(a.employee_name);
        if(a.role==='Team Leader' && a.location==='Greystones') byDate[a.date].leaders.push(a.employee_name);
        if(a.role==='Store Clerk' && a.location==='Greystones') byDate[a.date].clerks.push(a.employee_name);
        if(a.role==='Boat Captain') byDate[a.date].captains.push(a.employee_name);
        if((a.role==='Team Leader' || a.role==='Store Clerk') && a.location==='Beach Shop') byDate[a.date].beachStaff.push(a.employee_name);
      });
      return byDate;
    }
    function renderPills(names=[]) {
      if(!names.length) return "<span class='empty-value'>Unassigned</span>";
      return `<div class='pill-wrap'>${names.map(name=>`<span class='pill'>${esc(name)}</span>`).join('')}</div>`;
    }
    function renderDayCount(label, count) {
      return `<span class='day-count-chip'><strong>${count}</strong>${esc(label)}</span>`;
    }
    function renderDayRole(label, names=[]) {
      return `<div class='day-role'><p class='day-role-label'>${esc(label)}</p>${renderPills(names)}</div>`;
    }
    function renderSchedule(assignments=[]) {
      const byDate=groupSlots(assignments);
      const dates=Object.keys(byDate).sort();
      if(!dates.length) return "<p class='muted'>No assignments in this saved schedule.</p>";
      const showBeach = assignments.some(a=>a.location==='Beach Shop');
      const beachHeader = showBeach ? '<th>Beach Shop</th>' : '';
      const desktopRows=dates.map(d=>{
        const day=byDate[d];
        const beachCell = showBeach ? `<td>${renderPills(day.beachStaff)}</td>` : '';
        return `<tr><td><strong>${esc(fmtDateWithDay(d))}</strong></td><td>${renderPills(day.manager)}</td><td>${renderPills(day.leaders)}</td><td>${renderPills(day.clerks)}</td><td>${renderPills(day.captains)}</td>${beachCell}</tr>`;
      }).join('');
      const mobileCards=dates.map((d, idx)=>{
        const day=byDate[d];
        const counts=[
          renderDayCount('Mgr', day.manager.length),
          renderDayCount('Lead', day.leaders.length),
          renderDayCount('Clerk', day.clerks.length),
          renderDayCount('Captain', day.captains.length),
        ];
        if(showBeach) counts.push(renderDayCount('Beach', day.beachStaff.length));
        const rows=[
          renderDayRole('Manager', day.manager),
          renderDayRole('Team Leaders', day.leaders),
          renderDayRole('Clerks', day.clerks),
          renderDayRole('Captain', day.captains),
        ];
        if(showBeach) rows.push(renderDayRole('Beach Shop', day.beachStaff));
        return `<details class='day-card' ${idx===0 ? 'open' : ''}><summary><p class='day-card-title'>${esc(fmtDateWithDay(d))}</p><div class='day-counts'>${counts.join('')}</div></summary><div class='day-grid'>${rows.join('')}</div></details>`;
      }).join('');
      return `<div class='schedule-mobile-list'>${mobileCards}</div><div class='schedule-desktop-wrap'><table class='schedule-table'><thead><tr><th>Date</th><th>Manager</th><th>Team Leaders</th><th>Clerks</th><th>Captain</th>${beachHeader}</tr></thead><tbody>${desktopRows}</tbody></table></div>`;
    }
    function renderSchedules(items=[]) {
      const wrap=document.getElementById('schedules');
      if(!items.length) {
        wrap.innerHTML="<section class='card schedule-card'><h2>No saved schedules yet</h2><p class='muted'>A manager or administrator must finalize a schedule before it appears here.</p></section>";
        setFeedback('No saved schedules are available yet.');
        return;
      }
      const labels=['Most Recent Saved Schedule', 'Previously Saved Schedule'];
      wrap.innerHTML = items.map((item, idx)=>{
        const title=(item.label || `Schedule ${item.period_start}`).trim();
        const slot=labels[idx] || `Saved Schedule ${idx + 1}`;
        const meta=[
          `<span class='meta-badge'>${esc(fmtDateWithDay(item.period_start))}</span>`,
          `<span class='meta-badge'>${item.weeks} week(s)</span>`,
          `<span class='meta-badge'>saved ${esc(fmtDateTime(item.created_at))}</span>`,
          `<span class='meta-badge'>by ${esc(item.created_by_email)}</span>`,
        ].join('');
        return `<section class='card schedule-card'><div class='schedule-head'><h2>${esc(slot)}</h2><p class='schedule-slot'>${esc(title)}</p></div><p class='meta'>${meta}</p>${renderSchedule(item.assignments || [])}</section>`;
      }).join('');
      setFeedback('');
    }
    async function loadSchedules() {
      const items=await apiFetch('/api/view-only/schedules');
      renderSchedules(Array.isArray(items) ? items : []);
    }

    document.getElementById('logout_btn').addEventListener('click', handleLogout);
    document.getElementById('dayoff_form').addEventListener('submit', submitDayOffRequest);
    applyDayOffDateMinimums();
    (async function init() {
      const ok=await ensureViewOnlyUser();
      if(!ok) return;
      setFeedback('Loading schedules...');
      try {
        await loadSchedules();
        await loadMyDayOffRequests();
      } catch (err) {
        setFeedback(err.message || 'Failed to load saved schedules.', 'danger');
      }
    })();
  </script>
</body>
</html>
