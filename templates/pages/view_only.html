<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>FOBE Schedule Viewer</title>
  <style>
    :root {
      --bg: #f2f4f1;
      --card: #ffffff;
      --text: #1f2a23;
      --muted: #4d5b53;
      --border: #d3dbd6;
      --brand: #2f4a3a;
      --brand-2: #6f8160;
      --warn: #8d3f33;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Avenir Next", "Segoe UI", sans-serif;
      background: linear-gradient(165deg, #f7f9f5 0%, #edf1eb 45%, #e6ece8 100%);
      color: var(--text);
    }
    .container {
      width: min(1240px, 100% - 2rem);
      margin: 1.5rem auto 2.5rem;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem 1.2rem;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: .9rem;
    }
    .brand img { height: 44px; width: auto; }
    .brand h1 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--brand);
    }
    .brand p {
      margin: .2rem 0 0;
      color: var(--muted);
      font-size: .92rem;
    }
    .header-actions {
      display: grid;
      gap: .45rem;
      justify-items: end;
    }
    .session {
      margin: 0;
      color: var(--muted);
      font-size: .9rem;
    }
    button {
      border: 1px solid transparent;
      border-radius: 10px;
      padding: .55rem .95rem;
      font-weight: 700;
      cursor: pointer;
      background: var(--brand);
      color: #fff;
    }
    button:hover { background: #1f3528; }
    .feedback {
      margin: 0 0 1rem;
      padding: .7rem .85rem;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
    }
    .feedback[data-tone='danger'] {
      border-color: #d6a09b;
      color: var(--warn);
      background: #fff8f7;
    }
    .hidden { display: none !important; }
    .schedule-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
    }
    .card h2 {
      margin: 0;
      font-size: 1.15rem;
      color: var(--brand);
    }
    .card-head {
      display: flex;
      justify-content: space-between;
      gap: .8rem;
      align-items: baseline;
      flex-wrap: wrap;
      margin-bottom: .65rem;
    }
    .card-head p {
      margin: 0;
      font-size: .88rem;
      color: var(--muted);
    }
    .dayoff-form {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: .65rem;
      align-items: end;
      padding: .75rem;
      border: 1px solid #c8d3cd;
      border-radius: 12px;
      background: #f8fbf8;
      margin-bottom: .8rem;
    }
    .dayoff-form label {
      display: grid;
      gap: .3rem;
      font-size: .85rem;
      color: var(--muted);
      font-weight: 600;
    }
    .dayoff-form input,
    .dayoff-form textarea {
      border: 1px solid #b7c5bd;
      border-radius: 10px;
      padding: .56rem .62rem;
      font: inherit;
      color: inherit;
      background: #fff;
      box-shadow: inset 0 1px 2px rgba(31,42,35,.05);
      appearance: none;
      -webkit-appearance: none;
    }
    .dayoff-form textarea {
      min-height: 70px;
      resize: vertical;
    }
    .dayoff-form input:focus,
    .dayoff-form textarea:focus {
      outline: none;
      border-color: #6f8160;
      box-shadow: 0 0 0 3px rgba(111,129,96,.18);
    }
    .dayoff-form .span-2 {
      grid-column: span 2;
    }
    .dayoff-feedback {
      margin: 0 0 .8rem;
      padding: .55rem .65rem;
      border-radius: 9px;
      border: 1px solid var(--border);
      font-size: .9rem;
      color: var(--muted);
      background: #fff;
    }
    .dayoff-feedback[data-tone='danger'] {
      border-color: #d6a09b;
      color: var(--warn);
      background: #fff8f7;
    }
    .dayoff-feedback[data-tone='success'] {
      border-color: #b6d0be;
      color: #2f5d43;
      background: #f6fbf8;
    }
    .dayoff-list {
      display: grid;
      gap: .55rem;
    }
    .dayoff-history-toggle {
      border: 1px dashed #c3d0c9;
      border-radius: 10px;
      padding: .45rem .56rem;
      background: #f8fbf8;
    }
    .dayoff-history-toggle > summary {
      cursor: pointer;
      color: var(--brand);
      font-weight: 700;
      font-size: .9rem;
    }
    .dayoff-history-body {
      margin-top: .5rem;
      display: grid;
      gap: .55rem;
    }
    .dayoff-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      padding: .65rem .72rem;
    }
    .dayoff-item-top {
      display: flex;
      justify-content: space-between;
      gap: .6rem;
      align-items: baseline;
      flex-wrap: wrap;
      margin-bottom: .25rem;
    }
    .dayoff-item p {
      margin: .12rem 0;
      color: var(--muted);
      font-size: .88rem;
    }
    .status-chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: .76rem;
      text-transform: uppercase;
      letter-spacing: .04em;
      padding: .14rem .48rem;
      font-weight: 700;
      background: #f2f5f2;
      color: #2e4135;
    }
    .status-chip[data-status='approved'] {
      border-color: #b6d0be;
      background: #eff8f1;
      color: #2d5e43;
    }
    .status-chip[data-status='rejected'] {
      border-color: #d6a09b;
      background: #fff2f1;
      color: var(--warn);
    }
    .status-chip[data-status='cancelled'] {
      border-color: #cdd5d1;
      background: #f3f5f4;
      color: #556660;
    }
    .status-chip[data-status='pending'] {
      border-color: #d7c896;
      background: #fff7e3;
      color: #6f5420;
    }
    .item-actions {
      margin-top: .38rem;
      display: flex;
      gap: .45rem;
      flex-wrap: wrap;
    }
    .item-actions button {
      padding: .4rem .68rem;
      font-size: .82rem;
    }
    @media (max-width: 760px) {
      .dayoff-form {
        grid-template-columns: 1fr;
      }
      .dayoff-form .span-2 {
        grid-column: auto;
      }
    }
    .meta {
      margin: .45rem 0 .9rem;
      color: var(--muted);
      font-size: .9rem;
      display: flex;
      flex-wrap: wrap;
      gap: .65rem;
    }
    .schedule-table {
      width: 100%;
      border-collapse: collapse;
      font-size: .9rem;
    }
    .schedule-table th, .schedule-table td {
      border: 1px solid var(--border);
      padding: .48rem .55rem;
      vertical-align: top;
      text-align: left;
    }
    .schedule-table th {
      background: #edf2ed;
      color: #2b3f32;
      font-size: .8rem;
      letter-spacing: .02em;
      text-transform: uppercase;
    }
    .pill-wrap {
      display: flex;
      flex-wrap: wrap;
      gap: .35rem;
    }
    .pill {
      background: #eff4ef;
      border: 1px solid #ccd8d0;
      border-radius: 999px;
      padding: .14rem .52rem;
      font-size: .81rem;
      white-space: nowrap;
    }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <img src="/static/brand/logo-full.svg" alt="Friends of Bon Echo Park logo">
        <div>
          <h1>FOBE Schedule Viewer</h1>
          <p>Most recent saved schedules</p>
        </div>
      </div>
      <div class="header-actions">
        <p id="session_user" class="session"></p>
        <button id="logout_btn" type="button">Logout</button>
      </div>
    </header>

    <p id="feedback" class="feedback hidden"></p>
    <section class="card">
      <div class="card-head">
        <h2>Request Days Off</h2>
        <p>Requests must begin at least 14 days from today.</p>
      </div>
      <form id="dayoff_form" class="dayoff-form">
        <label>Start Date <input id="dayoff_start" type="date" required></label>
        <label>End Date <input id="dayoff_end" type="date" required></label>
        <label class="span-2">Reason (optional) <textarea id="dayoff_reason" placeholder="Vacation, appointment, etc."></textarea></label>
        <button id="dayoff_submit" type="submit">Submit Request</button>
      </form>
      <p id="dayoff_link_warning" class="dayoff-feedback hidden"></p>
      <p id="dayoff_feedback" class="dayoff-feedback hidden"></p>
      <div id="dayoff_list" class="dayoff-list"><p class="muted">No requests yet.</p></div>
    </section>
    <main id="schedules" class="schedule-grid"></main>
  </div>

  <script>
    let currentUser=null;

    function esc(value) {
      return String(value).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
    }
    function canonicalUserRole(role='') {
      return role === 'user' ? 'view_only' : role;
    }
    function fmtDateWithDay(s) {
      return new Date(s + 'T00:00:00').toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'short', day:'numeric' });
    }
    function fmtDateTime(s) {
      return new Date(s).toLocaleString();
    }
    function setFeedback(msg, tone='neutral') {
      const el=document.getElementById('feedback');
      if(!msg) {
        el.textContent='';
        el.classList.add('hidden');
        el.removeAttribute('data-tone');
        return;
      }
      el.textContent=msg;
      el.dataset.tone=tone;
      el.classList.remove('hidden');
    }
    async function apiFetch(path, options={}) {
      const res=await fetch(path, { credentials:'include', cache:'no-store', ...options });
      let data=null;
      const text=await res.text();
      if(text) {
        try { data=JSON.parse(text); } catch { data={detail:text}; }
      }
      if(!res.ok) {
        const detail=typeof data?.detail==='string' ? data.detail : `${res.status} ${res.statusText}`;
        const err=new Error(detail);
        err.status=res.status;
        throw err;
      }
      return data;
    }
    function isoDate(d) {
      const year=d.getFullYear();
      const month=String(d.getMonth()+1).padStart(2, '0');
      const day=String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    function minDayOffDate() {
      const d=new Date();
      d.setHours(0,0,0,0);
      d.setDate(d.getDate()+14);
      return isoDate(d);
    }
    function setDayOffFeedback(msg='', tone='neutral') {
      const el=document.getElementById('dayoff_feedback');
      if(!msg) {
        el.textContent='';
        el.classList.add('hidden');
        el.removeAttribute('data-tone');
        return;
      }
      el.textContent=msg;
      el.dataset.tone=tone;
      el.classList.remove('hidden');
    }
    function setDayOffLinkWarning(msg='') {
      const el=document.getElementById('dayoff_link_warning');
      if(!msg) {
        el.textContent='';
        el.classList.add('hidden');
        el.removeAttribute('data-tone');
        return;
      }
      el.textContent=msg;
      el.dataset.tone='danger';
      el.classList.remove('hidden');
    }
    function viewerCanRequestDaysOff() {
      return !!currentUser?.linked_employee_id;
    }
    function applyDayOffPermissions() {
      const canRequest=viewerCanRequestDaysOff();
      const form=document.getElementById('dayoff_form');
      const submit=document.getElementById('dayoff_submit');
      form.querySelectorAll('input, textarea').forEach(el=>{ el.disabled=!canRequest; });
      submit.disabled=!canRequest;
      if(!canRequest) {
        setDayOffLinkWarning('This account is not linked to a roster employee. Contact an administrator to link your account before requesting days off.');
      } else {
        setDayOffLinkWarning('');
      }
    }
    function dayOffStatusLabel(status='pending') {
      return status.replaceAll('_', ' ');
    }
    function renderDayOffRequests(items=[]) {
      const wrap=document.getElementById('dayoff_list');
      if(!Array.isArray(items) || !items.length) {
        wrap.innerHTML="<p class='muted'>No day-off requests yet.</p>";
        return;
      }
      const requestCardHtml=(item)=>{
        const reason=item.reason ? `<p><strong>Requested reason:</strong> ${esc(item.reason)}</p>` : '';
        const decisionReason=item.status==='rejected' && item.decision_reason
          ? `<p><strong>Rejected reason:</strong> ${esc(item.decision_reason)}</p>`
          : '';
        const cancelledReason=item.status==='cancelled' && item.cancelled_reason
          ? `<p><strong>Cancellation reason:</strong> ${esc(item.cancelled_reason)}</p>`
          : '';
        const lockNote=item.locked_by_schedule ? "<p><strong>Locked:</strong> A schedule already exists for part of this range.</p>" : '';
        const canCancel=item.status==='pending' || (item.status==='approved' && !item.locked_by_schedule);
        const actionBtn=canCancel ? `<div class='item-actions'><button type='button' onclick='cancelMyDayOffRequest(${item.id})'>Cancel Request</button></div>` : '';
        return `<article class='dayoff-item'><div class='dayoff-item-top'><strong>${esc(fmtDateWithDay(item.start_date))} to ${esc(fmtDateWithDay(item.end_date))}</strong><span class='status-chip' data-status='${esc(item.status)}'>${esc(dayOffStatusLabel(item.status))}</span></div>${reason}${decisionReason}${cancelledReason}${lockNote}${actionBtn}</article>`;
      };
      const currentItems=items.filter(item=>!item.locked_by_schedule);
      const previousItems=items.filter(item=>item.locked_by_schedule);
      const parts=[
        currentItems.length
          ? currentItems.map(requestCardHtml).join('')
          : "<p class='muted'>No current day-off requests.</p>",
      ];
      if(previousItems.length) {
        parts.push(`<details class='dayoff-history-toggle'><summary>Previous day-off requests (${previousItems.length})</summary><div class='dayoff-history-body'>${previousItems.map(requestCardHtml).join('')}</div></details>`);
      }
      wrap.innerHTML=parts.join('');
    }
    async function loadMyDayOffRequests() {
      if(!viewerCanRequestDaysOff()) {
        renderDayOffRequests([]);
        setDayOffFeedback('');
        return;
      }
      try {
        const items=await apiFetch('/api/day-off-requests/me');
        renderDayOffRequests(Array.isArray(items) ? items : []);
        setDayOffFeedback('');
      } catch (err) {
        renderDayOffRequests([]);
        if(err.status===404) {
          setDayOffFeedback('Day-off request service is unavailable. Restart the app server and try again.', 'danger');
          return;
        }
        setDayOffFeedback(err.message || 'Failed to load day-off requests.', 'danger');
      }
    }
    async function submitDayOffRequest(ev) {
      ev.preventDefault();
      if(!viewerCanRequestDaysOff()) {
        setDayOffFeedback('This account is not linked to a roster employee.', 'danger');
        return;
      }
      const start=document.getElementById('dayoff_start').value;
      const end=document.getElementById('dayoff_end').value;
      const reason=document.getElementById('dayoff_reason').value.trim();
      if(!start || !end) {
        setDayOffFeedback('Start and end dates are required.', 'danger');
        return;
      }
      if(end < start) {
        setDayOffFeedback('End date must be on or after start date.', 'danger');
        return;
      }
      try {
        await apiFetch('/api/day-off-requests/me', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({start_date:start, end_date:end, reason}),
        });
        document.getElementById('dayoff_reason').value='';
        setFeedback('Day-off request submitted and sent for admin approval.', 'success');
        setDayOffFeedback('Day-off request submitted.', 'success');
        await loadMyDayOffRequests();
      } catch (err) {
        if(err.status===404) {
          setDayOffFeedback('Day-off request service is unavailable. Restart the app server and try again.', 'danger');
          return;
        }
        setDayOffFeedback(err.message || 'Failed to submit day-off request.', 'danger');
      }
    }
    async function cancelMyDayOffRequest(requestId) {
      if(!viewerCanRequestDaysOff()) return;
      const confirmed=window.confirm('Cancel this day-off request?');
      if(!confirmed) return;
      try {
        await apiFetch(`/api/day-off-requests/me/${requestId}/cancel`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({reason:''}),
        });
        setDayOffFeedback('Day-off request cancelled.', 'success');
        await loadMyDayOffRequests();
      } catch (err) {
        if(err.status===404) {
          setDayOffFeedback('Day-off request service is unavailable. Restart the app server and try again.', 'danger');
          return;
        }
        setDayOffFeedback(err.message || 'Failed to cancel day-off request.', 'danger');
      }
    }
    function applyDayOffDateMinimums() {
      const min=minDayOffDate();
      const start=document.getElementById('dayoff_start');
      const end=document.getElementById('dayoff_end');
      start.min=min;
      end.min=min;
      if(!start.value) start.value=min;
      if(!end.value) end.value=min;
      start.addEventListener('change', ()=>{
        if(end.value < start.value) end.value=start.value;
      });
    }
    async function ensureViewOnlyUser() {
      try {
        currentUser=await apiFetch('/auth/me');
        currentUser.role=canonicalUserRole(currentUser.role);
      } catch {
        window.location.replace('/');
        return false;
      }
      if(currentUser.role !== 'view_only') {
        window.location.replace('/');
        return false;
      }
      if(currentUser.must_change_password) {
        window.location.replace('/');
        return false;
      }
      document.getElementById('session_user').textContent=`Signed in as ${currentUser.email}`;
      applyDayOffPermissions();
      return true;
    }
    async function handleLogout() {
      try {
        await apiFetch('/auth/logout', { method:'POST' });
      } catch {
        // Ignore logout API errors; we still redirect to sign-in.
      }
      window.location.replace('/');
    }
    function groupSlots(assignments=[]) {
      const byDate={};
      assignments.forEach(a=>{
        byDate[a.date] ||= { manager:[], leaders:[], clerks:[], captains:[], beachStaff:[] };
        if(a.role==='Store Manager') byDate[a.date].manager.push(a.employee_name);
        if(a.role==='Team Leader' && a.location==='Greystones') byDate[a.date].leaders.push(a.employee_name);
        if(a.role==='Store Clerk' && a.location==='Greystones') byDate[a.date].clerks.push(a.employee_name);
        if(a.role==='Boat Captain') byDate[a.date].captains.push(a.employee_name);
        if((a.role==='Team Leader' || a.role==='Store Clerk') && a.location==='Beach Shop') byDate[a.date].beachStaff.push(a.employee_name);
      });
      return byDate;
    }
    function renderPills(names=[]) {
      if(!names.length) return "<span class='muted'>—</span>";
      return `<div class='pill-wrap'>${names.map(name=>`<span class='pill'>${esc(name)}</span>`).join('')}</div>`;
    }
    function renderSchedule(assignments=[]) {
      const byDate=groupSlots(assignments);
      const dates=Object.keys(byDate).sort();
      if(!dates.length) return "<p class='muted'>No assignments in this saved schedule.</p>";
      const showBeach = assignments.some(a=>a.location==='Beach Shop');
      const beachHeader = showBeach ? '<th>Beach Shop</th>' : '';
      return `<table class='schedule-table'><thead><tr><th>Date</th><th>Manager</th><th>Team Leaders</th><th>Clerks</th><th>Captain</th>${beachHeader}</tr></thead><tbody>${dates.map(d=>{
        const day=byDate[d];
        const beachCell = showBeach ? `<td>${renderPills(day.beachStaff)}</td>` : '';
        return `<tr><td><strong>${esc(fmtDateWithDay(d))}</strong></td><td>${renderPills(day.manager)}</td><td>${renderPills(day.leaders)}</td><td>${renderPills(day.clerks)}</td><td>${renderPills(day.captains)}</td>${beachCell}</tr>`;
      }).join('')}</tbody></table>`;
    }
    function renderSchedules(items=[]) {
      const wrap=document.getElementById('schedules');
      if(!items.length) {
        wrap.innerHTML="<section class='card'><h2>No saved schedules yet</h2><p class='muted'>A manager or administrator must finalize a schedule before it appears here.</p></section>";
        setFeedback('No saved schedules are available yet.');
        return;
      }
      const labels=['Most Recent Saved Schedule', 'Previously Saved Schedule'];
      wrap.innerHTML = items.map((item, idx)=>{
        const title=(item.label || `Schedule ${item.period_start}`).trim();
        const slot=labels[idx] || `Saved Schedule ${idx + 1}`;
        return `<section class='card'><h2>${esc(slot)}</h2><p class='meta'><span><strong>${esc(title)}</strong></span><span>${esc(fmtDateWithDay(item.period_start))}</span><span>${item.weeks} week(s)</span><span>saved ${esc(fmtDateTime(item.created_at))}</span><span>by ${esc(item.created_by_email)}</span></p>${renderSchedule(item.assignments || [])}</section>`;
      }).join('');
      setFeedback('');
    }
    async function loadSchedules() {
      const items=await apiFetch('/api/view-only/schedules');
      renderSchedules(Array.isArray(items) ? items : []);
    }

    document.getElementById('logout_btn').addEventListener('click', handleLogout);
    document.getElementById('dayoff_form').addEventListener('submit', submitDayOffRequest);
    applyDayOffDateMinimums();
    (async function init() {
      const ok=await ensureViewOnlyUser();
      if(!ok) return;
      setFeedback('Loading schedules…');
      try {
        await loadSchedules();
        await loadMyDayOffRequests();
      } catch (err) {
        setFeedback(err.message || 'Failed to load saved schedules.', 'danger');
      }
    })();
  </script>
</body>
</html>
